<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Atesto - UNIAE/CRE-PP</title>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400" rel="stylesheet">
  <style>
    :root {
      --primary: #4f46e5;
      --primary-light: #818cf8;
      --primary-dark: #3730a3;
      --success: #10b981;
      --success-light: #d1fae5;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --danger: #ef4444;
      --danger-light: #fee2e2;
      --info: #3b82f6;
      --info-light: #dbeafe;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-900: #111827;
      --radius: 12px;
      --radius-lg: 16px;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.5;
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-md);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-title h1 {
      font-size: 18px;
      font-weight: 600;
    }

    .header-title p {
      font-size: 12px;
      opacity: 0.9;
    }

    .user-badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.2s;
      cursor: pointer;
      border: 2px solid transparent;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .stat-card.active {
      border-color: var(--primary);
    }

    .stat-icon {
      width: 52px;
      height: 52px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stat-icon .material-symbols-outlined {
      font-size: 26px;
    }

    .stat-icon.blue {
      background: var(--info-light);
      color: var(--info);
    }

    .stat-icon.green {
      background: var(--success-light);
      color: var(--success);
    }

    .stat-icon.yellow {
      background: var(--warning-light);
      color: var(--warning);
    }

    .stat-icon.red {
      background: var(--danger-light);
      color: var(--danger);
    }

    .stat-info h3 {
      font-size: 26px;
      font-weight: 700;
    }

    .stat-info p {
      font-size: 12px;
      color: var(--gray-500);
    }

    /* Workflow Visual */
    .workflow-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--gray-700);
    }

    .workflow-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
      padding: 0 20px;
    }

    .workflow-steps::before {
      content: '';
      position: absolute;
      top: 28px;
      left: 80px;
      right: 80px;
      height: 3px;
      background: var(--gray-200);
      z-index: 0;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
      flex: 1;
      max-width: 160px;
      cursor: pointer;
    }

    .step-circle {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      transition: all 0.3s;
      border: 3px solid white;
      box-shadow: var(--shadow);
    }

    .step-circle .material-symbols-outlined {
      font-size: 24px;
      color: var(--gray-500);
    }

    .step.completed .step-circle {
      background: var(--success);
    }

    .step.completed .step-circle .material-symbols-outlined {
      color: white;
    }

    .step.active .step-circle {
      background: var(--primary);
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
    }

    .step.active .step-circle .material-symbols-outlined {
      color: white;
    }

    .step-label {
      font-size: 12px;
      text-align: center;
      color: var(--gray-500);
      font-weight: 500;
    }

    .step.active .step-label {
      color: var(--primary);
      font-weight: 600;
    }

    .step.completed .step-label {
      color: var(--success);
    }

    .step-count {
      font-size: 10px;
      background: var(--gray-100);
      padding: 2px 8px;
      border-radius: 10px;
      margin-top: 4px;
    }

    .step.active .step-count {
      background: var(--primary-light);
      color: white;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 18px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-outline {
      background: white;
      border: 1px solid var(--gray-300);
      color: var(--gray-700);
    }

    .btn-outline:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-icon {
      padding: 8px;
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* Table */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 14px 16px;
      text-align: left;
    }

    th {
      background: var(--gray-50);
      font-weight: 600;
      font-size: 12px;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--gray-200);
    }

    td {
      font-size: 14px;
      border-bottom: 1px solid var(--gray-100);
    }

    tr:hover td {
      background: var(--gray-50);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-success {
      background: var(--success-light);
      color: #065f46;
    }

    .badge-warning {
      background: var(--warning-light);
      color: #92400e;
    }

    .badge-danger {
      background: var(--danger-light);
      color: #991b1b;
    }

    .badge-info {
      background: var(--info-light);
      color: #1e40af;
    }

    .badge-gray {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    /* Prazo Indicator */
    .prazo-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .prazo-indicator.ok {
      color: var(--success);
    }

    .prazo-indicator.atencao {
      color: var(--warning);
    }

    .prazo-indicator.vencido {
      color: var(--danger);
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(-20px);
      }

      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      max-height: calc(90vh - 140px);
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      background: var(--gray-50);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray-500);
      padding: 4px;
      border-radius: 6px;
    }

    .close-btn:hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    /* Form */
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--gray-700);
    }

    .form-group label .required {
      color: var(--danger);
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .form-control.error {
      border-color: var(--danger);
    }

    .form-hint {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 4px;
    }

    .form-error {
      font-size: 12px;
      color: var(--danger);
      margin-top: 4px;
    }

    select.form-control {
      cursor: pointer;
      background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 12px center;
      appearance: none;
      padding-right: 36px;
    }

    /* Alert */
    .alert {
      padding: 14px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      font-size: 14px;
    }

    .alert-info {
      background: var(--info-light);
      color: #1e40af;
      border: 1px solid #93c5fd;
    }

    .alert-success {
      background: var(--success-light);
      color: #065f46;
      border: 1px solid #6ee7b7;
    }

    .alert-warning {
      background: var(--warning-light);
      color: #92400e;
      border: 1px solid #fcd34d;
    }

    .alert-danger {
      background: var(--danger-light);
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .alert .material-symbols-outlined {
      font-size: 20px;
      flex-shrink: 0;
    }

    /* Checklist */
    .checklist {
      background: var(--gray-50);
      border-radius: 8px;
      padding: 16px;
    }

    .checklist-title {
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .checklist-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--gray-200);
    }

    .checklist-item:last-child {
      border-bottom: none;
    }

    .checklist-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .checklist-item label {
      font-size: 13px;
      cursor: pointer;
      flex: 1;
    }

    .checklist-item.checked label {
      color: var(--gray-500);
      text-decoration: line-through;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      border-bottom: 2px solid var(--gray-200);
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 20px;
      background: none;
      border: none;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-500);
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }

    .tab:hover {
      color: var(--gray-700);
    }

    .tab.active {
      color: var(--primary);
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Toast */
    #toast-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      background: white;
      border-radius: 10px;
      padding: 14px 18px;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      max-width: 400px;
      animation: toastIn 0.3s ease;
      border-left: 4px solid;
    }

    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateX(100px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .toast.success {
      border-left-color: var(--success);
    }

    .toast.error {
      border-left-color: var(--danger);
    }

    .toast.warning {
      border-left-color: var(--warning);
    }

    .toast.info {
      border-left-color: var(--info);
    }

    .toast-icon {
      font-size: 22px;
    }

    .toast.success .toast-icon {
      color: var(--success);
    }

    .toast.error .toast-icon {
      color: var(--danger);
    }

    .toast.warning .toast-icon {
      color: var(--warning);
    }

    .toast.info .toast-icon {
      color: var(--info);
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 14px;
    }

    .toast-message {
      font-size: 13px;
      color: var(--gray-500);
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--gray-400);
      cursor: pointer;
      padding: 4px;
    }

    /* Loading */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      margin-top: 12px;
      color: var(--gray-500);
      font-size: 14px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-state-icon {
      font-size: 64px;
      color: var(--gray-300);
      margin-bottom: 16px;
    }

    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    .empty-state-text {
      font-size: 14px;
      color: var(--gray-500);
      margin-bottom: 20px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .workflow-steps {
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
      }

      .workflow-steps::before {
        display: none;
      }

      .step {
        max-width: 100px;
      }

      .header-title h1 {
        font-size: 16px;
      }

      .modal {
        max-width: 100%;
        margin: 10px;
      }
    }
  </style>
</head>

<body>
  <div id="toast-container"></div>

  <header class="header">
    <div class="header-content">
      <div class="header-title">
        <span class="material-symbols-outlined" style="font-size:32px;">fact_check</span>
        <div>
          <h1>Sistema de Atesto de G√™neros Aliment√≠cios</h1>
          <p>UNIAE/CRE-PP ‚Ä¢ Programa de Alimenta√ß√£o Escolar</p>
        </div>
      </div>
      <div class="user-badge">
        <span class="material-symbols-outlined">person</span>
        <span id="user-name">Analista</span>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Stats -->
    <section class="stats-grid">
      <div class="stat-card" onclick="filtrarProcessos('todos')" id="card-total">
        <div class="stat-icon blue"><span class="material-symbols-outlined">receipt_long</span></div>
        <div class="stat-info">
          <h3 id="stat-total">0</h3>
          <p>Total de Processos</p>
        </div>
      </div>
      <div class="stat-card" onclick="filtrarProcessos('pendente')" id="card-pendentes">
        <div class="stat-icon yellow"><span class="material-symbols-outlined">pending_actions</span></div>
        <div class="stat-info">
          <h3 id="stat-pendentes">0</h3>
          <p>Aguardando An√°lise</p>
        </div>
      </div>
      <div class="stat-card" onclick="filtrarProcessos('atestado')" id="card-atestados">
        <div class="stat-icon green"><span class="material-symbols-outlined">verified</span></div>
        <div class="stat-info">
          <h3 id="stat-atestados">0</h3>
          <p>Atestados (M√™s)</p>
        </div>
      </div>
      <div class="stat-card" onclick="filtrarProcessos('alerta')" id="card-alertas">
        <div class="stat-icon red"><span class="material-symbols-outlined">warning</span></div>
        <div class="stat-info">
          <h3 id="stat-alertas">0</h3>
          <p>Prazo Cr√≠tico</p>
        </div>
      </div>
    </section>

    <!-- Workflow Visual -->
    <section class="workflow-card">
      <div class="section-header">
        <div class="section-title">
          <span class="material-symbols-outlined">timeline</span>
          Fluxo Processual do Atesto (Lei 4.320/64, Arts. 62-63)
        </div>
      </div>
      <div class="workflow-steps">
        <div class="step" onclick="mostrarEtapa(1)" id="step-1">
          <div class="step-circle"><span class="material-symbols-outlined">local_shipping</span></div>
          <div class="step-label">Recebimento<br>na UE</div>
          <div class="step-count" id="count-etapa1">0</div>
        </div>
        <div class="step" onclick="mostrarEtapa(2)" id="step-2">
          <div class="step-circle"><span class="material-symbols-outlined">folder_open</span></div>
          <div class="step-label">Consolida√ß√£o<br>Documental</div>
          <div class="step-count" id="count-etapa2">0</div>
        </div>
        <div class="step" onclick="mostrarEtapa(3)" id="step-3">
          <div class="step-circle"><span class="material-symbols-outlined">groups</span></div>
          <div class="step-label">An√°lise<br>Comiss√£o</div>
          <div class="step-count" id="count-etapa3">0</div>
        </div>
        <div class="step" onclick="mostrarEtapa(4)" id="step-4">
          <div class="step-circle"><span class="material-symbols-outlined">task_alt</span></div>
          <div class="step-label">Atesto<br>Executor</div>
          <div class="step-count" id="count-etapa4">0</div>
        </div>
      </div>
    </section>

    <!-- A√ß√µes R√°pidas -->
    <section class="workflow-card">
      <div class="section-header">
        <div class="section-title"><span class="material-symbols-outlined">bolt</span>A√ß√µes R√°pidas</div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" onclick="abrirModal('modal-novo')">
          <span class="material-symbols-outlined">add_circle</span> Novo Processo
        </button>
        <button class="btn btn-success" onclick="abrirModal('modal-recebimento')">
          <span class="material-symbols-outlined">inventory_2</span> Registrar Recebimento
        </button>
        <button class="btn btn-warning" onclick="abrirModal('modal-analise')">
          <span class="material-symbols-outlined">checklist</span> An√°lise Comiss√£o
        </button>
        <button class="btn btn-outline" onclick="abrirModal('modal-checklist')">
          <span class="material-symbols-outlined">fact_check</span> Checklist Qualidade
        </button>
        <button class="btn btn-outline" onclick="gerarRelatorioSEI()">
          <span class="material-symbols-outlined">description</span> Gerar Despacho SEI
        </button>
      </div>
    </section>

    <!-- Lista de Processos -->
    <section class="workflow-card">
      <div class="section-header">
        <div class="section-title"><span class="material-symbols-outlined">list_alt</span>Processos <span
            id="filtro-ativo" style="font-weight:400;color:var(--gray-500);font-size:13px;"></span></div>
        <div class="actions">
          <input type="text" class="form-control" placeholder="Buscar NF, fornecedor..." style="width:220px;margin:0;"
            id="busca-processo" oninput="buscarProcessos()">
        </div>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Nota Fiscal</th>
              <th>Fornecedor</th>
              <th>Valor</th>
              <th>Etapa</th>
              <th>Prazo</th>
              <th>Status</th>
              <th style="width:120px;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tabela-processos">
            <tr>
              <td colspan="7">
                <div class="loading">
                  <div class="spinner"></div>
                  <div class="loading-text">Carregando processos...</div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>


  <!-- Modal: Novo Processo -->
  <div class="modal-overlay" id="modal-novo">
    <div class="modal">
      <div class="modal-header">
        <h2><span class="material-symbols-outlined">add_circle</span>Novo Processo de Atesto</h2>
        <button class="close-btn" onclick="fecharModal('modal-novo')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <span class="material-symbols-outlined">info</span>
          <div>Cadastre a Nota Fiscal recebida do fornecedor. O prazo de 5 dias √∫teis para an√°lise inicia ap√≥s o
            recebimento da documenta√ß√£o.</div>
        </div>
        <form id="form-novo">
          <div class="form-row">
            <div class="form-group">
              <label>N√∫mero da NF <span class="required">*</span></label>
              <input type="text" class="form-control" name="notaFiscal" required placeholder="Ex: 123456">
            </div>
            <div class="form-group">
              <label>Data de Emiss√£o <span class="required">*</span></label>
              <input type="date" class="form-control" name="dataEmissaoNF" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Fornecedor <span class="required">*</span></label>
              <input type="text" class="form-control" name="fornecedor" required placeholder="Raz√£o Social">
            </div>
            <div class="form-group">
              <label>CNPJ</label>
              <input type="text" class="form-control" name="cnpjFornecedor" placeholder="00.000.000/0000-00">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Valor Total (R$) <span class="required">*</span></label>
              <input type="number" class="form-control" name="valorTotal" step="0.01" required placeholder="0,00">
            </div>
            <div class="form-group">
              <label>Tipo de G√™nero <span class="required">*</span></label>
              <select class="form-control" name="tipoGenero" required>
                <option value="">Selecione...</option>
                <option value="PERECIVEL">Perec√≠vel</option>
                <option value="NAO_PERECIVEL">N√£o Perec√≠vel</option>
                <option value="KIT">Kit Alimenta√ß√£o</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Contrato</label>
              <input type="text" class="form-control" name="contrato" placeholder="N¬∫ do contrato">
            </div>
            <div class="form-group">
              <label>Nota de Empenho</label>
              <input type="text" class="form-control" name="notaEmpenho" placeholder="2024NE00123">
            </div>
          </div>
          <div class="form-group">
            <label>Chave de Acesso NF-e (44 d√≠gitos)</label>
            <input type="text" class="form-control" name="chaveAcessoNFe" maxlength="44"
              placeholder="Opcional - para consulta SEFAZ">
            <div class="form-hint">Permite valida√ß√£o autom√°tica da NF junto √† SEFAZ</div>
          </div>
          <div class="form-group">
            <label>Observa√ß√µes</label>
            <textarea class="form-control" name="observacoes" rows="2" placeholder="Informa√ß√µes adicionais"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="fecharModal('modal-novo')">Cancelar</button>
        <button class="btn btn-primary" onclick="salvarNovoProcesso()">
          <span class="material-symbols-outlined">save</span> Criar Processo
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Registrar Recebimento na UE -->
  <div class="modal-overlay" id="modal-recebimento">
    <div class="modal">
      <div class="modal-header">
        <h2><span class="material-symbols-outlined">inventory_2</span>Registrar Recebimento na UE</h2>
        <button class="close-btn" onclick="fecharModal('modal-recebimento')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <span class="material-symbols-outlined">gavel</span>
          <div><strong>Aten√ß√£o:</strong> O atesto s√≥ deve ser realizado AP√ìS confer√™ncia f√≠sica completa. √â proibido
            assinar Termo em branco (Se√ß√£o 2.2 do Manual).</div>
        </div>
        <form id="form-recebimento">
          <div class="form-group">
            <label>Processo <span class="required">*</span></label>
            <select class="form-control" name="idProcesso" required id="select-processo-receb">
              <option value="">Selecione o processo...</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Unidade Escolar <span class="required">*</span></label>
              <input type="text" class="form-control" name="unidadeEscolar" required placeholder="Nome da escola">
            </div>
            <div class="form-group">
              <label>Data da Entrega <span class="required">*</span></label>
              <input type="date" class="form-control" name="dataEntrega" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Hora da Entrega</label>
              <input type="time" class="form-control" name="horaEntrega">
              <div class="form-hint">Hor√°rio contratual: 8h-12h e 14h-18h</div>
            </div>
            <div class="form-group">
              <label>Temperatura Aferida (¬∞C)</label>
              <input type="number" class="form-control" name="temperaturaAferida" step="0.1"
                placeholder="Para refrigerados/congelados">
              <div class="form-hint">Congelados: ‚â§-12¬∞C | Resfriados: ‚â§+7¬∞C</div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Respons√°vel pelo Recebimento <span class="required">*</span></label>
              <input type="text" class="form-control" name="responsavel" required placeholder="Nome completo">
            </div>
            <div class="form-group">
              <label>Matr√≠cula <span class="required">*</span></label>
              <input type="text" class="form-control" name="matriculaResponsavel" required
                placeholder="Matr√≠cula funcional">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Confer√™ncia Quantitativa</label>
              <select class="form-control" name="quantitativaOk">
                <option value="true">‚úì Conforme</option>
                <option value="false">‚úó Divergente</option>
              </select>
            </div>
            <div class="form-group">
              <label>Confer√™ncia Qualitativa</label>
              <select class="form-control" name="qualitativaOk">
                <option value="true">‚úì Conforme</option>
                <option value="false">‚úó Problemas identificados</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Termo Assinado?</label>
              <select class="form-control" name="assinatura">
                <option value="true">Sim</option>
                <option value="false">N√£o</option>
              </select>
            </div>
            <div class="form-group">
              <label>Identifica√ß√£o Digital da UE?</label>
              <select class="form-control" name="carimboUE">
                <option value="true">Sim</option>
                <option value="false">N√£o</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Observa√ß√µes / Recusas</label>
            <textarea class="form-control" name="observacoes" rows="3"
              placeholder="Registrar produtos recusados, motivos e quantidades (obrigat√≥rio em caso de recusa)"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="fecharModal('modal-recebimento')">Cancelar</button>
        <button class="btn btn-success" onclick="salvarRecebimento()">
          <span class="material-symbols-outlined">check</span> Registrar Recebimento
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: An√°lise da Comiss√£o -->
  <div class="modal-overlay" id="modal-analise">
    <div class="modal">
      <div class="modal-header">
        <h2><span class="material-symbols-outlined">groups</span>An√°lise da Comiss√£o de Recebimento</h2>
        <button class="close-btn" onclick="fecharModal('modal-analise')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <span class="material-symbols-outlined">gavel</span>
          <div><strong>Base Legal:</strong> Resolu√ß√£o CD/FNDE n¬∫ 06/2020 - M√≠nimo 3 membros. Prazo: 5 dias √∫teis (Se√ß√£o
            2.3 do Manual).</div>
        </div>
        <form id="form-analise">
          <div class="form-group">
            <label>Processo <span class="required">*</span></label>
            <select class="form-control" name="idProcesso" required id="select-processo-analise">
              <option value="">Selecione o processo...</option>
            </select>
          </div>

          <div class="checklist">
            <div class="checklist-title">Verifica√ß√µes Obrigat√≥rias</div>
            <div class="checklist-item">
              <input type="checkbox" id="check-soma" name="somaVerificada">
              <label for="check-soma">Soma dos quantitativos dos Termos = Quantidade da NF</label>
            </div>
            <div class="checklist-item">
              <input type="checkbox" id="check-atesto" name="atestoVerificado">
              <label for="check-atesto">Todos os Termos possuem: assinatura digital, matr√≠cula, data e identifica√ß√£o
                UE</label>
            </div>
            <div class="checklist-item">
              <input type="checkbox" id="check-nf" name="nfConferida">
              <label for="check-nf">Dados da NF conferem com o contrato (CNPJ, pre√ßos, descri√ß√£o)</label>
            </div>
            <div class="checklist-item">
              <input type="checkbox" id="check-sefaz" name="sefazConsultada">
              <label for="check-sefaz">NF-e consultada na SEFAZ (status: Autorizada)</label>
            </div>
            <div class="checklist-item">
              <input type="checkbox" id="check-obs" name="observacoesAnalisadas">
              <label for="check-obs">Campo "Observa√ß√µes" dos Termos analisado (recusas/ocorr√™ncias)</label>
            </div>
          </div>

          <div class="form-group" style="margin-top:16px;">
            <label>Membros Presentes (m√≠nimo 3) <span class="required">*</span></label>
            <textarea class="form-control" name="membrosPresentes" rows="3" required
              placeholder="Nome - Matr√≠cula (um por linha)&#10;Ex: Jo√£o Silva - 123456&#10;Maria Santos - 654321&#10;Pedro Souza - 789012"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Resultado da An√°lise <span class="required">*</span></label>
              <select class="form-control" name="resultado" required>
                <option value="">Selecione...</option>
                <option value="APROVADO">‚úì Aprovado - Apto para Atesto</option>
                <option value="PENDENTE">‚è≥ Pendente - Aguardando Corre√ß√µes</option>
                <option value="REJEITADO">‚úó Rejeitado - N√£o Conforme</option>
              </select>
            </div>
            <div class="form-group">
              <label>N¬∫ Despacho SEI</label>
              <input type="text" class="form-control" name="numeroDespacho" placeholder="Ex: 12345678">
            </div>
          </div>
          <div class="form-group">
            <label>Processo SEI</label>
            <input type="text" class="form-control" name="processoSEI" placeholder="00080-00012345/2024-00">
          </div>
          <div class="form-group">
            <label>Observa√ß√µes da An√°lise</label>
            <textarea class="form-control" name="observacoes" rows="2"
              placeholder="Pend√™ncias identificadas, justificativas..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="fecharModal('modal-analise')">Cancelar</button>
        <button class="btn btn-warning" onclick="salvarAnalise()">
          <span class="material-symbols-outlined">gavel</span> Registrar An√°lise
        </button>
      </div>
    </div>
  </div>


  <!-- Modal: Checklist de Qualidade -->
  <div class="modal-overlay" id="modal-checklist">
    <div class="modal">
      <div class="modal-header">
        <h2><span class="material-symbols-outlined">fact_check</span>Checklist de Qualidade no Recebimento</h2>
        <button class="close-btn" onclick="fecharModal('modal-checklist')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <span class="material-symbols-outlined">info</span>
          <div>Baseado na Tabela 1 do Manual - Se√ß√£o 3.1. Use este checklist antes de atestar qualquer Termo de
            Recebimento.</div>
        </div>
        <div class="checklist">
          <div class="checklist-title">1. Documenta√ß√£o</div>
          <div class="checklist-item"><input type="checkbox" id="q1"><label for="q1">Produtos listados correspondem aos
              entregues fisicamente</label></div>
          <div class="checklist-item"><input type="checkbox" id="q2"><label for="q2">Quantidade, unidade de medida e
              marca corretas</label></div>
        </div>
        <div class="checklist" style="margin-top:12px;">
          <div class="checklist-title">2. Transporte</div>
          <div class="checklist-item"><input type="checkbox" id="q3"><label for="q3">Ve√≠culo ba√∫ fechado, limpo e em bom
              estado</label></div>
          <div class="checklist-item"><input type="checkbox" id="q4"><label for="q4">Refrigera√ß√£o ativa (para produtos
              que exigem)</label></div>
          <div class="checklist-item"><input type="checkbox" id="q5"><label for="q5">Entregador com uniforme limpo e
              boas pr√°ticas de higiene</label></div>
        </div>
        <div class="checklist" style="margin-top:12px;">
          <div class="checklist-title">3. Embalagens</div>
          <div class="checklist-item"><input type="checkbox" id="q6"><label for="q6">Embalagens √≠ntegras, limpas, secas,
              sem viola√ß√£o</label></div>
          <div class="checklist-item"><input type="checkbox" id="q7"><label for="q7">Sem amassados, ferrugem (latas) ou
              estufamento</label></div>
        </div>
        <div class="checklist" style="margin-top:12px;">
          <div class="checklist-title">4. Rotulagem</div>
          <div class="checklist-item"><input type="checkbox" id="q8"><label for="q8">R√≥tulo leg√≠vel com validade, lote e
              fabricante</label></div>
          <div class="checklist-item"><input type="checkbox" id="q9"><label for="q9">Produto dentro do prazo de
              validade</label></div>
          <div class="checklist-item"><input type="checkbox" id="q10"><label for="q10">Inscri√ß√£o "PRODUTO INSTITUCIONAL
              - PROIBIDA A VENDA"</label></div>
        </div>
        <div class="checklist" style="margin-top:12px;">
          <div class="checklist-title">5. Caracter√≠sticas Sensoriais</div>
          <div class="checklist-item"><input type="checkbox" id="q11"><label for="q11">Apar√™ncia, cor, odor e textura
              pr√≥prios do produto</label></div>
          <div class="checklist-item"><input type="checkbox" id="q12"><label for="q12">Aus√™ncia de mofo, manchas ou
              deteriora√ß√£o</label></div>
          <div class="checklist-item"><input type="checkbox" id="q13"><label for="q13">Hortifr√∫ti frescos, √≠ntegros,
              matura√ß√£o adequada</label></div>
        </div>
        <div class="checklist" style="margin-top:12px;">
          <div class="checklist-title">6. Temperatura (CR√çTICO)</div>
          <div class="checklist-item"><input type="checkbox" id="q14"><label for="q14">Congelados: ‚â§ -12¬∞C</label></div>
          <div class="checklist-item"><input type="checkbox" id="q15"><label for="q15">Carnes resfriadas: ‚â§ +7¬∞C</label>
          </div>
          <div class="checklist-item"><input type="checkbox" id="q16"><label for="q16">Pescado resfriado: ‚â§ +3¬∞C</label>
          </div>
          <div class="checklist-item"><input type="checkbox" id="q17"><label for="q17">Outros refrigerados: ‚â§
              +10¬∞C</label></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="fecharModal('modal-checklist')">Fechar</button>
        <button class="btn btn-primary" onclick="imprimirChecklist()">
          <span class="material-symbols-outlined">print</span> Imprimir
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Detalhes do Processo -->
  <div class="modal-overlay" id="modal-detalhes">
    <div class="modal" style="max-width:800px;">
      <div class="modal-header">
        <h2><span class="material-symbols-outlined">info</span>Detalhes do Processo</h2>
        <button class="close-btn" onclick="fecharModal('modal-detalhes')">&times;</button>
      </div>
      <div class="modal-body" id="detalhes-content">
        <div class="loading">
          <div class="spinner"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="fecharModal('modal-detalhes')">Fechar</button>
      </div>
    </div>
  </div>


  <script>
    // ============================================================================
    // ESTADO DA APLICA√á√ÉO
    // ============================================================================
    let processos = [];
    let filtroAtual = 'todos';

    // ============================================================================
    // INICIALIZA√á√ÉO
    // ============================================================================
    document.addEventListener('DOMContentLoaded', function () {
      carregarDados();
      // Definir data atual nos campos de data
      const hoje = new Date().toISOString().split('T')[0];
      document.querySelectorAll('input[type="date"]').forEach(el => {
        if (!el.value) el.value = hoje;
      });
    });

    // ============================================================================
    // CARREGAR DADOS
    // ============================================================================
    function carregarDados() {
      if (typeof google !== 'undefined' && google.script) {
        google.script.run
          .withSuccessHandler(onDadosCarregados)
          .withFailureHandler(onErro)
          .listarProcessosAtesto({});
      } else {
        // Dados de demonstra√ß√£o para preview
        onDadosCarregados({
          success: true,
          data: gerarDadosDemo()
        });
      }
    }

    function onDadosCarregados(result) {
      if (result && result.success) {
        processos = result.data || [];
        atualizarEstatisticas();
        atualizarTabela();
        atualizarSelectsProcessos();
        atualizarWorkflow();
      } else {
        mostrarToast('error', 'Erro', result?.error || 'Falha ao carregar dados');
      }
    }

    function onErro(error) {
      console.error('Erro:', error);
      mostrarToast('error', 'Erro', error.message || 'Erro de comunica√ß√£o');
    }

    // ============================================================================
    // ESTAT√çSTICAS
    // ============================================================================
    function atualizarEstatisticas() {
      const total = processos.length;
      const pendentes = processos.filter(p => ['EM_ANALISE', 'AGUARDANDO_DOCS', 'PENDENCIA_DOCUMENTAL'].includes(p.status)).length;
      const atestados = processos.filter(p => ['ATESTO_COMISSAO', 'ATESTADO_EXECUTOR', 'LIQUIDADO', 'PAGO'].includes(p.status)).length;
      const alertas = processos.filter(p => calcularDiasRestantes(p) <= 1 && !['LIQUIDADO', 'PAGO'].includes(p.status)).length;

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-pendentes').textContent = pendentes;
      document.getElementById('stat-atestados').textContent = atestados;
      document.getElementById('stat-alertas').textContent = alertas;
    }

    function atualizarWorkflow() {
      const etapas = {
        1: processos.filter(p => p.etapaAtual === 'ETAPA_1_RECEBIMENTO_UE').length,
        2: processos.filter(p => p.etapaAtual === 'ETAPA_2_CONSOLIDACAO').length,
        3: processos.filter(p => p.etapaAtual === 'ETAPA_3_ANALISE_COMISSAO').length,
        4: processos.filter(p => ['ETAPA_4_ATESTO_EXECUTOR', 'LIQUIDADO', 'PAGO'].includes(p.etapaAtual)).length
      };

      for (let i = 1; i <= 4; i++) {
        document.getElementById(`count-etapa${i}`).textContent = etapas[i];
      }
    }


    // ============================================================================
    // TABELA DE PROCESSOS
    // ============================================================================
    function atualizarTabela() {
      const tbody = document.getElementById('tabela-processos');
      const busca = document.getElementById('busca-processo').value.toLowerCase();

      let lista = processos;

      // Aplicar filtro
      if (filtroAtual === 'pendente') {
        lista = lista.filter(p => ['EM_ANALISE', 'AGUARDANDO_DOCS', 'PENDENCIA_DOCUMENTAL'].includes(p.status));
      } else if (filtroAtual === 'atestado') {
        lista = lista.filter(p => ['ATESTO_COMISSAO', 'ATESTADO_EXECUTOR', 'LIQUIDADO', 'PAGO'].includes(p.status));
      } else if (filtroAtual === 'alerta') {
        lista = lista.filter(p => calcularDiasRestantes(p) <= 1 && !['LIQUIDADO', 'PAGO'].includes(p.status));
      }

      // Aplicar busca
      if (busca) {
        lista = lista.filter(p =>
          (p.notaFiscal || '').toLowerCase().includes(busca) ||
          (p.fornecedor || '').toLowerCase().includes(busca)
        );
      }

      if (lista.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="7">
            <div class="empty-state">
              <div class="empty-state-icon">üìã</div>
              <div class="empty-state-title">Nenhum processo encontrado</div>
              <div class="empty-state-text">Ajuste os filtros ou crie um novo processo</div>
            </div>
          </td></tr>`;
        return;
      }

      tbody.innerHTML = lista.slice(0, 50).map(p => {
        const diasRestantes = calcularDiasRestantes(p);
        const prazoClass = diasRestantes > 2 ? 'ok' : diasRestantes > 0 ? 'atencao' : 'vencido';
        const prazoIcon = diasRestantes > 2 ? 'schedule' : diasRestantes > 0 ? 'warning' : 'error';

        return `
          <tr>
            <td><strong>${p.notaFiscal || '-'}</strong></td>
            <td>${p.fornecedor || '-'}</td>
            <td>R$ ${Number(p.valorTotal || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
            <td>${formatarEtapa(p.etapaAtual)}</td>
            <td>
              <div class="prazo-indicator ${prazoClass}">
                <span class="material-symbols-outlined" style="font-size:16px;">${prazoIcon}</span>
                ${diasRestantes > 0 ? diasRestantes + ' dias' : diasRestantes === 0 ? 'Hoje' : 'Vencido'}
              </div>
            </td>
            <td><span class="badge ${getBadgeClass(p.status)}">${formatarStatus(p.status)}</span></td>
            <td>
              <div class="actions">
                <button class="btn btn-outline btn-sm btn-icon" onclick="verDetalhes('${p.id}')" title="Ver detalhes">
                  <span class="material-symbols-outlined">visibility</span>
                </button>
                <button class="btn btn-outline btn-sm btn-icon" onclick="avancarEtapa('${p.id}')" title="Avan√ßar etapa">
                  <span class="material-symbols-outlined">arrow_forward</span>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function getBadgeClass(status) {
      const map = {
        'RECEBIDO_CONFORME': 'badge-success', 'ATESTO_COMISSAO': 'badge-success',
        'ATESTADO_EXECUTOR': 'badge-success', 'LIQUIDADO': 'badge-success', 'PAGO': 'badge-success',
        'AGUARDANDO_ENTREGA': 'badge-info', 'AGUARDANDO_DOCS': 'badge-info', 'EM_ANALISE': 'badge-info',
        'PENDENCIA_DOCUMENTAL': 'badge-warning', 'RECEBIDO_PARCIAL': 'badge-warning',
        'RECUSADO_TOTAL': 'badge-danger'
      };
      return map[status] || 'badge-gray';
    }

    function formatarStatus(status) {
      const map = {
        'AGUARDANDO_ENTREGA': 'Aguardando', 'RECEBIDO_CONFORME': 'Recebido',
        'RECEBIDO_PARCIAL': 'Parcial', 'AGUARDANDO_DOCS': 'Aguard. Docs',
        'EM_ANALISE': 'Em An√°lise', 'PENDENCIA_DOCUMENTAL': 'Pend√™ncia',
        'ATESTO_COMISSAO': 'Atestado', 'ATESTADO_EXECUTOR': 'Executor OK',
        'LIQUIDADO': 'Liquidado', 'PAGO': 'Pago', 'RECUSADO_TOTAL': 'Recusado'
      };
      return map[status] || status;
    }

    function formatarEtapa(etapa) {
      const map = {
        'ETAPA_1_RECEBIMENTO_UE': '1. Recebimento',
        'ETAPA_2_CONSOLIDACAO': '2. Consolida√ß√£o',
        'ETAPA_3_ANALISE_COMISSAO': '3. Comiss√£o',
        'ETAPA_4_ATESTO_EXECUTOR': '4. Executor'
      };
      return map[etapa] || etapa || '-';
    }

    function calcularDiasRestantes(processo) {
      if (!processo.dataRecebimentoUNIAE) return 5;
      const dataReceb = new Date(processo.dataRecebimentoUNIAE);
      const prazo = new Date(dataReceb);
      prazo.setDate(prazo.getDate() + 5); // 5 dias √∫teis simplificado
      const hoje = new Date();
      const diff = Math.ceil((prazo - hoje) / (1000 * 60 * 60 * 24));
      return diff;
    }


    // ============================================================================
    // FILTROS E BUSCA
    // ============================================================================
    function filtrarProcessos(filtro) {
      filtroAtual = filtro;
      document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
      document.getElementById(`card-${filtro === 'todos' ? 'total' : filtro === 'pendente' ? 'pendentes' : filtro === 'atestado' ? 'atestados' : 'alertas'}`).classList.add('active');

      const labels = { todos: '', pendente: '‚Ä¢ Pendentes', atestado: '‚Ä¢ Atestados', alerta: '‚Ä¢ Prazo Cr√≠tico' };
      document.getElementById('filtro-ativo').textContent = labels[filtro];
      atualizarTabela();
    }

    function buscarProcessos() {
      atualizarTabela();
    }

    function mostrarEtapa(etapa) {
      const etapas = ['', 'ETAPA_1_RECEBIMENTO_UE', 'ETAPA_2_CONSOLIDACAO', 'ETAPA_3_ANALISE_COMISSAO', 'ETAPA_4_ATESTO_EXECUTOR'];
      document.querySelectorAll('.step').forEach((s, i) => {
        s.classList.remove('active', 'completed');
        if (i + 1 < etapa) s.classList.add('completed');
        if (i + 1 === etapa) s.classList.add('active');
      });
    }

    // ============================================================================
    // MODAIS
    // ============================================================================
    function abrirModal(id) {
      document.getElementById(id).classList.add('active');
      atualizarSelectsProcessos();
    }

    function fecharModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // Fechar modal ao clicar fora
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', function (e) {
        if (e.target === this) fecharModal(this.id);
      });
    });

    function atualizarSelectsProcessos() {
      const options = processos.map(p =>
        `<option value="${p.id}">${p.notaFiscal} - ${(p.fornecedor || '').substring(0, 30)}</option>`
      ).join('');

      ['select-processo-receb', 'select-processo-analise'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '<option value="">Selecione...</option>' + options;
      });
    }

    // ============================================================================
    // SALVAR NOVO PROCESSO
    // ============================================================================
    function salvarNovoProcesso() {
      const form = document.getElementById('form-novo');
      const dados = Object.fromEntries(new FormData(form).entries());

      if (!dados.notaFiscal || !dados.fornecedor || !dados.valorTotal || !dados.tipoGenero) {
        mostrarToast('warning', 'Aten√ß√£o', 'Preencha todos os campos obrigat√≥rios');
        return;
      }

      if (typeof google !== 'undefined' && google.script) {
        google.script.run
          .withSuccessHandler(result => {
            if (result?.success) {
              mostrarToast('success', 'Sucesso', 'Processo criado com sucesso!');
              fecharModal('modal-novo');
              form.reset();
              carregarDados();
            } else {
              mostrarToast('error', 'Erro', result?.error || 'Falha ao criar processo');
            }
          })
          .withFailureHandler(onErro)
          .iniciarProcessoAtesto(dados);
      } else {
        mostrarToast('success', 'Demo', 'Processo seria criado (modo demonstra√ß√£o)');
        fecharModal('modal-novo');
      }
    }

    // ============================================================================
    // SALVAR RECEBIMENTO
    // ============================================================================
    function salvarRecebimento() {
      const form = document.getElementById('form-recebimento');
      const formData = new FormData(form);
      const dados = Object.fromEntries(formData.entries());
      const idProcesso = dados.idProcesso;
      delete dados.idProcesso;

      if (!idProcesso || !dados.unidadeEscolar || !dados.responsavel || !dados.matriculaResponsavel) {
        mostrarToast('warning', 'Aten√ß√£o', 'Preencha todos os campos obrigat√≥rios');
        return;
      }

      // Converter strings para boolean
      ['quantitativaOk', 'qualitativaOk', 'assinatura', 'carimboUE'].forEach(k => {
        dados[k] = dados[k] === 'true';
      });

      if (typeof google !== 'undefined' && google.script) {
        google.script.run
          .withSuccessHandler(result => {
            if (result?.success) {
              mostrarToast('success', 'Sucesso', 'Recebimento registrado!');
              fecharModal('modal-recebimento');
              form.reset();
              carregarDados();
            } else {
              mostrarToast('error', 'Erro', result?.error || 'Falha ao registrar');
            }
          })
          .withFailureHandler(onErro)
          .registrarRecebimentoUE(idProcesso, dados);
      } else {
        mostrarToast('success', 'Demo', 'Recebimento seria registrado (modo demonstra√ß√£o)');
        fecharModal('modal-recebimento');
      }
    }


    // ============================================================================
    // SALVAR AN√ÅLISE DA COMISS√ÉO
    // ============================================================================
    function salvarAnalise() {
      const form = document.getElementById('form-analise');
      const formData = new FormData(form);
      const dados = Object.fromEntries(formData.entries());
      const idProcesso = dados.idProcesso;
      delete dados.idProcesso;

      if (!idProcesso || !dados.membrosPresentes || !dados.resultado) {
        mostrarToast('warning', 'Aten√ß√£o', 'Preencha todos os campos obrigat√≥rios');
        return;
      }

      // Converter membros para array
      const membros = dados.membrosPresentes.split('\n').filter(m => m.trim());
      if (membros.length < 3) {
        mostrarToast('warning', 'Aten√ß√£o', '√â necess√°rio no m√≠nimo 3 membros da Comiss√£o (Resolu√ß√£o FNDE 06/2020)');
        return;
      }
      dados.membrosPresentes = membros;

      // Converter checkboxes
      ['somaVerificada', 'atestoVerificado', 'nfConferida', 'sefazConsultada', 'observacoesAnalisadas'].forEach(k => {
        dados[k] = document.getElementById(`check-${k.replace('Verificada', 'soma').replace('Verificado', 'atesto').replace('Conferida', 'nf').replace('Consultada', 'sefaz').replace('Analisadas', 'obs')}`)?.checked || false;
      });
      dados.somaConforme = dados.somaVerificada;
      dados.atestoConforme = dados.atestoVerificado;

      if (typeof google !== 'undefined' && google.script) {
        google.script.run
          .withSuccessHandler(result => {
            if (result?.success) {
              mostrarToast('success', 'Sucesso', 'An√°lise registrada com sucesso!');
              fecharModal('modal-analise');
              form.reset();
              carregarDados();
            } else {
              mostrarToast('error', 'Erro', result?.error || 'Falha ao registrar an√°lise');
            }
          })
          .withFailureHandler(onErro)
          .registrarAnaliseComissaoUNIAE(idProcesso, dados);
      } else {
        mostrarToast('success', 'Demo', 'An√°lise seria registrada (modo demonstra√ß√£o)');
        fecharModal('modal-analise');
      }
    }

    // ============================================================================
    // VER DETALHES
    // ============================================================================
    function verDetalhes(id) {
      const p = processos.find(proc => proc.id === id);
      if (!p) {
        mostrarToast('error', 'Erro', 'Processo n√£o encontrado');
        return;
      }

      const diasRestantes = calcularDiasRestantes(p);
      const content = document.getElementById('detalhes-content');

      content.innerHTML = `
        <div style="display:grid;gap:20px;">
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;">
            <div>
              <div style="font-size:12px;color:var(--gray-500);margin-bottom:4px;">Nota Fiscal</div>
              <div style="font-size:18px;font-weight:600;">${p.notaFiscal || '-'}</div>
            </div>
            <div>
              <div style="font-size:12px;color:var(--gray-500);margin-bottom:4px;">Valor Total</div>
              <div style="font-size:18px;font-weight:600;">R$ ${Number(p.valorTotal || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
            </div>
            <div>
              <div style="font-size:12px;color:var(--gray-500);margin-bottom:4px;">Status</div>
              <span class="badge ${getBadgeClass(p.status)}">${formatarStatus(p.status)}</span>
            </div>
            <div>
              <div style="font-size:12px;color:var(--gray-500);margin-bottom:4px;">Prazo</div>
              <div class="prazo-indicator ${diasRestantes > 2 ? 'ok' : diasRestantes > 0 ? 'atencao' : 'vencido'}">
                <span class="material-symbols-outlined" style="font-size:16px;">${diasRestantes > 2 ? 'schedule' : diasRestantes > 0 ? 'warning' : 'error'}</span>
                ${diasRestantes > 0 ? diasRestantes + ' dias restantes' : diasRestantes === 0 ? 'Vence hoje' : 'Prazo vencido'}
              </div>
            </div>
          </div>

          <div style="border-top:1px solid var(--gray-200);padding-top:16px;">
            <div style="font-weight:600;margin-bottom:12px;">Informa√ß√µes do Fornecedor</div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
              <div><span style="color:var(--gray-500);">Raz√£o Social:</span> ${p.fornecedor || '-'}</div>
              <div><span style="color:var(--gray-500);">CNPJ:</span> ${p.cnpjFornecedor || '-'}</div>
              <div><span style="color:var(--gray-500);">Contrato:</span> ${p.contrato || '-'}</div>
              <div><span style="color:var(--gray-500);">Tipo:</span> ${p.tipoGenero || '-'}</div>
            </div>
          </div>

          <div style="border-top:1px solid var(--gray-200);padding-top:16px;">
            <div style="font-weight:600;margin-bottom:12px;">Hist√≥rico de Entregas</div>
            ${p.entregas && p.entregas.length > 0 ?
          p.entregas.map(e => `
                <div style="background:var(--gray-50);padding:12px;border-radius:8px;margin-bottom:8px;">
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <strong>${e.unidadeEscolar || 'UE n√£o informada'}</strong>
                    <span class="badge ${e.quantitativaOk && e.qualitativaOk ? 'badge-success' : 'badge-warning'}">${e.quantitativaOk && e.qualitativaOk ? 'Conforme' : 'Pend√™ncias'}</span>
                  </div>
                  <div style="font-size:13px;color:var(--gray-500);margin-top:4px;">
                    ${e.dataEntrega || '-'} ‚Ä¢ Resp: ${e.responsavel || '-'} (${e.matriculaResponsavel || '-'})
                  </div>
                </div>
              `).join('') : '<div style="color:var(--gray-500);font-size:14px;">Nenhuma entrega registrada</div>'
        }
          </div>

          ${p.observacoes ? `
            <div style="border-top:1px solid var(--gray-200);padding-top:16px;">
              <div style="font-weight:600;margin-bottom:8px;">Observa√ß√µes</div>
              <div style="background:var(--warning-light);padding:12px;border-radius:8px;font-size:14px;">${p.observacoes}</div>
            </div>
          ` : ''}
        </div>
      `;

      abrirModal('modal-detalhes');
    }

    function avancarEtapa(id) {
      mostrarToast('info', 'Info', 'Use os bot√µes de a√ß√£o espec√≠ficos para avan√ßar cada etapa');
    }


    // ============================================================================
    // GERAR RELAT√ìRIO SEI
    // ============================================================================
    function gerarRelatorioSEI() {
      const id = prompt('Digite o n√∫mero da Nota Fiscal para gerar o Despacho SEI:');
      if (!id) return;

      const processo = processos.find(p => p.notaFiscal === id || p.id === id);
      if (!processo) {
        mostrarToast('warning', 'Aten√ß√£o', 'Processo n√£o encontrado');
        return;
      }

      if (typeof google !== 'undefined' && google.script) {
        google.script.run
          .withSuccessHandler(result => {
            if (result?.success) {
              const win = window.open('', '_blank');
              win.document.write(`
                <html><head><title>Despacho SEI - NF ${processo.notaFiscal}</title>
                <style>body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto;line-height:1.8;}
                h1{font-size:16px;text-align:center;}pre{white-space:pre-wrap;}</style></head>
                <body><pre>${result.data.texto}</pre></body></html>
              `);
            } else {
              mostrarToast('error', 'Erro', result?.error || 'Falha ao gerar relat√≥rio');
            }
          })
          .withFailureHandler(onErro)
          .gerarRelatorioProcessoSEI(processo.id);
      } else {
        // Gerar modelo de despacho para demonstra√ß√£o
        const texto = gerarModeloDespacho(processo);
        const win = window.open('', '_blank');
        win.document.write(`
          <html><head><title>Despacho SEI - NF ${processo.notaFiscal}</title>
          <style>body{font-family:'Times New Roman',serif;padding:40px;max-width:800px;margin:0 auto;line-height:1.8;font-size:14px;}
          h1{font-size:14px;text-align:center;font-weight:bold;}
          .header{text-align:center;margin-bottom:30px;}
          .content{text-align:justify;}</style></head>
          <body>${texto}</body></html>
        `);
      }
    }

    function gerarModeloDespacho(p) {
      const hoje = new Date().toLocaleDateString('pt-BR');
      return `
        <div class="header">
          <p>GOVERNO DO DISTRITO FEDERAL<br>
          SECRETARIA DE ESTADO DE EDUCA√á√ÉO<br>
          COORDENA√á√ÉO REGIONAL DE ENSINO DE PLANALTINA<br>
          UNIDADE REGIONAL DE INFRAESTRUTURA E APOIO EDUCACIONAL</p>
        </div>
        <h1>DESPACHO DE ATESTO</h1>
        <div class="content">
          <p><strong>Processo SEI:</strong> ${p.processoSEI || '00080-00000000/2024-00'}</p>
          <p><strong>Assunto:</strong> Atesto de Recebimento de G√™neros Aliment√≠cios</p>
          <p><strong>Nota Fiscal:</strong> ${p.notaFiscal}</p>
          <p><strong>Fornecedor:</strong> ${p.fornecedor}</p>
          <p><strong>CNPJ:</strong> ${p.cnpjFornecedor || '-'}</p>
          <p><strong>Valor:</strong> R$ ${Number(p.valorTotal || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
          <br>
          <p>A Comiss√£o Regional de Recebimento de G√™neros Aliment√≠cios da UNIAE/CRE-PP, no uso de suas atribui√ß√µes legais, com fundamento na Lei n¬∫ 4.320/64 (Arts. 62 e 63), Lei n¬∫ 14.133/2021 e Resolu√ß√£o CD/FNDE n¬∫ 06/2020, ap√≥s an√°lise da documenta√ß√£o comprobat√≥ria, ATESTA que:</p>
          <br>
          <p>1. Os Termos de Recebimento foram devidamente conferidos e apresentam assinatura digital, matr√≠cula, data e identifica√ß√£o das Unidades Escolares;</p>
          <p>2. A soma dos quantitativos dos Termos de Recebimento corresponde ao quantitativo faturado na Nota Fiscal;</p>
          <p>3. Os dados da Nota Fiscal est√£o em conformidade com o contrato vigente;</p>
          <p>4. A documenta√ß√£o est√° apta a instruir o processo de liquida√ß√£o da despesa.</p>
          <br>
          <p>Encaminha-se ao Executor do Contrato para ci√™ncia e provid√™ncias.</p>
          <br>
          <p style="text-align:right;">Planaltina-DF, ${hoje}</p>
          <br>
          <p style="text-align:center;">_______________________________<br>
          Membro 1 - Matr√≠cula<br><br>
          _______________________________<br>
          Membro 2 - Matr√≠cula<br><br>
          _______________________________<br>
          Membro 3 - Matr√≠cula</p>
        </div>
      `;
    }

    function imprimirChecklist() {
      window.print();
    }

    // ============================================================================
    // TOAST NOTIFICATIONS
    // ============================================================================
    function mostrarToast(tipo, titulo, mensagem) {
      const container = document.getElementById('toast-container');
      const icons = { success: 'check_circle', error: 'error', warning: 'warning', info: 'info' };

      const toast = document.createElement('div');
      toast.className = `toast ${tipo}`;
      toast.innerHTML = `
        <span class="material-symbols-outlined toast-icon">${icons[tipo]}</span>
        <div class="toast-content">
          <div class="toast-title">${titulo}</div>
          <div class="toast-message">${mensagem}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <span class="material-symbols-outlined">close</span>
        </button>
      `;

      container.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'toastIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    // ============================================================================
    // DADOS DE DEMONSTRA√á√ÉO
    // ============================================================================
    function gerarDadosDemo() {
      return [
        { id: '1', notaFiscal: '12345', fornecedor: 'Distribuidora ABC Ltda', valorTotal: 15420.50, status: 'EM_ANALISE', etapaAtual: 'ETAPA_3_ANALISE_COMISSAO', tipoGenero: 'PERECIVEL', dataRecebimentoUNIAE: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(), entregas: [{ unidadeEscolar: 'EC 01 Planaltina', dataEntrega: '2024-01-15', responsavel: 'Maria Silva', matriculaResponsavel: '123456', quantitativaOk: true, qualitativaOk: true }] },
        { id: '2', notaFiscal: '12346', fornecedor: 'Alimentos XYZ S.A.', valorTotal: 8750.00, status: 'AGUARDANDO_DOCS', etapaAtual: 'ETAPA_2_CONSOLIDACAO', tipoGenero: 'NAO_PERECIVEL', dataRecebimentoUNIAE: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString(), entregas: [] },
        { id: '3', notaFiscal: '12347', fornecedor: 'Hortifruti Regional', valorTotal: 5230.75, status: 'ATESTO_COMISSAO', etapaAtual: 'ETAPA_4_ATESTO_EXECUTOR', tipoGenero: 'PERECIVEL', dataRecebimentoUNIAE: new Date(Date.now() - 6 * 24 * 60 * 60 * 1000).toISOString(), entregas: [{ unidadeEscolar: 'CED 02', dataEntrega: '2024-01-14', responsavel: 'Jo√£o Santos', matriculaResponsavel: '654321', quantitativaOk: true, qualitativaOk: true }] },
        { id: '4', notaFiscal: '12348', fornecedor: 'Latic√≠nios Bom Sabor', valorTotal: 12100.00, status: 'PENDENCIA_DOCUMENTAL', etapaAtual: 'ETAPA_3_ANALISE_COMISSAO', tipoGenero: 'PERECIVEL', dataRecebimentoUNIAE: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), observacoes: 'Falta identifica√ß√£o digital da UE no Termo de Recebimento da EC 03', entregas: [{ unidadeEscolar: 'EC 03', dataEntrega: '2024-01-13', responsavel: 'Ana Costa', matriculaResponsavel: '789012', quantitativaOk: true, qualitativaOk: false }] },
        { id: '5', notaFiscal: '12349', fornecedor: 'Carnes Premium', valorTotal: 22500.00, status: 'RECEBIDO_CONFORME', etapaAtual: 'ETAPA_1_RECEBIMENTO_UE', tipoGenero: 'PERECIVEL', entregas: [] }
      ];
    }
  </script>
</body>

</html>