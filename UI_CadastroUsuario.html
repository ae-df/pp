<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Usuário - UNIAE</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        h2 {
            color: #202124;
            margin-top: 0;
            text-align: center;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #5f6368;
            font-size: 14px;
            font-weight: 500;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }

        input:focus,
        select:focus {
            border-color: #4285f4;
            outline: none;
        }

        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 4px;
            width: 100%;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 16px;
        }

        button:hover {
            background: #3367d6;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .error {
            color: #d93025;
            font-size: 14px;
            margin-top: 8px;
            display: none;
            text-align: center;
        }

        .success {
            color: #1e8e3e;
            font-size: 14px;
            margin-top: 8px;
            display: none;
            text-align: center;
        }

        .login-link {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
        }

        .login-link a {
            color: #4285f4;
            text-decoration: none;
        }

        .login-link a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>Cadastro de Usuário</h2>
        <form id="cadastroForm" onsubmit="handleRegister(event)">
            <div class="form-group">
                <label for="nome">Nome Completo</label>
                <input type="text" id="nome" name="nome" required placeholder="Seu nome">
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required placeholder="seu@email.com">
            </div>

            <div class="form-group">
                <label for="senha">Senha</label>
                <input type="password" id="senha" name="senha" required minlength="6" placeholder="Mínimo 6 caracteres">
            </div>

            <div class="form-group">
                <label for="tipo">Tipo de Usuário</label>
                <select id="tipo" name="tipo" onchange="toggleInstituicao()">
                    <option value="FORNECEDOR">Fornecedor</option>
                    <option value="REPRESENTANTE">Representante Escolar</option>
                    <option value="NUTRICIONISTA">Nutricionista</option>
                </select>
            </div>

            <div class="form-group" id="instituicaoGroup">
                <label for="instituicao">Instituição / Empresa</label>
                <input type="text" id="instituicao" name="instituicao" placeholder="Nome da Escola ou Empresa">
            </div>

            <div class="form-group" id="cnpjGroup">
                <label for="cnpj">CNPJ (Opcional)</label>
                <input type="text" id="cnpj" name="cnpj" placeholder="00.000.000/0000-00">
            </div>

            <button type="submit" id="btnSubmit">Cadastrar</button>

            <div id="errorMsg" class="error"></div>
            <div id="successMsg" class="success"></div>
        </form>

        <div class="login-link">
            Já tem uma conta? <a href="#" onclick="google.script.run.openLogin(); return false;">Faça Login</a>
        </div>
    </div>

    <script>
        function toggleInstituicao() {
            const tipo = document.getElementById('tipo').value;
            const cnpjGroup = document.getElementById('cnpjGroup');

            if (tipo === 'FORNECEDOR') {
                cnpjGroup.style.display = 'block';
            } else {
                cnpjGroup.style.display = 'none';
            }
        }

        // Inicializa estado
        toggleInstituicao();

        function handleRegister(e) {
            e.preventDefault();

            const btn = document.getElementById('btnSubmit');
            const errorDiv = document.getElementById('errorMsg');
            const successDiv = document.getElementById('successMsg');

            // Reset messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            btn.disabled = true;
            btn.textContent = 'Cadastrando...';

            const data = {
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                senha: document.getElementById('senha').value,
                tipo: document.getElementById('tipo').value,
                instituicao: document.getElementById('instituicao').value,
                cnpj: document.getElementById('cnpj').value
            };

            google.script.run
                .withSuccessHandler(function (response) {
                    btn.disabled = false;
                    btn.textContent = 'Cadastrar';

                    if (response && response.success) {
                        successDiv.textContent = 'Cadastro realizado com sucesso! Você já pode fazer login.';
                        successDiv.style.display = 'block';
                        document.getElementById('cadastroForm').reset();

                        // Opcional: Redirecionar para login após alguns segundos
                        setTimeout(function () {
                            // Tenta fechar o diálogo se estiver em modal
                            try {
                                google.script.host.close();
                            } catch (e) {
                                // Não está em modal - comportamento esperado em Web App
                                console.debug('Não está em modal, cadastro concluído');
                            }
                        }, 3000);
                    } else {
                        errorDiv.textContent = response.error || 'Erro desconhecido ao cadastrar.';
                        errorDiv.style.display = 'block';
                    }
                })
                .withFailureHandler(function (error) {
                    btn.disabled = false;
                    btn.textContent = 'Cadastrar';
                    errorDiv.textContent = 'Erro de conexão: ' + error.message;
                    errorDiv.style.display = 'block';
                })
                .registerUser(data);
        }
    </script>
</body>

</html>