<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciador CRUD</title>
  <?!= include('DesignSystem'); ?>
  <style>
    /* Handled by DesignSystem */


    body {
      font-family: var(--font-family-base, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif);
      background: var(--bg-primary);
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--bg-surface);
      border-radius: var(--border-radius-xl);
      box-shadow: var(--shadow-sm);
      padding: 24px;
      border: 1px solid var(--bg-tertiary);
    }

    h1 {
      color: var(--text-primary);
      margin-bottom: 24px;
    }

    .toolbar {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    /* Using DS styles but ensuring local mappings if needed */
    .btn {
      cursor: pointer;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--error);
      color: white;
    }

    select,
    input {
      padding: 10px;
      border: 1px solid var(--bg-tertiary);
      border-radius: var(--border-radius-md);
      font-size: 14px;
      background: var(--bg-surface);
      color: var(--text-primary);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    thead {
      background: var(--bg-secondary);
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--bg-tertiary);
    }

    th {
      font-weight: 600;
      color: var(--text-secondary);
    }

    td {
      color: var(--text-primary);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    /* Spinner handled by DesignSystem */
  </style>

</head>

<body>
  <div class="container">
    <h1>üóÇÔ∏è Gerenciador CRUD</h1>

    <div class="toolbar">
      <select id="sheetSelect">
        <option value="">Selecione uma aba...</option>
        <option value="Notas_Fiscais">Notas Fiscais</option>
        <option value="Entregas">Entregas</option>
        <option value="Fornecedores">Fornecedores</option>
        <option value="Recusas">Recusas</option>
        <option value="Glosas">Glosas</option>
      </select>

      <button class="btn btn-primary" onclick="loadData()">üîÑ Carregar Dados</button>
      <button class="btn btn-success" onclick="createRecord()">‚ûï Novo Registro</button>
      <input type="text" id="searchInput" placeholder="Buscar..." style="flex: 1; min-width: 200px;">
    </div>

    <div id="dataContainer">
      <div class="loading">
        <div class="spinner"></div>
        <div>Selecione uma aba e clique em "Carregar Dados"</div>
      </div>
    </div>
  </div>

  <script>
    let currentData = [];
    let currentSheet = '';

    function loadData() {
      const sheet = document.getElementById('sheetSelect').value;
      if (!sheet) {
        alert('Selecione uma aba primeiro!');
        return;
      }

      currentSheet = sheet;
      document.getElementById('dataContainer').innerHTML = '<div class="loading"><div class="spinner"></div><div>Carregando dados...</div></div>';

      google.script.run
        .withSuccessHandler(displayData)
        .withFailureHandler(function (error) {
          document.getElementById('dataContainer').innerHTML = '<div class="loading">‚ùå Erro: ' + error.message + '</div>';
        })
        .readRecords(sheet, {});
    }

    function displayData(result) {
      if (!result.success || !result.data || result.data.length === 0) {
        document.getElementById('dataContainer').innerHTML = '<div class="loading">Nenhum registro encontrado</div>';
        return;
      }

      currentData = result.data;
      const headers = Object.keys(result.data[0]);

      let html = '<table><thead><tr>';
      headers.forEach(h => html += '<th>' + h + '</th>');
      html += '<th>A√ß√µes</th></tr></thead><tbody>';

      result.data.forEach((row, idx) => {
        html += '<tr>';
        headers.forEach(h => html += '<td>' + (row[h] || '') + '</td>');
        html += '<td><button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="editRecord(' + idx + ')">‚úèÔ∏è</button> ';
        html += '<button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteRecord(' + idx + ')">üóëÔ∏è</button></td>';
        html += '</tr>';
      });

      html += '</tbody></table>';
      document.getElementById('dataContainer').innerHTML = html;
    }

    function createRecord() {
      if (!currentSheet) {
        alert('Selecione uma aba primeiro!');
        return;
      }
      alert('Funcionalidade de cria√ß√£o em desenvolvimento');
    }

    function editRecord(idx) {
      alert('Editar registro ' + idx + ' - Em desenvolvimento');
    }

    function deleteRecord(idx) {
      if (!confirm('Deseja realmente excluir este registro?')) return;

      const row = currentData[idx];
      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            alert('‚úÖ Registro exclu√≠do com sucesso!');
            loadData();
          } else {
            alert('‚ùå Erro: ' + result.message);
          }
        })
        .withFailureHandler(function (error) {
          alert('‚ùå Erro: ' + error.message);
        })
        .deleteRecord(currentSheet, row._rowIndex, false);
    }

    document.getElementById('searchInput').addEventListener('input', function (e) {
      const term = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('tbody tr');

      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
      });
    });
  </script>
</body>

</html>