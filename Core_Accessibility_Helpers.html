<!--
  @fileoverview Helpers de Acessibilidade - Componentes e Estilos
  @version 1.0.0
  @description Componentes HTML acessíveis e estilos para conformidade WCAG 2.1
  
  INTERVENÇÃO 7/16: Correção de Problemas de Acessibilidade
  - Labels para todos os inputs
  - Atributos ARIA adequados
  - Suporte a leitores de tela
  - Navegação por teclado
  
  @author UNIAE CRE Team
  @created 2025-12-26
-->

<style>
/* ============================================================================
   ESTILOS DE ACESSIBILIDADE
   ============================================================================ */

/* Skip link para navegação por teclado */
.skip-link {
  position: absolute;
  top: -40px;
  left: 0;
  background: var(--ae-primary, #2E7D32);
  color: white;
  padding: 8px 16px;
  z-index: 10000;
  text-decoration: none;
  font-weight: 600;
  border-radius: 0 0 4px 0;
  transition: top 0.3s;
}

.skip-link:focus {
  top: 0;
}

/* Labels visualmente ocultos mas acessíveis para leitores de tela */
.sr-only,
.visually-hidden {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* Focus visível para navegação por teclado */
*:focus-visible {
  outline: 3px solid var(--ae-primary, #2E7D32);
  outline-offset: 2px;
}

/* Remove outline padrão quando não é navegação por teclado */
*:focus:not(:focus-visible) {
  outline: none;
}

/* Indicador de campo obrigatório */
.required-indicator {
  color: var(--ae-accent, #D32F2F);
  margin-left: 4px;
  font-weight: bold;
}

.required-indicator::after {
  content: " (obrigatório)";
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* Mensagens de erro acessíveis */
.form-error,
.error-message {
  color: var(--ae-accent, #D32F2F);
  font-size: 0.875rem;
  margin-top: 4px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.form-error::before,
.error-message::before {
  content: "⚠️";
}

/* Estados de validação */
.form-input[aria-invalid="true"],
input[aria-invalid="true"],
select[aria-invalid="true"],
textarea[aria-invalid="true"] {
  border-color: var(--ae-accent, #D32F2F);
  box-shadow: 0 0 0 1px var(--ae-accent, #D32F2F);
}

.form-input[aria-invalid="false"],
input[aria-invalid="false"],
select[aria-invalid="false"],
textarea[aria-invalid="false"] {
  border-color: var(--ae-primary, #2E7D32);
}

/* Grupo de formulário acessível */
.a11y-form-group {
  margin-bottom: 16px;
}

.a11y-form-group label {
  display: block;
  margin-bottom: 4px;
  font-weight: 500;
  color: var(--ae-text-primary, #212121);
}

.a11y-form-group .hint,
.a11y-form-group .form-hint {
  font-size: 0.875rem;
  color: var(--ae-text-secondary, #757575);
  margin-top: 4px;
}

/* Checkbox e Radio acessíveis */
.a11y-checkbox,
.a11y-radio {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  padding: 8px 0;
}

.a11y-checkbox input,
.a11y-radio input {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

/* Botões com estados claros */
button:disabled,
.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Alto contraste para texto */
.high-contrast {
  color: #000 !important;
  background: #fff !important;
}

/* Animações reduzidas para usuários que preferem */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}

/* Tamanho de fonte mínimo para legibilidade */
body {
  font-size: max(16px, 1rem);
  line-height: 1.5;
}

/* Espaçamento adequado para toque em mobile */
@media (pointer: coarse) {
  button,
  .btn,
  input[type="checkbox"],
  input[type="radio"],
  select {
    min-height: 44px;
    min-width: 44px;
  }
}

/* Indicador de carregamento acessível */
.loading-indicator {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.loading-indicator::before {
  content: "";
  width: 16px;
  height: 16px;
  border: 2px solid currentColor;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Live region para anúncios */
.live-region {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}
</style>

<script>
/**
 * Helpers de Acessibilidade JavaScript
 */
const A11yHelpers = {
  
  /**
   * Adiciona label acessível a um input
   * @param {HTMLElement} input - Elemento input
   * @param {string} labelText - Texto do label
   * @param {boolean} visuallyHidden - Se deve ser visualmente oculto
   */
  addLabel: function(input, labelText, visuallyHidden) {
    if (!input || !labelText) return;
    
    // Se já tem label, não adiciona
    if (input.getAttribute('aria-label') || input.getAttribute('aria-labelledby')) {
      return;
    }
    
    const id = input.id || 'input-' + Math.random().toString(36).substr(2, 9);
    input.id = id;
    
    if (visuallyHidden) {
      input.setAttribute('aria-label', labelText);
    } else {
      const label = document.createElement('label');
      label.setAttribute('for', id);
      label.textContent = labelText;
      input.parentNode.insertBefore(label, input);
    }
  },
  
  /**
   * Adiciona aria-label a inputs sem label
   */
  fixMissingLabels: function() {
    const inputs = document.querySelectorAll('input:not([aria-label]):not([aria-labelledby])');
    
    inputs.forEach(function(input) {
      // Verifica se tem label associado
      const id = input.id;
      if (id) {
        const label = document.querySelector('label[for="' + id + '"]');
        if (label) return; // Já tem label
      }
      
      // Tenta inferir label do placeholder ou name
      const placeholder = input.getAttribute('placeholder');
      const name = input.getAttribute('name');
      const type = input.getAttribute('type');
      
      let labelText = placeholder || name || type || 'Campo de entrada';
      
      // Limpa o texto
      labelText = labelText.replace(/[_-]/g, ' ').replace(/([A-Z])/g, ' $1').trim();
      
      input.setAttribute('aria-label', labelText);
    });
  },
  
  /**
   * Adiciona atributo lang ao HTML se não existir
   * @param {string} lang - Código do idioma (default: 'pt-BR')
   */
  ensureLang: function(lang) {
    lang = lang || 'pt-BR';
    const html = document.documentElement;
    if (!html.getAttribute('lang')) {
      html.setAttribute('lang', lang);
    }
  },
  
  /**
   * Cria região de anúncios para leitores de tela
   * @returns {HTMLElement}
   */
  createLiveRegion: function() {
    let region = document.getElementById('a11y-live-region');
    if (!region) {
      region = document.createElement('div');
      region.id = 'a11y-live-region';
      region.className = 'live-region';
      region.setAttribute('aria-live', 'polite');
      region.setAttribute('aria-atomic', 'true');
      document.body.appendChild(region);
    }
    return region;
  },
  
  /**
   * Anuncia mensagem para leitores de tela
   * @param {string} message - Mensagem a anunciar
   * @param {string} priority - 'polite' ou 'assertive'
   */
  announce: function(message, priority) {
    priority = priority || 'polite';
    const region = this.createLiveRegion();
    region.setAttribute('aria-live', priority);
    
    // Limpa e adiciona nova mensagem
    region.textContent = '';
    setTimeout(function() {
      region.textContent = message;
    }, 100);
  },
  
  /**
   * Adiciona skip link para navegação por teclado
   * @param {string} targetId - ID do conteúdo principal
   */
  addSkipLink: function(targetId) {
    targetId = targetId || 'main-content';
    
    if (document.querySelector('.skip-link')) return;
    
    const skipLink = document.createElement('a');
    skipLink.href = '#' + targetId;
    skipLink.className = 'skip-link';
    skipLink.textContent = 'Pular para o conteúdo principal';
    
    document.body.insertBefore(skipLink, document.body.firstChild);
  },
  
  /**
   * Marca campo como inválido com mensagem de erro
   * @param {HTMLElement} input - Elemento input
   * @param {string} errorMessage - Mensagem de erro
   */
  setInvalid: function(input, errorMessage) {
    if (!input) return;
    
    input.setAttribute('aria-invalid', 'true');
    
    const errorId = input.id + '-error';
    let errorEl = document.getElementById(errorId);
    
    if (!errorEl) {
      errorEl = document.createElement('div');
      errorEl.id = errorId;
      errorEl.className = 'form-error';
      errorEl.setAttribute('role', 'alert');
      input.parentNode.appendChild(errorEl);
    }
    
    errorEl.textContent = errorMessage;
    input.setAttribute('aria-describedby', errorId);
  },
  
  /**
   * Marca campo como válido
   * @param {HTMLElement} input - Elemento input
   */
  setValid: function(input) {
    if (!input) return;
    
    input.setAttribute('aria-invalid', 'false');
    
    const errorId = input.id + '-error';
    const errorEl = document.getElementById(errorId);
    if (errorEl) {
      errorEl.textContent = '';
    }
  },
  
  /**
   * Inicializa todas as correções de acessibilidade
   */
  init: function() {
    this.ensureLang('pt-BR');
    this.fixMissingLabels();
    this.createLiveRegion();
    this.addSkipLink('main-content');
    
    console.log('[A11y] Helpers de acessibilidade inicializados');
  }
};

// Auto-inicializa quando DOM estiver pronto
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    A11yHelpers.init();
  });
} else {
  A11yHelpers.init();
}
</script>
