<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#667eea">
  <meta name="mobile-web-app-capable" content="yes">
  <title>UNIAE - Sistema de Alimenta√ß√£o Escolar</title>
  <?!= include('design-system'); ?>
  <?!= include('Mobile_S20_Adjustments'); ?>
  <?!= include('UX_Enhanced_System'); ?>
  <?!= include('UX_Feedback_Components'); ?>
  <?!= include('UX_Form_Enhancements'); ?>
  <?!= include('UI_UX_Improvements'); ?>
  <?!= include('Mobile_S20_CSS'); ?>
  <?!= include('Frontend_Standardization_Fixes'); ?>
  <style>
    /* Compatibility with Design System */
    /* Compatibility with Design System - Handled in design-system.html */

    /* Reset override if needed, otherwise handled by DesignSystem */


    /* Body styles handled by Design System */

    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--primary);
      color: white;
      padding: 8px 16px;
      z-index: 100;
      transition: top 0.3s;
    }

    .skip-link:focus {
      top: 0;
    }

    /* Layout Principal */
    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 50;
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      padding: 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 24px;
      font-weight: 700;
    }

    .sidebar-logo span {
      font-size: 32px;
    }

    .sidebar-subtitle {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 4px;
    }

    .sidebar-nav {
      flex: 1;
      padding: 16px 12px;
      overflow-y: auto;
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.6;
      padding: 0 12px;
      margin-bottom: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
      font-size: 14px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.85);
      text-decoration: none;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .nav-item .material-symbols-outlined {
      font-size: 22px;
    }

    .nav-badge {
      margin-left: auto;
      background: var(--error);
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
    }

    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-md);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .user-details {
      flex: 1;
    }

    .user-name {
      font-size: 14px;
      font-weight: 600;
    }

    .user-role {
      font-size: 12px;
      opacity: 0.7;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 280px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      background: var(--bg-surface);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 40;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .menu-toggle {
      display: none;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: var(--radius-sm);
    }

    .menu-toggle:hover {
      background: var(--bg-secondary);
    }

    .page-title {
      font-size: 20px;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-secondary);
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      transition: var(--transition);
    }

    .header-btn:hover {
      background: var(--border);
    }

    .header-btn.primary {
      background: var(--primary);
      color: white;
    }

    .header-btn.primary:hover {
      background: var(--primary-dark);
    }

    /* Content Area */
    .content {
      flex: 1;
      padding: 32px;
    }

    /* Page Sections */
    .page-section {
      display: none;
    }

    .page-section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .stat-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .stat-icon.blue {
      background: var(--info-light);
      color: var(--info);
    }

    .stat-icon.green {
      background: var(--success-light);
      color: var(--success);
    }

    .stat-icon.yellow {
      background: var(--warning-light);
      color: var(--warning);
    }

    .stat-icon.red {
      background: var(--error-light);
      color: var(--error);
    }

    .stat-trend {
      font-size: 12px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-trend.up {
      color: var(--success);
    }

    .stat-trend.down {
      color: var(--error);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Card Overrides */
    /* Card styles handled by Design System */

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .action-card {
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      padding: 24px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: var(--transition);
      text-align: center;
    }

    .action-card:hover {
      border-color: var(--primary);
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .action-card .icon {
      font-size: 40px;
      margin-bottom: 12px;
    }

    .action-card h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .action-card p {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Tables */
    /* Table styles handled by Design System */

    /* Badges */
    /* Badges handled by DesignSystem */

    /* Buttons handled by DS */
    /* Btn-icon handled by Design System */

    /* Primary/Secondary handled by DS */


    /* Forms */
    /* Form styles handled by Design System */

    /* Modal */
    /* Modal styles handled by Design System */

    /* Toast */
    /* Toast styles handled by Design System */

    /* Loading */
    /* Loading styles handled by Design System */

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-state .icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .empty-state p {
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-input {
      padding: 8px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 14px;
      min-width: 180px;
    }

    .filter-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }

    .tab {
      padding: 12px 20px;
      background: none;
      border: none;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: var(--transition);
    }

    .tab:hover {
      color: var(--text-primary);
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    /* Login Screen */
    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      padding: 20px;
    }

    .login-card {
      background: var(--bg-surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      width: 100%;
      max-width: 420px;
      overflow: hidden;
    }

    .login-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 40px 32px;
      text-align: center;
    }

    .login-header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .login-header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .login-body {
      padding: 32px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .menu-toggle {
        display: flex;
      }

      .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 45;
      }

      .sidebar-overlay.active {
        display: block;
      }
    }

    @media (max-width: 640px) {
      .header {
        padding: 12px 16px;
      }

      .content {
        padding: 16px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .quick-actions {
        grid-template-columns: repeat(2, 1fr);
      }

      .action-card {
        padding: 16px;
      }

      .action-card .icon {
        font-size: 28px;
      }

      .action-card h3 {
        font-size: 14px;
      }

      .action-card p {
        display: none;
      }

      .card-header {
        padding: 16px;
      }

      .card-body {
        padding: 16px;
      }

      th,
      td {
        padding: 12px 8px;
        font-size: 13px;
      }

      .modal {
        max-width: 100%;
        border-radius: var(--radius-lg);
      }
    }

    /* Accessibility */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    :focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    @media (prefers-reduced-motion: reduce) {

      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>

<body>
  <?!= include('Mobile_S20_Structure'); ?>
  <a href="#main-content" class="skip-link">Pular para conte√∫do principal</a>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <div class="login-header">
        <h1>üçé UNIAE</h1>
        <p>Sistema de Gest√£o de Alimenta√ß√£o Escolar</p>
      </div>
      <div class="login-body">
        <div id="loginAlert" style="display:none;"></div>
        <form id="loginForm" onsubmit="handleLogin(event)">
          <div class="form-group">
            <label class="form-label" for="loginEmail">Email</label>
            <input type="email" id="loginEmail" class="form-input" placeholder="seu@email.com" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="loginSenha">Senha</label>
            <input type="password" id="loginSenha" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          </div>
          <button type="submit" class="btn btn-primary" style="width:100%;padding:14px;">
            <span class="material-symbols-outlined">login</span>
            Entrar
          </button>
        </form>
        <div style="text-align:center;margin-top:20px;">
          <button type="button" class="btn btn-secondary" onclick="showRegisterForm()" style="width:100%;">
            Criar Conta
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="app-container" style="display:none;">
    <!-- Sidebar Overlay (mobile) -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" role="navigation" aria-label="Menu principal">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <span>üçé</span>
          <div>UNIAE</div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Principal</div>
          <a href="#" class="nav-item active" data-page="dashboard" onclick="navigateTo('dashboard')">
            <span class="material-symbols-outlined">dashboard</span>
            Dashboard
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Gest√£o</div>
          <a href="#" class="nav-item" data-page="notas" onclick="navigateTo('notas')">
            <span class="material-symbols-outlined">receipt_long</span>
            Notas Fiscais
            <span class="nav-badge" id="badgeNFs" style="display:none;">0</span>
          </a>
          <a href="#" class="nav-item" data-page="entregas" onclick="navigateTo('entregas')">
            <span class="material-symbols-outlined">local_shipping</span>
            Entregas
          </a>
          <a href="#" class="nav-item" data-page="recusas" onclick="navigateTo('recusas')">
            <span class="material-symbols-outlined">cancel</span>
            Recusas
          </a>
          <a href="#" class="nav-item" data-page="glosas" onclick="navigateTo('glosas')">
            <span class="material-symbols-outlined">money_off</span>
            Glosas
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Nutri√ß√£o</div>
          <a href="#" class="nav-item" data-page="alunos" onclick="navigateTo('alunos')">
            <span class="material-symbols-outlined">school</span>
            Alunos Especiais
          </a>
          <a href="#" class="nav-item" data-page="cardapios" onclick="navigateTo('cardapios')">
            <span class="material-symbols-outlined">restaurant_menu</span>
            Card√°pios
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">An√°lises</div>
          <a href="#" class="nav-item" data-page="relatorios" onclick="navigateTo('relatorios')">
            <span class="material-symbols-outlined">analytics</span>
            Relat√≥rios
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">U</div>
          <div class="user-details">
            <div class="user-name" id="userName">Usu√°rio</div>
            <div class="user-role" id="userRole">Analista</div>
          </div>
          <button class="btn btn-icon" onclick="handleLogout()" title="Sair" aria-label="Sair do sistema">
            <span class="material-symbols-outlined">logout</span>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content" role="main">
      <!-- Header -->
      <header class="header">
        <div class="header-left">
          <button class="menu-toggle" onclick="toggleSidebar()" aria-label="Abrir menu">
            <span class="material-symbols-outlined">menu</span>
          </button>
          <h1 class="page-title" id="pageTitle">Dashboard</h1>
        </div>
        <div class="header-right">
          <button class="header-btn" onclick="refreshData()" title="Atualizar dados">
            <span class="material-symbols-outlined">refresh</span>
            <span class="btn-text">Atualizar</span>
          </button>
          <button class="header-btn primary" id="headerActionBtn" onclick="openQuickAction()">
            <span class="material-symbols-outlined">add</span>
            <span class="btn-text">Nova NF</span>
          </button>
        </div>
      </header>

      <!-- Content -->
      <div class="content">
        <!-- Dashboard Page -->
        <section id="page-dashboard" class="page-section active" aria-label="Dashboard">
          <!-- Stats -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon blue">üßæ</div>
                <div class="stat-trend up">
                  <span class="material-symbols-outlined" style="font-size:16px;">trending_up</span>
                  +12%
                </div>
              </div>
              <div class="stat-value" id="statNFs">0</div>
              <div class="stat-label">Notas Fiscais</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon green">üöö</div>
              </div>
              <div class="stat-value" id="statEntregas">0</div>
              <div class="stat-label">Entregas Realizadas</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon yellow">‚è≥</div>
              </div>
              <div class="stat-value" id="statPendentes">0</div>
              <div class="stat-label">Pendentes</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon red">‚ö†Ô∏è</div>
              </div>
              <div class="stat-value" id="statProblemas">0</div>
              <div class="stat-label">Com Problemas</div>
            </div>
          </div>

          <!-- Quick Actions -->
          <h2 style="font-size:18px;font-weight:600;margin-bottom:16px;">A√ß√µes R√°pidas</h2>
          <div class="quick-actions">
            <div class="action-card" onclick="openModal('nova-nf')" tabindex="0" role="button"
              aria-label="Cadastrar nova nota fiscal">
              <div class="icon">‚ûï</div>
              <h3>Nova NF</h3>
              <p>Cadastrar nota fiscal</p>
            </div>
            <div class="action-card" onclick="openModal('nova-entrega')" tabindex="0" role="button"
              aria-label="Registrar entrega">
              <div class="icon">üöö</div>
              <h3>Registrar Entrega</h3>
              <p>Confirmar recebimento</p>
            </div>
            <div class="action-card" onclick="openModal('atestar')" tabindex="0" role="button"
              aria-label="Atestar notas fiscais">
              <div class="icon">‚úÖ</div>
              <h3>Atestar NFs</h3>
              <p>Aprovar notas conferidas</p>
            </div>
            <div class="action-card" onclick="gerarDadosTeste()" tabindex="0" role="button"
              aria-label="Gerar dados de teste" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <div class="icon">üß™</div>
              <h3 style="color:white;">Dados Teste</h3>
              <p style="color:rgba(255,255,255,0.8);">Gerar cen√°rios demo</p>
            </div>
            <div class="action-card" onclick="mostrarCenariosTeste()" tabindex="0" role="button"
              aria-label="Ver cen√°rios de teste" style="background:linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
              <div class="icon">üìä</div>
              <h3 style="color:white;">Ver Cen√°rios</h3>
              <p style="color:rgba(255,255,255,0.8);">Visualizar workflow</p>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Atividade Recente</h2>
              <button class="btn btn-secondary btn-sm" onclick="navigateTo('notas')">Ver Todas</button>
            </div>
            <div class="card-body">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>NF</th>
                      <th>Fornecedor</th>
                      <th>Valor</th>
                      <th>Status</th>
                      <th>Data</th>
                    </tr>
                  </thead>
                  <tbody id="recentActivityTable">
                    <tr>
                      <td colspan="5" style="text-align:center;color:var(--text-muted);">Carregando...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Notas Fiscais Page -->
        <section id="page-notas" class="page-section" aria-label="Notas Fiscais">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Notas Fiscais</h2>
              <div class="filters">
                <input type="text" class="filter-input" placeholder="Buscar NF..." id="searchNF"
                  onkeyup="filterTable('nf')">
                <select class="filter-input" id="filterStatusNF" onchange="filterTable('nf')">
                  <option value="">Todos os Status</option>
                  <option value="PENDENTE">Pendente</option>
                  <option value="ENVIADA">Enviada</option>
                  <option value="EM_RECEBIMENTO">Em Recebimento</option>
                  <option value="RECEBIDA">Recebida</option>
                  <option value="CONFERIDA">Conferida</option>
                  <option value="ATESTADA">Atestada</option>
                  <option value="APROVADO">Aprovado</option>
                  <option value="GLOSADO">Glosado</option>
                  <option value="REJEITADO">Rejeitado</option>
                </select>
                <button class="btn btn-secondary" onclick="loadNotasFiscais()" title="Sincronizar e atualizar dados">
                  <span class="material-symbols-outlined">sync</span>
                  Atualizar
                </button>
                <button class="btn btn-secondary" onclick="diagnosticarNFs()" title="Diagnosticar problema"
                  style="margin-left:4px;">
                  <span class="material-symbols-outlined">bug_report</span>
                </button>
                <button class="btn btn-primary" onclick="openModal('nova-nf')">
                  <span class="material-symbols-outlined">add</span>
                  Nova NF
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>N√∫mero NF</th>
                      <th>Fornecedor</th>
                      <th>Produto</th>
                      <th>Qtd</th>
                      <th>Valor Total</th>
                      <th>Status</th>
                      <th>A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="tableNotasFiscais">
                    <tr>
                      <td colspan="7" style="text-align:center;color:var(--text-muted);">Carregando...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Entregas Page -->
        <section id="page-entregas" class="page-section" aria-label="Entregas">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Entregas</h2>
              <div class="filters">
                <input type="text" class="filter-input" placeholder="Buscar entrega..." id="searchEntrega">
                <button class="btn btn-primary" onclick="openModal('nova-entrega')">
                  <span class="material-symbols-outlined">add</span>
                  Nova Entrega
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Fornecedor</th>
                      <th>Escola</th>
                      <th>Produto</th>
                      <th>Quantidade</th>
                      <th>Status</th>
                      <th>A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="tableEntregas">
                    <tr>
                      <td colspan="7" style="text-align:center;color:var(--text-muted);">Carregando...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Recusas Page -->
        <section id="page-recusas" class="page-section" aria-label="Recusas">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Recusas</h2>
              <div class="filters">
                <input type="text" class="filter-input" placeholder="Buscar recusa..." id="searchRecusa">
                <button class="btn btn-primary" onclick="openModal('nova-recusa')">
                  <span class="material-symbols-outlined">add</span>
                  Nova Recusa
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Escola</th>
                      <th>Fornecedor</th>
                      <th>Produto</th>
                      <th>Motivo</th>
                      <th>Status</th>
                      <th>A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="tableRecusas">
                    <tr>
                      <td colspan="7" style="text-align:center;color:var(--text-muted);">Carregando...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Glosas Page -->
        <section id="page-glosas" class="page-section" aria-label="Glosas">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Glosas</h2>
              <div class="filters">
                <input type="text" class="filter-input" placeholder="Buscar glosa..." id="searchGlosa">
                <button class="btn btn-primary" onclick="openModal('nova-glosa')">
                  <span class="material-symbols-outlined">add</span>
                  Nova Glosa
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>NF</th>
                      <th>Fornecedor</th>
                      <th>Valor</th>
                      <th>Motivo</th>
                      <th>Status</th>
                      <th>A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="tableGlosas">
                    <tr>
                      <td colspan="7" style="text-align:center;color:var(--text-muted);">Carregando...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Alunos Especiais Page -->
        <section id="page-alunos" class="page-section" aria-label="Alunos com Necessidades Especiais">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Alunos com Necessidades Alimentares Especiais</h2>
              <button class="btn btn-primary" onclick="showModalCadastroAluno()">
                <span class="material-symbols-outlined">add</span> Novo Aluno
              </button>
            </div>
            <div class="card-body">
              <div class="table-filters" style="margin-bottom:16px;">
                <input type="text" id="searchAlunos" class="form-control"
                  placeholder="Buscar por nome, escola ou patologia..." oninput="filtrarAlunos()"
                  style="max-width:400px;">
                <select id="filterPatologia" class="form-control" onchange="filtrarAlunos()" style="max-width:220px;">
                  <option value="">Todas as necessidades</option>
                  <optgroup label="üè• Patologias M√©dicas">
                    <option value="DIABETES">ü©∫ Diabetes</option>
                    <option value="DOENCA_CELIACA">üåæ Doen√ßa Cel√≠aca</option>
                    <option value="INTOLERANCIA_LACTOSE">ü•õ Intoler√¢ncia √† Lactose</option>
                    <option value="APLV">üßÄ APLV</option>
                    <option value="ALERGIA_OVO">ü•ö Alergia a Ovo</option>
                    <option value="ALERGIA_AMENDOIM">ü•ú Alergia a Amendoim</option>
                    <option value="ALERGIA_CASTANHAS">üå∞ Alergia a Castanhas</option>
                    <option value="ALERGIA_FRUTOS_MAR">ü¶ê Alergia a Frutos do Mar</option>
                    <option value="FENILCETONURIA">üß¨ Fenilceton√∫ria</option>
                    <option value="DISFAGIA">üçΩÔ∏è Disfagia</option>
                    <option value="HIPERTENSAO">üßÇ Hipertens√£o</option>
                  </optgroup>
                  <optgroup label="üå± Dietas por Escolha">
                    <option value="VEGANO">üå± Vegano</option>
                    <option value="VEGETARIANO">ü•¨ Vegetariano</option>
                    <option value="OVOLACTOVEGETARIANO">ü•ö Ovolactovegetariano</option>
                    <option value="PESCETARIANO">üêü Pescetariano</option>
                  </optgroup>
                  <optgroup label="üìã Outras">
                    <option value="OUTRAS">Outras necessidades</option>
                  </optgroup>
                </select>
              </div>
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Nome do Aluno</th>
                      <th>Unidade Escolar</th>
                      <th>Patologia</th>
                      <th>Validade Laudo</th>
                      <th>Status</th>
                      <th>A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="tableAlunos">
                    <tr>
                      <td colspan="6" style="text-align:center;">
                        <div class="spinner" style="margin:20px auto;"></div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Alertas de Laudos Vencendo -->
          <div class="card" style="margin-top:24px;">
            <div class="card-header">
              <h2 class="card-title">‚ö†Ô∏è Laudos Vencendo (pr√≥ximos 30 dias)</h2>
            </div>
            <div class="card-body">
              <div id="alertasLaudos" class="empty-state">
                <div class="icon">‚úÖ</div>
                <h3>Nenhum laudo pr√≥ximo do vencimento</h3>
              </div>
            </div>
          </div>
        </section>

        <!-- Card√°pios Page -->
        <section id="page-cardapios" class="page-section" aria-label="Card√°pios Especiais">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Card√°pios Especiais</h2>
              <button class="btn btn-primary" onclick="showModalGerarCardapio()">
                <span class="material-symbols-outlined">add</span> Gerar Card√°pio
              </button>
            </div>
            <div class="card-body">
              <p style="margin-bottom:16px;color:#666;font-size:14px;">Clique para gerar card√°pio por necessidade:</p>
              <div class="quick-actions" style="margin-bottom:24px;">
                <div class="action-card" onclick="gerarCardapioPatologia('DIABETES')">
                  <div class="icon">ü©∫</div>
                  <h3>Diabetes</h3>
                  <p>Card√°pio sem a√ß√∫car</p>
                </div>
                <div class="action-card" onclick="gerarCardapioPatologia('DOENCA_CELIACA')">
                  <div class="icon">üåæ</div>
                  <h3>Doen√ßa Cel√≠aca</h3>
                  <p>Card√°pio sem gl√∫ten</p>
                </div>
                <div class="action-card" onclick="gerarCardapioPatologia('INTOLERANCIA_LACTOSE')">
                  <div class="icon">ü•õ</div>
                  <h3>Intoler√¢ncia √† Lactose</h3>
                  <p>Card√°pio sem lactose</p>
                </div>
                <div class="action-card" onclick="gerarCardapioPatologia('APLV')">
                  <div class="icon">üßÄ</div>
                  <h3>APLV</h3>
                  <p>Sem prote√≠na do leite</p>
                </div>
                <div class="action-card" onclick="gerarCardapioPatologia('VEGANO')" style="border-color:#22c55e;">
                  <div class="icon">üå±</div>
                  <h3>Vegano</h3>
                  <p>100% vegetal</p>
                </div>
                <div class="action-card" onclick="gerarCardapioPatologia('VEGETARIANO')" style="border-color:#84cc16;">
                  <div class="icon">ü•¨</div>
                  <h3>Vegetariano</h3>
                  <p>Sem carnes</p>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Aluno</th>
                      <th>Patologia</th>
                      <th>Data Gera√ß√£o</th>
                      <th>Status</th>
                      <th>A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="tableCardapios">
                    <tr>
                      <td colspan="6" style="text-align:center;">
                        <div class="spinner" style="margin:20px auto;"></div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Relat√≥rios Page -->
        <section id="page-relatorios" class="page-section" aria-label="Relat√≥rios">
          <div class="card" style="margin-bottom:24px;">
            <div class="card-header">
              <h2 class="card-title">An√°lises e Relat√≥rios</h2>
            </div>
            <div class="card-body">
              <!-- Se√ß√£o: An√°lises Operacionais -->
              <h3
                style="font-size:14px;color:var(--text-secondary);margin:0 0 12px 0;text-transform:uppercase;letter-spacing:1px;">
                üì¶ Operacional</h3>
              <div class="quick-actions" style="margin-bottom:24px;">
                <div class="action-card" onclick="runAnalysis('irregularidades')">
                  <div class="icon">üîç</div>
                  <h3>Verificar Irregularidades</h3>
                  <p>An√°lise de conformidade</p>
                </div>
                <div class="action-card" onclick="runAnalysis('tendencias')">
                  <div class="icon">üìà</div>
                  <h3>Identificar Tend√™ncias</h3>
                  <p>An√°lise textual e insights</p>
                </div>
                <div class="action-card" onclick="generateReport('mensal')">
                  <div class="icon">üìä</div>
                  <h3>Relat√≥rio Mensal</h3>
                  <p>Tabelas e rankings</p>
                </div>
                <div class="action-card" onclick="generateReport('fornecedor')">
                  <div class="icon">üè¢</div>
                  <h3>Por Fornecedor</h3>
                  <p>Selecione e analise</p>
                </div>
              </div>

              <!-- Se√ß√£o: Nutri√ß√£o e Alunos Especiais -->
              <h3
                style="font-size:14px;color:var(--text-secondary);margin:0 0 12px 0;text-transform:uppercase;letter-spacing:1px;">
                ü•ó Nutri√ß√£o & Alunos Especiais</h3>
              <div class="quick-actions" style="margin-bottom:24px;">
                <div class="action-card" onclick="runAnalysis('alunos-especiais')">
                  <div class="icon">üë§</div>
                  <h3>Alunos Especiais</h3>
                  <p>Necessidades alimentares</p>
                </div>
                <div class="action-card" onclick="runAnalysis('laudos')">
                  <div class="icon">üìã</div>
                  <h3>Laudos M√©dicos</h3>
                  <p>Vencimentos e pend√™ncias</p>
                </div>
                <div class="action-card" onclick="runAnalysis('cardapios')">
                  <div class="icon">üçΩÔ∏è</div>
                  <h3>Card√°pios Especiais</h3>
                  <p>Adapta√ß√µes por patologia</p>
                </div>
                <div class="action-card" onclick="runAnalysis('nutricional')">
                  <div class="icon">ü•¶</div>
                  <h3>An√°lise Nutricional</h3>
                  <p>Grupos alimentares</p>
                </div>
              </div>

              <!-- Se√ß√£o: An√°lise com IA -->
              <h3
                style="font-size:14px;color:var(--text-secondary);margin:0 0 12px 0;text-transform:uppercase;letter-spacing:1px;">
                ü§ñ Intelig√™ncia Artificial</h3>
              <div class="quick-actions" style="margin-bottom:0;">
                <div class="action-card" onclick="runAnalysis('ia-geral')"
                  style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                  <div class="icon">üß†</div>
                  <h3 style="color:white;">An√°lise Geral com IA</h3>
                  <p style="color:rgba(255,255,255,0.8);">Gemini analisa todos os dados</p>
                </div>
                <div class="action-card" onclick="runAnalysis('ia-nutricao')"
                  style="background:linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                  <div class="icon">ü•ó</div>
                  <h3 style="color:white;">IA Nutricional</h3>
                  <p style="color:rgba(255,255,255,0.8);">Recomenda√ß√µes de card√°pio</p>
                </div>
                <div class="action-card" onclick="runAnalysis('ia-previsao')"
                  style="background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                  <div class="icon">üîÆ</div>
                  <h3 style="color:white;">Previs√£o de Demanda</h3>
                  <p style="color:rgba(255,255,255,0.8);">Proje√ß√µes inteligentes</p>
                </div>
                <div class="action-card" onclick="runAnalysis('ia-alertas')"
                  style="background:linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                  <div class="icon">‚ö°</div>
                  <h3 style="color:white;">Alertas Inteligentes</h3>
                  <p style="color:rgba(255,255,255,0.8);">Riscos e oportunidades</p>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Resultados da An√°lise</h2>
            </div>
            <div class="card-body">
              <div id="analysisResults" class="empty-state">
                <div class="icon">üìã</div>
                <h3>Nenhuma an√°lise executada</h3>
                <p>Selecione uma das op√ß√µes acima para gerar relat√≥rios</p>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitleText">T√≠tulo</h2>
        <button class="modal-close" onclick="closeModal()" aria-label="Fechar">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer" id="modalFooter"></div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container" aria-live="polite"></div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">Carregando...</div>
  </div>

  <script>
    // ============================================
    // ESTADO GLOBAL
    // ============================================
    const state = {
      user: null,
      currentPage: 'dashboard',
      data: { nfs: [], entregas: [], recusas: [], glosas: [] }
    };

    // ============================================
    // INICIALIZA√á√ÉO
    // ============================================
    document.addEventListener('DOMContentLoaded', init);

    function init() {
      checkSession();
      setupKeyboardNav();
    }

    function checkSession() {
      google.script.run
        .withSuccessHandler(function (result) {
          if (result && result.success && result.session) {
            state.user = result.session;
            showMainApp();
            loadDashboardData();
          } else {
            showLoginScreen();
          }
        })
        .withFailureHandler(function () {
          showLoginScreen();
        })
        .api_auth_getSession();
    }

    function showLoginScreen() {
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainApp').style.display = 'none';
    }

    function showMainApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'flex';
      updateUserInfo();
    }

    function updateUserInfo() {
      if (state.user) {
        const nome = state.user.nome || 'Usu√°rio';
        document.getElementById('userName').textContent = nome.split(' ')[0];
        document.getElementById('userRole').textContent = state.user.tipo || 'Analista';
        document.getElementById('userAvatar').textContent = nome.charAt(0).toUpperCase();
      }
    }

    // ============================================
    // AUTENTICA√á√ÉO
    // ============================================
    function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const senha = document.getElementById('loginSenha').value;

      showLoading('Entrando...');

      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          if (result && result.success) {
            state.user = result.session;
            showMainApp();
            loadDashboardData();
            toast('Bem-vindo(a), ' + (result.session.nome || 'Usu√°rio').split(' ')[0] + '!', 'success');
          } else {
            showLoginAlert(result.error || 'Credenciais inv√°lidas', 'error');
          }
        })
        .withFailureHandler(function (error) {
          hideLoading();
          showLoginAlert('Erro ao conectar: ' + error.message, 'error');
        })
        .api_auth_login(email, senha);
    }

    function handleLogout() {
      showLoading('Saindo...');
      google.script.run
        .withSuccessHandler(function () {
          hideLoading();
          state.user = null;
          showLoginScreen();
          toast('Voc√™ saiu do sistema', 'info');
        })
        .withFailureHandler(function () {
          hideLoading();
          showLoginScreen();
        })
        .api_auth_logout();
    }

    function showLoginAlert(message, type) {
      const alert = document.getElementById('loginAlert');
      alert.innerHTML = '<div class="alert alert-' + type + '" style="padding:12px;border-radius:8px;margin-bottom:16px;background:' +
        (type === 'error' ? 'var(--error-light)' : 'var(--success-light)') + ';color:' +
        (type === 'error' ? '#991b1b' : '#065f46') + ';">' + message + '</div>';
      alert.style.display = 'block';
    }

    function showRegisterForm() {
      openModal('register');
    }

    // ============================================
    // NAVEGA√á√ÉO
    // ============================================
    function navigateTo(page) {
      event.preventDefault();
      state.currentPage = page;

      // Update nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.page === page);
      });

      // Update page sections
      document.querySelectorAll('.page-section').forEach(section => {
        section.classList.toggle('active', section.id === 'page-' + page);
      });

      // Update page title
      const titles = {
        dashboard: 'Dashboard',
        notas: 'Notas Fiscais',
        entregas: 'Entregas',
        recusas: 'Recusas',
        glosas: 'Glosas',
        alunos: 'Alunos com Necessidades Especiais',
        cardapios: 'Card√°pios Especiais',
        relatorios: 'Relat√≥rios'
      };
      document.getElementById('pageTitle').textContent = titles[page] || 'Dashboard';

      // Load page data
      loadPageData(page);

      // Close sidebar on mobile
      if (window.innerWidth <= 1024) {
        toggleSidebar(false);
      }
    }

    function loadPageData(page) {
      switch (page) {
        case 'dashboard': loadDashboardData(); break;
        case 'notas': loadNotasFiscais(); break;
        case 'entregas': loadEntregas(); break;
        case 'recusas': loadRecusas(); break;
        case 'glosas': loadGlosas(); break;
        case 'alunos': loadAlunos(); break;
        case 'cardapios': loadCardapios(); break;
      }
    }

    function toggleSidebar(forceState) {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      const isOpen = forceState !== undefined ? forceState : !sidebar.classList.contains('open');

      sidebar.classList.toggle('open', isOpen);
      overlay.classList.toggle('active', isOpen);
    }

    function setupKeyboardNav() {
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          closeModal();
          toggleSidebar(false);
        }
      });

      // Action cards keyboard support
      document.querySelectorAll('.action-card').forEach(card => {
        card.addEventListener('keypress', function (e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.click();
          }
        });
      });
    }

    // ============================================
    // CARREGAR DADOS
    // ============================================
    // FUN√á√ïES DE CARREGAMENTO DE DADOS (usando APIs unificadas)
    // ============================================
    function loadDashboardData() {
      console.log('loadDashboardData: Carregando m√©tricas...');
      google.script.run
        .withSuccessHandler(function (result) {
          console.log('Dashboard metrics:', result);
          if (result && result.success) {
            const d = result.data || {};
            document.getElementById('statNFs').textContent = d.nfs || d.notasFiscais || 0;
            document.getElementById('statEntregas').textContent = d.entregas || 0;
            document.getElementById('statPendentes').textContent = d.pendentes || 0;
            document.getElementById('statProblemas').textContent = d.problemas || ((d.recusas || 0) + (d.glosas || 0));

            // Atualiza badge com total de NFs
            const totalNFs = d.nfs || d.notasFiscais || 0;
            if (totalNFs > 0) {
              document.getElementById('badgeNFs').textContent = totalNFs;
              document.getElementById('badgeNFs').style.display = 'inline';
            } else {
              document.getElementById('badgeNFs').style.display = 'none';
            }
          }
        })
        .withFailureHandler(function (e) {
          console.error('Erro getDashboardMetrics:', e);
          handleError(e);
        })
        .getDashboardMetricsUnificado();

      loadRecentActivity();
    }

    function loadRecentActivity() {
      console.log('loadRecentActivity: Carregando atividade recente...');
      google.script.run
        .withSuccessHandler(function (result) {
          console.log('Recent activity:', result);
          const tbody = document.getElementById('recentActivityTable');
          if (result && result.success && result.data && result.data.length > 0) {
            tbody.innerHTML = result.data.slice(0, 5).map(function (item) {
              const statusClass = getStatusClass(item.status || item.Status_NF || item.Status);
              return '<tr>' +
                '<td><strong>' + (item.numero_nf || item.Numero_NF || item['Nota Fiscal'] || '-') + '</strong></td>' +
                '<td>' + (item.fornecedor || item.Fornecedor_Nome || item.Fornecedor || '-') + '</td>' +
                '<td>R$ ' + formatNumber(item.valor_total || item.Valor_Total || item['Valor Total'] || 0) + '</td>' +
                '<td><span class="badge ' + statusClass + '">' + (item.status || item.Status_NF || item.Status || 'Pendente') + '</span></td>' +
                '<td>' + formatDate(item.data_emissao || item.Data_Emissao || item['Data Emiss√£o']) + '</td>' +
                '</tr>';
            }).join('');
          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state" style="padding:40px;"><div class="icon">üìã</div><h3>Nenhuma nota fiscal</h3><p>Cadastre sua primeira NF</p></td></tr>';
          }
        })
        .withFailureHandler(function (e) {
          console.error('Erro loadRecentActivity:', e);
          document.getElementById('recentActivityTable').innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);">Erro ao carregar dados</td></tr>';
        })
        .listNotasFiscaisUnificado(5);
    }

    function loadNotasFiscais() {
      console.log('loadNotasFiscais: Carregando notas fiscais...');
      const tbody = document.getElementById('tableNotasFiscais');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;"><div class="spinner" style="margin:20px auto;"></div><p style="margin-top:10px;color:var(--text-muted);">Carregando dados...</p></td></tr>';

      // Usa a API unificada diretamente (j√° consolida todas as fontes)
      google.script.run
        .withSuccessHandler(function (result) {
          console.log('listNotasFiscaisUnificado result:', result);
          if (result && result.success && result.data && result.data.length > 0) {
            state.data.nfs = result.data;
            renderNotasFiscais(result.data);
          } else {
            tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="icon">üìã</div><h3>Nenhuma nota fiscal</h3><p>Clique em "Nova NF" para cadastrar</p></div></td></tr>';
          }
        })
        .withFailureHandler(function (e) {
          console.error('Erro loadNotasFiscais:', e);
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--error);">Erro: ' + (e.message || e) + '</td></tr>';
        })
        .listNotasFiscaisUnificado(100);
    }

    function renderNotasFiscais(data) {
      const tbody = document.getElementById('tableNotasFiscais');
      tbody.innerHTML = data.map(function (item) {
        // Usar campos normalizados (min√∫sculos com underscore) ou fallback para formatos antigos
        const numeroNF = item.numero_nf || item.Numero_NF || item['Nota Fiscal'] || item.numero || item.id || '-';
        const fornecedor = item.fornecedor || item.Fornecedor_Nome || item.Fornecedor || '-';
        const produto = item.produto || item.Produto || '-';
        const quantidade = item.quantidade || item.Quantidade || 0;
        const unidade = item.unidade || item.Unidade || '';
        const valorTotal = item.valor_total || item.Valor_Total || item['Valor Total'] || 0;
        const status = item.status || item.Status_NF || item.Status || 'PENDENTE';
        const statusClass = getStatusClass(status);

        return '<tr>' +
          '<td><strong>' + numeroNF + '</strong></td>' +
          '<td>' + fornecedor + '</td>' +
          '<td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="' + produto + '">' + produto + '</td>' +
          '<td>' + quantidade + ' ' + unidade + '</td>' +
          '<td>R$ ' + formatNumber(valorTotal) + '</td>' +
          '<td><span class="badge ' + statusClass + '">' + status + '</span></td>' +
          '<td>' +
          '<button class="btn btn-sm btn-secondary" onclick="viewItem(\'nf\', \'' + item.id + '\')" title="Ver detalhes"><span class="material-symbols-outlined" style="font-size:18px;">visibility</span></button> ' +
          '<button class="btn btn-sm btn-danger" onclick="deleteItem(\'nf\', ' + item.rowIndex + ')" title="Excluir"><span class="material-symbols-outlined" style="font-size:18px;">delete</span></button>' +
          '</td>' +
          '</tr>';
      }).join('');
    }

    function diagnosticarNFs() {
      console.log('Executando diagn√≥stico de NFs...');
      google.script.run
        .withSuccessHandler(function (result) {
          console.log('=== DIAGN√ìSTICO ===', result);

          // Prote√ß√£o contra null
          if (!result) {
            alert('ERRO: A fun√ß√£o de diagn√≥stico retornou null.\n\nIsso pode significar:\n1. Erro no backend (verifique os logs do Apps Script)\n2. Problema de permiss√£o\n3. Timeout na execu√ß√£o\n\nVerifique o console do navegador e os logs do Apps Script.');
            return;
          }

          var msg = 'DIAGN√ìSTICO DE NOTAS FISCAIS\n\n';
          msg += 'Sheets encontradas: ' + (result.sheetsEncontradas || 0) + '\n';
          msg += 'Total linhas de dados: ' + (result.totalLinhas || 0) + '\n\n';

          if (result.sheets && result.sheets.length > 0) {
            msg += 'ABAS RELACIONADAS:\n';
            result.sheets.forEach(function (s) {
              msg += '‚Ä¢ ' + s.nome + ' (' + s.linhas + ' linhas)' + (s.ehCandidataNF ? ' ‚úì' : '') + '\n';
            });
            msg += '\n';
          }

          if (result.apiTest) {
            msg += 'TESTE DA API:\n';
            msg += '‚Ä¢ Success: ' + result.apiTest.success + '\n';
            msg += '‚Ä¢ Registros: ' + result.apiTest.dataLength + '\n';
            if (result.apiTest.error) {
              msg += '‚Ä¢ Erro: ' + result.apiTest.error + '\n';
            }
            msg += '\n';
          }

          if (result.erro) {
            msg += '‚ùå ERRO: ' + result.erro + '\n';
          } else if (result.problema) {
            msg += '‚ö†Ô∏è PROBLEMA: ' + result.problema + '\n';
            msg += 'üí° RECOMENDA√á√ÉO: ' + result.recomendacao + '\n';
          } else {
            msg += '‚úÖ Nenhum problema detectado!\n';
          }

          alert(msg);
        })
        .withFailureHandler(function (e) {
          console.error('Erro no diagn√≥stico:', e);
          alert('Erro ao executar diagn√≥stico: ' + (e.message || e));
        })
        .diagnosticarNotasFiscais();
    }

    function loadEntregas() {
      console.log('loadEntregas: Carregando entregas...');
      const tbody = document.getElementById('tableEntregas');
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;"><div class="spinner" style="margin:20px auto;"></div></td></tr>';

      google.script.run
        .withSuccessHandler(function (result) {
          console.log('listEntregasUnificado result:', result);
          if (result && result.success && result.data && result.data.length > 0) {
            state.data.entregas = result.data;
            renderEntregas(result.data);
          } else {
            tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="icon">üöö</div><h3>Nenhuma entrega</h3><p>Registre a primeira entrega</p></div></td></tr>';
          }
        })
        .withFailureHandler(function (e) {
          console.error('Erro loadEntregas:', e);
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--error);">Erro: ' + (e.message || e) + '</td></tr>';
        })
        .listEntregasUnificado(100);
    }

    function renderEntregas(data) {
      const tbody = document.getElementById('tableEntregas');
      tbody.innerHTML = data.map(function (item) {
        // Usar campos normalizados ou fallback
        const dataEntrega = item.data_entrega || item.Data_Entrega || item['Data Entrega'];
        const fornecedor = item.fornecedor || item.Fornecedor_Nome || item.Fornecedor || '-';
        const escola = item.unidade_escolar || item.Unidade_Escolar || item['Unidade Escolar'] || '-';
        const produto = item.produto || item.Produto_Descricao || item.Produto_Nome || item.Produto || '-';
        const quantidade = item.quantidade || item.Quantidade_Entregue || item['Quantidade Entregue'] || '-';
        const status = item.status || item.Status_Entrega || item.Status || '-';
        const statusClass = getStatusClass(status);

        return '<tr>' +
          '<td>' + formatDate(dataEntrega) + '</td>' +
          '<td>' + fornecedor + '</td>' +
          '<td>' + escola + '</td>' +
          '<td>' + produto + '</td>' +
          '<td>' + quantidade + '</td>' +
          '<td><span class="badge ' + statusClass + '">' + status + '</span></td>' +
          '<td><button class="btn btn-sm btn-danger" onclick="deleteItem(\'entrega\', ' + item.rowIndex + ')"><span class="material-symbols-outlined" style="font-size:18px;">delete</span></button></td>' +
          '</tr>';
      }).join('');
    }

    function loadRecusas() {
      console.log('loadRecusas: Carregando recusas...');
      const tbody = document.getElementById('tableRecusas');
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;"><div class="spinner" style="margin:20px auto;"></div></td></tr>';

      google.script.run
        .withSuccessHandler(function (result) {
          console.log('listRecusasUnificado result:', result);
          if (result && result.success && result.data && result.data.length > 0) {
            state.data.recusas = result.data;
            renderRecusas(result.data);
          } else {
            tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="icon">‚ùå</div><h3>Nenhuma recusa</h3><p>Nenhum registro de recusa</p></div></td></tr>';
          }
        })
        .withFailureHandler(function (e) {
          console.error('Erro loadRecusas:', e);
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--error);">Erro: ' + (e.message || e) + '</td></tr>';
        })
        .listRecusasUnificado(100);
    }

    function renderRecusas(data) {
      const tbody = document.getElementById('tableRecusas');
      tbody.innerHTML = data.map(function (item) {
        // Usar campos normalizados ou fallback
        const dataRecusa = item.data_recusa || item.Data_Recusa || item['Data Recusa'];
        const escola = item.escola || item.Unidade_Escolar || item['Unidade Escolar'] || '-';
        const fornecedor = item.fornecedor || item.Fornecedor_Nome || item.Fornecedor || '-';
        const produto = item.produto || item.Produto_Nome || item.Produto || '-';
        const motivo = item.motivo || item.Motivo_Recusa || item.Motivo || '-';
        const status = item.status || item.Status || 'Pendente';

        return '<tr>' +
          '<td>' + formatDate(dataRecusa) + '</td>' +
          '<td>' + escola + '</td>' +
          '<td>' + fornecedor + '</td>' +
          '<td>' + produto + '</td>' +
          '<td>' + motivo + '</td>' +
          '<td><span class="badge badge-warning">' + status + '</span></td>' +
          '<td><button class="btn btn-sm btn-danger" onclick="deleteItem(\'recusa\', ' + item.rowIndex + ')"><span class="material-symbols-outlined" style="font-size:18px;">delete</span></button></td>' +
          '</tr>';
      }).join('');
    }

    function loadGlosas() {
      console.log('loadGlosas: Carregando glosas...');
      const tbody = document.getElementById('tableGlosas');
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;"><div class="spinner" style="margin:20px auto;"></div></td></tr>';

      google.script.run
        .withSuccessHandler(function (result) {
          console.log('listGlosasUnificado result:', result);
          if (result && result.success && result.data && result.data.length > 0) {
            state.data.glosas = result.data;
            renderGlosas(result.data);
          } else {
            tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="icon">üí∞</div><h3>Nenhuma glosa</h3><p>Nenhum registro de glosa</p></div></td></tr>';
          }
        })
        .withFailureHandler(function (e) {
          console.error('Erro loadGlosas:', e);
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--error);">Erro: ' + (e.message || e) + '</td></tr>';
        })
        .listGlosasUnificado(100);
    }

    function renderGlosas(data) {
      const tbody = document.getElementById('tableGlosas');
      tbody.innerHTML = data.map(function (item) {
        // Usar campos normalizados ou fallback
        const dataGlosa = item.data_glosa || item.Data_Glosa || item['Data Registro'];
        const nf = item.nota_fiscal_id || item.Numero_NF || item.NF || '-';
        const fornecedor = item.fornecedor || item.Fornecedor_Nome || item.Fornecedor || '-';
        const valor = item.valor || item.Valor_Glosado || item.Valor_Glosa || item['Valor Total Glosa'] || 0;
        const motivo = item.motivo || item.Motivo_Glosa || item.Motivo || '-';
        const status = item.status || item.Status_Glosa || item.Status || 'Aplicada';

        return '<tr>' +
          '<td>' + formatDate(dataGlosa) + '</td>' +
          '<td>' + nf + '</td>' +
          '<td>' + fornecedor + '</td>' +
          '<td>R$ ' + formatNumber(valor) + '</td>' +
          '<td>' + motivo + '</td>' +
          '<td><span class="badge badge-error">' + status + '</span></td>' +
          '<td><button class="btn btn-sm btn-danger" onclick="deleteItem(\'glosa\', ' + item.rowIndex + ')"><span class="material-symbols-outlined" style="font-size:18px;">delete</span></button></td>' +
          '</tr>';
      }).join('');
    }

    function refreshData() {
      loadPageData(state.currentPage);
      toast('Dados atualizados', 'success');
    }

    // ============================================
    // ALUNOS COM NECESSIDADES ESPECIAIS
    // ============================================
    function loadAlunos() {
      console.log('loadAlunos: Carregando alunos...');
      const tbody = document.getElementById('tableAlunos');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;"><div class="spinner" style="margin:20px auto;"></div></td></tr>';

      google.script.run
        .withSuccessHandler(function (result) {
          console.log('listAlunosEspeciaisUnificado result:', result);
          if (result && result.success && result.data && result.data.length > 0) {
            state.data.alunos = result.data;
            renderAlunos(result.data);
            loadLaudosVencendo();
          } else {
            tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="icon">üë®‚Äçüéì</div><h3>Nenhum aluno cadastrado</h3><p>Clique em "Novo Aluno" para cadastrar</p></div></td></tr>';
            document.getElementById('alertasLaudos').innerHTML = '<div class="empty-state"><div class="icon">‚úÖ</div><h3>Nenhum laudo pr√≥ximo do vencimento</h3></div>';
          }
        })
        .withFailureHandler(function (e) {
          console.error('Erro loadAlunos:', e);
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--error);">Erro: ' + (e.message || e) + '</td></tr>';
        })
        .listAlunosEspeciaisUnificado(100);
    }

    function renderAlunos(data) {
      const tbody = document.getElementById('tableAlunos');
      tbody.innerHTML = data.map(function (item) {
        // Usar campos normalizados ou fallback para formatos antigos
        const nome = item.nome || item.nomeCompleto || item.Nome_Completo || '-';
        const escola = item.escola || item.unidadeEscolar || item.Unidade_Escolar || '-';
        const patologia = item.patologia || item.patologiaPrincipal || item.Patologia_Dieta || '-';
        const validade = item.validade_laudo || item.validadeLaudo || item.Validade_Laudo;
        const status = item.status || item.Status || 'ATIVO';

        const statusClass = status === 'ATIVO' ? 'badge-success' : 'badge-warning';
        const validadeLaudo = validade ? formatDate(validade) : '-';
        const diasRestantes = validade ? calcularDiasRestantes(validade) : null;
        const laudoClass = diasRestantes !== null && diasRestantes <= 30 ? 'color:var(--error);font-weight:600;' : '';

        return '<tr>' +
          '<td><strong>' + nome + '</strong></td>' +
          '<td>' + escola + '</td>' +
          '<td>' + formatPatologia(patologia) + '</td>' +
          '<td style="' + laudoClass + '">' + validadeLaudo + (diasRestantes !== null && diasRestantes <= 30 ? ' ‚ö†Ô∏è' : '') + '</td>' +
          '<td><span class="badge ' + statusClass + '">' + status + '</span></td>' +
          '<td>' +
          '<button class="btn btn-sm btn-secondary" onclick="viewAluno(\'' + (item.id || item.rowIndex) + '\')" title="Ver detalhes"><span class="material-symbols-outlined" style="font-size:18px;">visibility</span></button> ' +
          '<button class="btn btn-sm btn-primary" onclick="gerarCardapioAluno(\'' + (item.id || item.rowIndex) + '\')" title="Gerar card√°pio"><span class="material-symbols-outlined" style="font-size:18px;">restaurant_menu</span></button> ' +
          '<button class="btn btn-sm btn-danger" onclick="deleteAluno(\'' + (item.id || item.rowIndex) + '\')" title="Excluir"><span class="material-symbols-outlined" style="font-size:18px;">delete</span></button>' +
          '</td>' +
          '</tr>';
      }).join('');
    }

    function loadLaudosVencendo() {
      console.log('loadLaudosVencendo: Carregando laudos vencendo...');
      google.script.run
        .withSuccessHandler(function (result) {
          console.log('listLaudosVencendoUnificado result:', result);
          const container = document.getElementById('alertasLaudos');
          if (result && result.success && result.data && result.data.length > 0) {
            container.innerHTML = '<div class="table-responsive"><table class="table"><thead><tr><th>Aluno</th><th>Escola</th><th>Validade</th><th>Dias Restantes</th></tr></thead><tbody>' +
              result.data.map(function (item) {
                const validade = item.validade_laudo || item.validadeLaudo;
                const dias = calcularDiasRestantes(validade);
                const corDias = dias <= 7 ? 'var(--error)' : dias <= 15 ? 'var(--warning)' : 'var(--text)';
                return '<tr><td>' + (item.nome || item.nomeCompleto || '-') + '</td><td>' + (item.escola || item.unidadeEscolar || '-') + '</td><td>' + formatDate(validade) + '</td><td style="color:' + corDias + ';font-weight:600;">' + dias + ' dias</td></tr>';
              }).join('') +
              '</tbody></table></div>';
          } else {
            container.innerHTML = '<div class="empty-state"><div class="icon">‚úÖ</div><h3>Nenhum laudo pr√≥ximo do vencimento</h3></div>';
          }
        })
        .withFailureHandler(function (e) {
          console.error('Erro loadLaudosVencendo:', e);
        })
        .listLaudosVencendoUnificado(30);
    }

    function filtrarAlunos() {
      const search = document.getElementById('searchAlunos').value.toLowerCase();
      const patologia = document.getElementById('filterPatologia').value;

      if (!state.data.alunos) return;

      const filtered = state.data.alunos.filter(function (a) {
        const matchSearch = !search ||
          (a.nomeCompleto && a.nomeCompleto.toLowerCase().includes(search)) ||
          (a.unidadeEscolar && a.unidadeEscolar.toLowerCase().includes(search));
        const matchPatologia = !patologia || a.patologiaPrincipal === patologia;
        return matchSearch && matchPatologia;
      });

      renderAlunos(filtered);
    }

    function showModalCadastroAluno() {
      openModal('novo-aluno');
    }

    function saveAluno(e) {
      e.preventDefault();
      showLoading('Salvando...');

      const dados = {
        nomeCompleto: document.getElementById('alunoNome').value,
        unidadeEscolar: document.getElementById('alunoEscola').value,
        patologiaPrincipal: document.getElementById('alunoPatologia').value,
        validadeLaudo: document.getElementById('alunoValidadeLaudo').value,
        observacoes: document.getElementById('alunoObs').value
      };

      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          if (result && result.success) {
            closeModal();
            toast('Aluno cadastrado com sucesso!', 'success');
            loadAlunos();
          } else {
            toast(result.error || 'Erro ao cadastrar', 'error');
          }
        })
        .withFailureHandler(function (e) {
          hideLoading();
          toast('Erro: ' + e.message, 'error');
        })
        .cadastrarAlunoNecessidadeEspecial(dados);
    }

    function viewAluno(id) {
      toast('Visualizando aluno ' + id, 'info');
    }

    function gerarCardapioAluno(id) {
      showLoading('Gerando card√°pio...');
      const aluno = state.data.alunos.find(a => a.id === id);
      if (!aluno) {
        hideLoading();
        toast('Aluno n√£o encontrado', 'error');
        return;
      }

      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          if (result && result.success) {
            toast('Card√°pio gerado com sucesso!', 'success');
            navigateTo('cardapios');
          } else {
            toast(result.error || 'Erro ao gerar card√°pio', 'error');
          }
        })
        .withFailureHandler(function (e) {
          hideLoading();
          toast('Erro: ' + e.message, 'error');
        })
        .gerarCardapioEspecial({ alunoId: id, patologia: aluno.patologiaPrincipal });
    }

    function deleteAluno(id) {
      if (confirm('Deseja realmente excluir este aluno?')) {
        toast('Funcionalidade em desenvolvimento', 'info');
      }
    }

    // ============================================
    // CARD√ÅPIOS ESPECIAIS
    // ============================================
    function loadCardapios() {
      const tbody = document.getElementById('tableCardapios');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;"><div class="spinner" style="margin:20px auto;"></div></td></tr>';

      google.script.run
        .withSuccessHandler(function (result) {
          if (result && result.success && result.data && result.data.length > 0) {
            state.data.cardapios = result.data;
            renderCardapios(result.data);
          } else {
            tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="icon">üçΩÔ∏è</div><h3>Nenhum card√°pio gerado</h3><p>Selecione uma patologia acima ou gere a partir de um aluno</p></div></td></tr>';
          }
        })
        .withFailureHandler(function (e) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--error);">Erro: ' + e.message + '</td></tr>';
        })
        .listarCardapiosEspeciais();
    }

    function renderCardapios(data) {
      const tbody = document.getElementById('tableCardapios');
      tbody.innerHTML = data.map(function (item) {
        const statusClass = item.status === 'ATIVO' ? 'badge-success' : 'badge-secondary';
        return '<tr>' +
          '<td><strong>' + (item.id || '-') + '</strong></td>' +
          '<td>' + (item.alunoNome || '-') + '</td>' +
          '<td>' + formatPatologia(item.patologia) + '</td>' +
          '<td>' + formatDate(item.dataGeracao) + '</td>' +
          '<td><span class="badge ' + statusClass + '">' + (item.status || 'ATIVO') + '</span></td>' +
          '<td>' +
          '<button class="btn btn-sm btn-secondary" onclick="viewCardapio(\'' + item.id + '\')" title="Ver card√°pio"><span class="material-symbols-outlined" style="font-size:18px;">visibility</span></button> ' +
          '<button class="btn btn-sm btn-primary" onclick="imprimirCardapio(\'' + item.id + '\')" title="Imprimir"><span class="material-symbols-outlined" style="font-size:18px;">print</span></button>' +
          '</td>' +
          '</tr>';
      }).join('');
    }

    function showModalGerarCardapio() {
      openModal('gerar-cardapio');
    }

    function gerarCardapioPatologia(patologia) {
      showLoading('Gerando card√°pio para ' + formatPatologia(patologia) + '...');

      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          if (result && result.success) {
            toast('Card√°pio gerado com sucesso!', 'success');
            loadCardapios();
          } else {
            toast(result.error || 'Erro ao gerar card√°pio', 'error');
          }
        })
        .withFailureHandler(function (e) {
          hideLoading();
          toast('Erro: ' + e.message, 'error');
        })
        .gerarCardapioEspecial({ patologia: patologia });
    }

    function viewCardapio(id) {
      toast('Visualizando card√°pio ' + id, 'info');
    }

    function imprimirCardapio(id) {
      toast('Preparando impress√£o...', 'info');
    }

    function saveCardapio(e) {
      e.preventDefault();
      showLoading('Gerando card√°pio...');

      const patologia = document.getElementById('cardapioPatologia').value;
      const periodo = document.getElementById('cardapioPeriodo').value;
      const obs = document.getElementById('cardapioObs').value;

      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          if (result && result.success) {
            closeModal();
            toast('Card√°pio gerado com sucesso!', 'success');
            loadCardapios();
          } else {
            toast(result.error || 'Erro ao gerar card√°pio', 'error');
          }
        })
        .withFailureHandler(function (e) {
          hideLoading();
          toast('Erro: ' + e.message, 'error');
        })
        .gerarCardapioEspecial({ patologia: patologia, periodo: periodo, observacoes: obs });
    }

    function formatPatologia(codigo) {
      const patologias = {
        // Patologias m√©dicas
        'DIABETES': 'ü©∫ Diabetes',
        'DOENCA_CELIACA': 'üåæ Doen√ßa Cel√≠aca',
        'INTOLERANCIA_LACTOSE': 'ü•õ Intoler√¢ncia √† Lactose',
        'APLV': 'üßÄ APLV',
        'ALERGIA_PROTEINA_LEITE': 'üßÄ APLV',
        'ALERGIA_OVO': 'ü•ö Alergia a Ovo',
        'ALERGIA_AMENDOIM': 'ü•ú Alergia a Amendoim',
        'ALERGIA_CASTANHAS': 'üå∞ Alergia a Castanhas',
        'ALERGIA_FRUTOS_MAR': 'ü¶ê Alergia a Frutos do Mar',
        'FENILCETONURIA': 'üß¨ Fenilceton√∫ria',
        'DISFAGIA': 'üçΩÔ∏è Disfagia',
        'HIPERTENSAO': 'üßÇ Hipertens√£o',
        // Dietas por escolha
        'VEGANO': 'üå± Vegano',
        'VEGETARIANO': 'ü•¨ Vegetariano',
        'OVOLACTOVEGETARIANO': 'ü•ö Ovolactovegetariano',
        'PESCETARIANO': 'üêü Pescetariano',
        'OUTRAS': 'Outras'
      };
      return patologias[codigo] || codigo || '-';
    }

    function calcularDiasRestantes(data) {
      if (!data) return null;
      const hoje = new Date();
      const validade = new Date(data);
      const diff = validade - hoje;
      return Math.ceil(diff / (1000 * 60 * 60 * 24));
    }

    // ============================================
    // MODAL E FORMUL√ÅRIOS
    // ============================================
    function openModal(type) {
      const modal = document.getElementById('modal');
      const title = document.getElementById('modalTitleText');
      const body = document.getElementById('modalBody');
      const footer = document.getElementById('modalFooter');

      const forms = {
        'nova-nf': {
          title: 'Nova Nota Fiscal',
          body: `
            <form id="formNF" onsubmit="saveNF(event)">
              <div style="background:var(--info-light);padding:12px;border-radius:var(--radius-md);margin-bottom:16px;border-left:4px solid var(--info);font-size:13px;">
                <strong>üí° Lembre-se:</strong> Cada NF deve conter apenas <strong>um √∫nico g√™nero aliment√≠cio</strong>.
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">N√∫mero da NF *</label>
                  <input type="text" class="form-input" id="nfNumero" required placeholder="Ex: 123456">
                </div>
                <div class="form-group">
                  <label class="form-label">Data Emiss√£o *</label>
                  <input type="date" class="form-input" id="nfData" required value="${today()}">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Fornecedor *</label>
                <input type="text" class="form-input" id="nfFornecedor" required placeholder="Nome do fornecedor">
              </div>
              <div class="form-group">
                <label class="form-label">G√™nero Aliment√≠cio (Produto) *</label>
                <input type="text" class="form-input" id="nfProduto" required placeholder="Ex: Arroz Tipo 1, Feij√£o Carioca, Leite Integral">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Quantidade Total *</label>
                  <input type="number" class="form-input" id="nfQuantidade" step="0.01" required placeholder="Ex: 500">
                </div>
                <div class="form-group">
                  <label class="form-label">Unidade *</label>
                  <select class="form-input" id="nfUnidade" required>
                    <option value="">Selecione...</option>
                    <option value="KG">Quilograma (KG)</option>
                    <option value="L">Litro (L)</option>
                    <option value="DZ">D√∫zia (DZ)</option>
                    <option value="UN">Unidade (UN)</option>
                    <option value="PCT">Pacote (PCT)</option>
                    <option value="CX">Caixa (CX)</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Valor Unit√°rio (R$) *</label>
                  <input type="number" class="form-input" id="nfValorUnitario" step="0.01" required placeholder="0,00" oninput="calcularValorTotal()">
                </div>
                <div class="form-group">
                  <label class="form-label">Valor Total (R$)</label>
                  <input type="number" class="form-input" id="nfValor" step="0.01" readonly placeholder="Calculado automaticamente" style="background:var(--bg-muted);">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Nota de Empenho</label>
                <input type="text" class="form-input" id="nfEmpenho" placeholder="Ex: 2025NE00001">
              </div>
            </form>
          `,
          footer: '<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button type="submit" form="formNF" class="btn btn-primary">Salvar NF</button>'
        },
        'nova-entrega': {
          title: 'Registrar Entrega',
          body: `
            <form id="formEntrega" onsubmit="saveEntrega(event)">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Data da Entrega *</label>
                  <input type="date" class="form-input" id="entregaData" required value="${today()}">
                </div>
                <div class="form-group">
                  <label class="form-label">Nota Fiscal</label>
                  <input type="text" class="form-input" id="entregaNF" placeholder="N√∫mero da NF">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Fornecedor *</label>
                <input type="text" class="form-input" id="entregaFornecedor" required placeholder="Nome do fornecedor">
              </div>
              <div class="form-group">
                <label class="form-label">Escola *</label>
                <input type="text" class="form-input" id="entregaEscola" required placeholder="Nome da escola">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Produto *</label>
                  <input type="text" class="form-input" id="entregaProduto" required placeholder="Nome do produto">
                </div>
                <div class="form-group">
                  <label class="form-label">Quantidade *</label>
                  <input type="number" class="form-input" id="entregaQtd" step="0.01" required placeholder="0">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Observa√ß√µes</label>
                <textarea class="form-input" id="entregaObs" rows="2" placeholder="Observa√ß√µes sobre a entrega"></textarea>
              </div>
            </form>
          `,
          footer: '<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button type="submit" form="formEntrega" class="btn btn-success">Registrar Entrega</button>'
        },
        'problema': {
          title: 'Registrar Problema',
          body: `
            <form id="formProblema" onsubmit="saveProblema(event)">
              <div class="form-group">
                <label class="form-label">Tipo de Problema *</label>
                <select class="form-input" id="problemaTipo" required onchange="toggleGlosaField()">
                  <option value="recusa">Recusa</option>
                  <option value="glosa">Glosa</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Nota Fiscal</label>
                <input type="text" class="form-input" id="problemaNF" placeholder="N√∫mero da NF">
              </div>
              <div class="form-group">
                <label class="form-label">Fornecedor *</label>
                <input type="text" class="form-input" id="problemaFornecedor" required>
              </div>
              <div class="form-group" id="glosaValorGroup" style="display:none;">
                <label class="form-label">Valor da Glosa (R$)</label>
                <input type="number" class="form-input" id="problemaValor" step="0.01" placeholder="0,00">
              </div>
              <div class="form-group">
                <label class="form-label">Motivo *</label>
                <select class="form-input" id="problemaMotivo" required>
                  <option value="">Selecione...</option>
                  <option value="Qualidade">Problema de qualidade</option>
                  <option value="Quantidade">Quantidade incorreta</option>
                  <option value="Validade">Prazo de validade</option>
                  <option value="Temperatura">Temperatura inadequada</option>
                  <option value="Embalagem">Embalagem danificada</option>
                  <option value="Outro">Outro</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Observa√ß√µes</label>
                <textarea class="form-input" id="problemaObs" rows="2"></textarea>
              </div>
            </form>
          `,
          footer: '<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button type="submit" form="formProblema" class="btn btn-danger">Registrar</button>'
        },
        'atestar': {
          title: 'Atestar Notas Fiscais',
          body: '<div id="listaAtestar"><div class="spinner" style="margin:20px auto;"></div></div>',
          footer: '<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button type="button" class="btn btn-success" onclick="atestarSelecionadas()">Atestar Selecionadas</button>'
        },
        'novo-aluno': {
          title: 'Cadastrar Aluno com Necessidade Especial',
          body: `
            <form id="formAluno" onsubmit="saveAluno(event)">
              <div class="form-group">
                <label class="form-label">Nome Completo do Aluno *</label>
                <input type="text" class="form-input" id="alunoNome" required placeholder="Nome completo">
              </div>
              <div class="form-group">
                <label class="form-label">Unidade Escolar *</label>
                <input type="text" class="form-input" id="alunoEscola" required placeholder="Ex: EC 01 Plano Piloto">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Necessidade Alimentar *</label>
                  <select class="form-input" id="alunoPatologia" required>
                    <option value="">Selecione...</option>
                    <optgroup label="üè• Patologias M√©dicas">
                      <option value="DIABETES">ü©∫ Diabetes</option>
                      <option value="DOENCA_CELIACA">üåæ Doen√ßa Cel√≠aca</option>
                      <option value="INTOLERANCIA_LACTOSE">ü•õ Intoler√¢ncia √† Lactose</option>
                      <option value="APLV">üßÄ Alergia √† Prote√≠na do Leite (APLV)</option>
                      <option value="ALERGIA_OVO">ü•ö Alergia a Ovo</option>
                      <option value="ALERGIA_AMENDOIM">ü•ú Alergia a Amendoim</option>
                      <option value="ALERGIA_CASTANHAS">üå∞ Alergia a Castanhas/Nozes</option>
                      <option value="ALERGIA_FRUTOS_MAR">ü¶ê Alergia a Frutos do Mar</option>
                      <option value="FENILCETONURIA">üß¨ Fenilceton√∫ria</option>
                      <option value="DISFAGIA">üçΩÔ∏è Disfagia</option>
                      <option value="HIPERTENSAO">üßÇ Hipertens√£o (hiposs√≥dica)</option>
                    </optgroup>
                    <optgroup label="üå± Dietas por Escolha">
                      <option value="VEGANO">üå± Vegano</option>
                      <option value="VEGETARIANO">ü•¨ Vegetariano</option>
                      <option value="OVOLACTOVEGETARIANO">ü•ö Ovolactovegetariano</option>
                      <option value="PESCETARIANO">üêü Pescetariano</option>
                    </optgroup>
                    <optgroup label="üìã Outras">
                      <option value="OUTRAS">Outras necessidades</option>
                    </optgroup>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Validade do Laudo *</label>
                  <input type="date" class="form-input" id="alunoValidadeLaudo" required>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Observa√ß√µes / Restri√ß√µes Adicionais</label>
                <textarea class="form-input" id="alunoObs" rows="3" placeholder="Descreva outras restri√ß√µes alimentares ou observa√ß√µes importantes"></textarea>
              </div>
            </form>
          `,
          footer: '<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button type="submit" form="formAluno" class="btn btn-primary">Cadastrar Aluno</button>'
        },
        'gerar-cardapio': {
          title: 'Gerar Card√°pio Especial',
          body: `
            <form id="formCardapio" onsubmit="saveCardapio(event)">
              <div class="form-group">
                <label class="form-label">Selecione a Necessidade Alimentar *</label>
                <select class="form-input" id="cardapioPatologia" required>
                  <option value="">Selecione...</option>
                  <optgroup label="üè• Patologias M√©dicas">
                    <option value="DIABETES">ü©∫ Diabetes - Sem a√ß√∫car</option>
                    <option value="DOENCA_CELIACA">üåæ Doen√ßa Cel√≠aca - Sem gl√∫ten</option>
                    <option value="INTOLERANCIA_LACTOSE">ü•õ Intoler√¢ncia √† Lactose - Sem lactose</option>
                    <option value="APLV">üßÄ APLV - Sem prote√≠na do leite</option>
                    <option value="ALERGIA_OVO">ü•ö Alergia a Ovo</option>
                    <option value="ALERGIA_AMENDOIM">ü•ú Alergia a Amendoim</option>
                    <option value="FENILCETONURIA">üß¨ Fenilceton√∫ria</option>
                  </optgroup>
                  <optgroup label="üå± Dietas por Escolha">
                    <option value="VEGANO">üå± Vegano - 100% vegetal</option>
                    <option value="VEGETARIANO">ü•¨ Vegetariano</option>
                  </optgroup>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Per√≠odo</label>
                <select class="form-input" id="cardapioPeriodo">
                  <option value="SEMANAL">Semanal</option>
                  <option value="MENSAL">Mensal</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Observa√ß√µes</label>
                <textarea class="form-input" id="cardapioObs" rows="2" placeholder="Observa√ß√µes adicionais"></textarea>
              </div>
            </form>
          `,
          footer: '<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button type="submit" form="formCardapio" class="btn btn-primary">Gerar Card√°pio</button>'
        },
        'register': {
          title: 'Criar Conta',
          body: `
            <form id="formRegister" onsubmit="handleRegister(event)">
              <div class="form-group">
                <label class="form-label">Nome Completo *</label>
                <input type="text" class="form-input" id="regNome" required>
              </div>
              <div class="form-group">
                <label class="form-label">Email *</label>
                <input type="email" class="form-input" id="regEmail" required>
              </div>
              <div class="form-group">
                <label class="form-label">Tipo de Usu√°rio *</label>
                <select class="form-input" id="regTipo" required>
                  <option value="ANALISTA">Analista UNIAE</option>
                  <option value="REPRESENTANTE">Representante Escolar</option>
                  <option value="FORNECEDOR">Fornecedor</option>
                </select>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Senha *</label>
                  <input type="password" class="form-input" id="regSenha" required minlength="6">
                </div>
                <div class="form-group">
                  <label class="form-label">Confirmar Senha *</label>
                  <input type="password" class="form-input" id="regSenhaConfirm" required>
                </div>
              </div>
            </form>
          `,
          footer: '<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button type="submit" form="formRegister" class="btn btn-primary">Criar Conta</button>'
        }
      };

      const config = forms[type];
      if (config) {
        title.textContent = config.title;
        body.innerHTML = config.body;
        footer.innerHTML = config.footer;
        modal.classList.add('active');

        if (type === 'atestar') loadNFsParaAtestar();

        // Focus first input
        setTimeout(() => {
          const firstInput = body.querySelector('input, select');
          if (firstInput) firstInput.focus();
        }, 100);
      }
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
    }

    function toggleGlosaField() {
      const tipo = document.getElementById('problemaTipo').value;
      document.getElementById('glosaValorGroup').style.display = tipo === 'glosa' ? 'block' : 'none';
    }

    // ============================================
    // SALVAR DADOS
    // ============================================

    function calcularValorTotal() {
      var quantidade = parseFloat(document.getElementById('nfQuantidade').value) || 0;
      var valorUnitario = parseFloat(document.getElementById('nfValorUnitario').value) || 0;
      var valorTotal = quantidade * valorUnitario;
      document.getElementById('nfValor').value = valorTotal.toFixed(2);
    }

    function saveNF(e) {
      e.preventDefault();

      // Calcular valor total antes de salvar
      calcularValorTotal();

      const data = {
        numero: document.getElementById('nfNumero').value,
        dataEmissao: document.getElementById('nfData').value,
        fornecedor: document.getElementById('nfFornecedor').value,
        produto: document.getElementById('nfProduto').value,
        quantidade: parseFloat(document.getElementById('nfQuantidade').value) || 0,
        unidade: document.getElementById('nfUnidade').value,
        valorUnitario: parseFloat(document.getElementById('nfValorUnitario').value) || 0,
        valorTotal: parseFloat(document.getElementById('nfValor').value) || 0,
        notaEmpenho: document.getElementById('nfEmpenho').value,
        status: 'Recebida'
      };

      // Valida√ß√£o
      if (!data.produto) {
        toast('Informe o g√™nero aliment√≠cio (produto)', 'error');
        return;
      }
      if (!data.quantidade || data.quantidade <= 0) {
        toast('Informe a quantidade', 'error');
        return;
      }
      if (!data.unidade) {
        toast('Selecione a unidade de medida', 'error');
        return;
      }

      showLoading('Salvando...');
      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          if (result && result.success) {
            closeModal();
            toast('Nota fiscal cadastrada com sucesso!', 'success');
            loadPageData(state.currentPage);
          } else {
            toast(result.message || 'Erro ao salvar', 'error');
          }
        })
        .withFailureHandler(function (e) {
          hideLoading();
          toast('Erro: ' + e.message, 'error');
        })
        .createNotaFiscalUnificado(data);
    }

    function saveEntrega(e) {
      e.preventDefault();
      const data = {
        dataEntrega: document.getElementById('entregaData').value,
        notaFiscal: document.getElementById('entregaNF').value,
        fornecedor: document.getElementById('entregaFornecedor').value,
        unidadeEscolar: document.getElementById('entregaEscola').value,
        produto: document.getElementById('entregaProduto').value,
        quantidadeEntregue: parseFloat(document.getElementById('entregaQtd').value),
        observacoes: document.getElementById('entregaObs').value
      };

      showLoading('Salvando...');
      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          if (result && result.success) {
            closeModal();
            toast('Entrega registrada com sucesso!', 'success');
            loadPageData(state.currentPage);
          } else {
            toast(result.message || 'Erro ao salvar', 'error');
          }
        })
        .withFailureHandler(function (e) {
          hideLoading();
          toast('Erro: ' + e.message, 'error');
        })
        .createEntrega(data);
    }

    function saveProblema(e) {
      e.preventDefault();
      const tipo = document.getElementById('problemaTipo').value;
      const data = {
        nf: document.getElementById('problemaNF').value,
        fornecedor: document.getElementById('problemaFornecedor').value,
        motivo: document.getElementById('problemaMotivo').value,
        observacoes: document.getElementById('problemaObs').value
      };

      showLoading('Salvando...');

      if (tipo === 'glosa') {
        data.valorGlosa = parseFloat(document.getElementById('problemaValor').value) || 0;
        google.script.run
          .withSuccessHandler(handleSaveResult)
          .withFailureHandler(handleSaveError)
          .createGlosa(data);
      } else {
        google.script.run
          .withSuccessHandler(handleSaveResult)
          .withFailureHandler(handleSaveError)
          .createRecusa(data);
      }
    }

    function handleSaveResult(result) {
      hideLoading();
      if (result && result.success) {
        closeModal();
        toast('Registro salvo com sucesso!', 'success');
        loadPageData(state.currentPage);
      } else {
        toast(result.message || 'Erro ao salvar', 'error');
      }
    }

    function handleSaveError(e) {
      hideLoading();
      toast('Erro: ' + e.message, 'error');
    }

    function handleRegister(e) {
      e.preventDefault();
      const senha = document.getElementById('regSenha').value;
      const senhaConfirm = document.getElementById('regSenhaConfirm').value;

      if (senha !== senhaConfirm) {
        toast('As senhas n√£o coincidem', 'error');
        return;
      }

      const data = {
        nome: document.getElementById('regNome').value,
        email: document.getElementById('regEmail').value,
        tipo: document.getElementById('regTipo').value,
        senha: senha
      };

      showLoading('Criando conta...');
      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          if (result && result.success) {
            closeModal();
            toast('Conta criada! Fa√ßa login.', 'success');
            document.getElementById('loginEmail').value = data.email;
          } else {
            toast(result.error || 'Erro ao criar conta', 'error');
          }
        })
        .withFailureHandler(function (e) {
          hideLoading();
          toast('Erro: ' + e.message, 'error');
        })
        .api_auth_register(data);
    }

    // ============================================
    // ATESTAR NFs
    // ============================================
    function loadNFsParaAtestar() {
      google.script.run
        .withSuccessHandler(function (result) {
          const container = document.getElementById('listaAtestar');
          if (result && result.success && result.data && result.data.length > 0) {
            const pendentes = result.data.filter(nf =>
              (nf.Status_NF || nf.Status || '').toLowerCase() !== 'atestada'
            );

            if (pendentes.length > 0) {
              container.innerHTML = pendentes.map(nf => `
                <label style="display:flex;align-items:center;gap:12px;padding:14px;border:1px solid var(--border);border-radius:var(--radius-md);margin-bottom:8px;cursor:pointer;transition:var(--transition);">
                  <input type="checkbox" value="${nf.rowIndex}" checked style="width:20px;height:20px;accent-color:var(--primary);">
                  <div style="flex:1;">
                    <strong>NF ${nf.Numero_NF || nf['Nota Fiscal'] || '-'}</strong>
                    <div style="font-size:13px;color:var(--text-secondary);">${nf.Fornecedor_Nome || nf.Fornecedor || '-'} ‚Ä¢ R$ ${formatNumber(nf.Valor_Total || nf['Valor Total'] || 0)}</div>
                  </div>
                </label>
              `).join('');
            } else {
              container.innerHTML = '<div class="empty-state"><div class="icon">‚úÖ</div><h3>Tudo em dia!</h3><p>N√£o h√° NFs pendentes para atestar</p></div>';
            }
          } else {
            container.innerHTML = '<div class="empty-state"><div class="icon">üìã</div><h3>Nenhuma NF encontrada</h3></div>';
          }
        })
        .withFailureHandler(function () {
          document.getElementById('listaAtestar').innerHTML = '<p style="color:var(--error);text-align:center;">Erro ao carregar NFs</p>';
        })
        .listNotasFiscais(50);
    }

    function atestarSelecionadas() {
      const checkboxes = document.querySelectorAll('#listaAtestar input[type="checkbox"]:checked');
      const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

      if (ids.length === 0) {
        toast('Selecione pelo menos uma NF', 'warning');
        return;
      }

      showLoading('Atestando...');

      // Atestar uma por uma
      let completed = 0;
      ids.forEach(rowIndex => {
        google.script.run
          .withSuccessHandler(function () {
            completed++;
            if (completed === ids.length) {
              hideLoading();
              closeModal();
              toast(ids.length + ' NF(s) atestada(s) com sucesso!', 'success');
              loadPageData(state.currentPage);
            }
          })
          .withFailureHandler(function () {
            completed++;
            if (completed === ids.length) {
              hideLoading();
              toast('Algumas NFs podem n√£o ter sido atestadas', 'warning');
              loadPageData(state.currentPage);
            }
          })
          .updateNotaFiscal(rowIndex, { status: 'Atestada' });
      });
    }

    // ============================================
    // DELETAR
    // ============================================
    function deleteItem(type, rowIndex) {
      if (!confirm('Tem certeza que deseja excluir este registro?')) return;

      showLoading('Excluindo...');

      const funcs = {
        nf: 'deleteNotaFiscal',
        entrega: 'deleteEntrega',
        recusa: 'deleteRecusa',
        glosa: 'deleteGlosa'
      };

      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          if (result && result.success) {
            toast('Registro exclu√≠do', 'success');
            loadPageData(state.currentPage);
          } else {
            toast(result.message || 'Erro ao excluir', 'error');
          }
        })
        .withFailureHandler(function (e) {
          hideLoading();
          toast('Erro: ' + e.message, 'error');
        })
      [funcs[type]](rowIndex);
    }

    function viewItem(type, rowIndex) {
      if (type === 'nf') {
        showLoading();
        google.script.run
          .withSuccessHandler(function (result) {
            hideLoading();
            if (result && result.success) {
              mostrarDetalhesNF(result);
            } else {
              toast('Erro: ' + (result ? result.error : 'Dados n√£o encontrados'), 'error');
            }
          })
          .withFailureHandler(function (e) {
            hideLoading();
            toast('Erro: ' + e.message, 'error');
          })
          .getDetalhesNFCompleto(rowIndex);
      } else {
        toast('Visualiza√ß√£o em desenvolvimento', 'info');
      }
    }

    function mostrarDetalhesNF(dados) {
      var nf = dados.nf || {};
      var recebimentos = dados.recebimentos || [];
      var resumo = dados.resumo || {};

      var html = '<div style="max-height:70vh;overflow-y:auto;">';

      // Cabe√ßalho da NF
      html += '<div style="background:var(--bg-surface);padding:16px;border-radius:var(--radius-md);margin-bottom:16px;border:1px solid var(--border);">';
      html += '<h3 style="margin:0 0 12px 0;display:flex;align-items:center;gap:8px;"><span class="material-symbols-outlined">receipt_long</span>NF ' + (nf.numero || nf.id || '-') + '</h3>';
      html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">';
      html += '<div><strong>Fornecedor:</strong> ' + (nf.fornecedor || '-') + '</div>';
      html += '<div><strong>Produto:</strong> ' + (nf.produto || '-') + '</div>';
      html += '<div><strong>Quantidade:</strong> ' + (nf.quantidade || 0) + ' ' + (nf.unidade || '') + '</div>';
      html += '<div><strong>Valor Unit√°rio:</strong> R$ ' + formatNumber(nf.valorUnitario || 0) + '</div>';
      html += '<div><strong>Valor Total:</strong> R$ ' + formatNumber(nf.valorTotal || 0) + '</div>';
      html += '<div><strong>Status:</strong> <span class="badge ' + getStatusClass(nf.status || 'Pendente') + '">' + (nf.status || 'Pendente') + '</span></div>';
      html += '<div><strong>Nota Empenho:</strong> ' + (nf.notaEmpenho || 'N/A') + '</div>';
      html += '<div><strong>Data Emiss√£o:</strong> ' + formatDate(nf.dataEmissao) + '</div>';
      html += '</div></div>';

      // Resumo de Recebimentos
      html += '<div style="background:var(--info-light);padding:16px;border-radius:var(--radius-md);margin-bottom:16px;border-left:4px solid var(--info);">';
      html += '<h4 style="margin:0 0 12px 0;"><span class="material-symbols-outlined" style="vertical-align:middle;">analytics</span> Resumo de Recebimentos</h4>';
      html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;text-align:center;">';
      html += '<div><div style="font-size:24px;font-weight:bold;color:var(--info);">' + (resumo.totalEscolas || 0) + '</div><div style="font-size:12px;">Escolas</div></div>';
      html += '<div><div style="font-size:24px;font-weight:bold;color:var(--success);">' + (resumo.qtdRecebida || 0) + '</div><div style="font-size:12px;">Recebido</div></div>';
      html += '<div><div style="font-size:24px;font-weight:bold;color:var(--warning);">' + (resumo.qtdPendente || 0) + '</div><div style="font-size:12px;">Pendente</div></div>';
      html += '<div><div style="font-size:24px;font-weight:bold;color:var(--primary);">' + (resumo.percentualRecebido || 0) + '%</div><div style="font-size:12px;">Conclu√≠do</div></div>';
      html += '</div></div>';

      // Lista de Recebimentos por Escola
      html += '<h4 style="margin:16px 0 12px 0;"><span class="material-symbols-outlined" style="vertical-align:middle;">school</span> Recebimentos por Escola</h4>';

      if (recebimentos.length > 0) {
        html += '<div style="display:flex;flex-direction:column;gap:8px;">';
        for (var i = 0; i < recebimentos.length; i++) {
          var rec = recebimentos[i];
          var statusColor = rec.status === 'CONFORME' ? 'var(--success)' : (rec.status === 'PARCIAL' ? 'var(--warning)' : 'var(--error)');

          html += '<div style="background:var(--bg-surface);padding:12px;border-radius:var(--radius-md);border:1px solid var(--border);border-left:4px solid ' + statusColor + ';">';
          html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">';
          html += '<strong>' + (rec.escola || '-') + '</strong>';
          html += '<span class="badge ' + getStatusClass(rec.status || 'Pendente') + '">' + (rec.status || 'Pendente') + '</span>';
          html += '</div>';
          html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;font-size:13px;">';
          html += '<div><strong>Recebido:</strong> ' + (rec.qtdRecebida || 0) + ' ' + (rec.unidade || '') + '</div>';
          html += '<div><strong>Valor:</strong> R$ ' + formatNumber(rec.valorParcial || 0) + '</div>';
          html += '<div><strong>Respons√°vel:</strong> ' + (rec.responsavel || '-') + '</div>';
          html += '<div><strong>Data:</strong> ' + formatDate(rec.dataRecebimento) + '</div>';
          html += '</div>';
          if (rec.observacoes) {
            html += '<div style="margin-top:8px;padding:8px;background:var(--bg-muted);border-radius:var(--radius-sm);font-size:12px;"><strong>Obs:</strong> ' + rec.observacoes + '</div>';
          }
          html += '</div>';
        }
        html += '</div>';
      } else {
        html += '<div style="text-align:center;padding:24px;background:var(--bg-muted);border-radius:var(--radius-md);">';
        html += '<span class="material-symbols-outlined" style="font-size:48px;color:var(--text-muted);">hourglass_empty</span>';
        html += '<p style="margin:8px 0 0 0;color:var(--text-muted);">Nenhum recebimento registrado ainda</p>';
        html += '</div>';
      }

      html += '</div>';

      // Mostrar no modal
      document.getElementById('modalTitle').textContent = 'Detalhes da Nota Fiscal';
      document.getElementById('modalBody').innerHTML = html;
      document.getElementById('modal').classList.add('active');
      document.getElementById('modalOverlay').classList.add('active');
    }

    // ============================================
    // AN√ÅLISES E RELAT√ìRIOS
    // ============================================
    function runAnalysis(type) {
      const container = document.getElementById('analysisResults');
      container.innerHTML = '<div style="text-align:center;padding:40px;"><div class="spinner"></div><p style="margin-top:16px;color:#333;">Executando an√°lise...</p></div>';

      const successHandler = function (result) {
        if (result && result.success && result.data) {
          let html = '';

          if (type === 'irregularidades' && result.data.irregularidades) {
            // Relat√≥rio de Irregularidades com alto contraste
            html = '<div style="background:#fff;border:2px solid #1a73e8;border-radius:12px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.15);">';
            html += '<div style="background:#1a73e8;color:#fff;padding:16px 20px;font-size:18px;font-weight:700;">üîç Relat√≥rio de Irregularidades</div>';
            html += '<div style="padding:20px;">';

            // Resumo com cards coloridos
            html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">';
            html += '<div style="background:#e3f2fd;border-left:4px solid #1565c0;padding:12px;border-radius:6px;"><div style="font-size:11px;color:#1565c0;font-weight:600;text-transform:uppercase;">Total</div><div style="font-size:28px;font-weight:700;color:#0d47a1;">' + result.data.resumo.total + '</div></div>';
            html += '<div style="background:#ffebee;border-left:4px solid #c62828;padding:12px;border-radius:6px;"><div style="font-size:11px;color:#c62828;font-weight:600;text-transform:uppercase;">Cr√≠ticas</div><div style="font-size:28px;font-weight:700;color:#b71c1c;">' + result.data.resumo.criticas + '</div></div>';
            html += '<div style="background:#fff3e0;border-left:4px solid #e65100;padding:12px;border-radius:6px;"><div style="font-size:11px;color:#e65100;font-weight:600;text-transform:uppercase;">Alertas</div><div style="font-size:28px;font-weight:700;color:#bf360c;">' + result.data.resumo.alertas + '</div></div>';
            html += '</div>';

            // Lista de irregularidades
            if (result.data.irregularidades.length > 0) {
              html += '<div style="background:#f5f5f5;border-radius:8px;padding:16px;">';
              html += '<div style="font-weight:700;color:#333;margin-bottom:12px;font-size:14px;">üìã Detalhes das Irregularidades:</div>';
              html += '<div style="max-height:300px;overflow-y:auto;">';

              result.data.irregularidades.forEach(function (item, idx) {
                var bgColor = item.severidade === 'CRITICA' ? '#ffcdd2' : (item.severidade === 'ALERTA' ? '#ffe0b2' : '#e3f2fd');
                var borderColor = item.severidade === 'CRITICA' ? '#c62828' : (item.severidade === 'ALERTA' ? '#e65100' : '#1565c0');
                var textColor = item.severidade === 'CRITICA' ? '#b71c1c' : (item.severidade === 'ALERTA' ? '#bf360c' : '#0d47a1');

                html += '<div style="background:' + bgColor + ';border-left:4px solid ' + borderColor + ';padding:12px;margin-bottom:8px;border-radius:4px;">';
                html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
                html += '<span style="font-weight:700;color:' + textColor + ';">' + (item.tipo || 'N/A').replace(/_/g, ' ') + '</span>';
                html += '<span style="background:' + borderColor + ';color:#fff;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;">' + item.severidade + '</span>';
                html += '</div>';
                html += '<div style="color:#333;font-size:13px;margin-top:6px;">' + item.descricao + '</div>';
                if (item.escola) html += '<div style="color:#555;font-size:12px;margin-top:4px;">üè´ ' + item.escola + '</div>';
                if (item.nf) html += '<div style="color:#555;font-size:12px;">üìÑ NF: ' + item.nf + '</div>';
                html += '</div>';
              });

              html += '</div></div>';
            } else {
              html += '<div style="text-align:center;padding:30px;color:#2e7d32;background:#e8f5e9;border-radius:8px;"><span style="font-size:32px;">‚úÖ</span><br><strong>Nenhuma irregularidade encontrada!</strong></div>';
            }

            html += '</div></div>';

          } else if (type === 'tendencias' && result.data.tendencias) {
            // Relat√≥rio de Tend√™ncias - FORMATO TEXTUAL/NARRATIVO
            html = '<div style="background:#fff;border:2px solid #7c3aed;border-radius:12px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.15);">';
            html += '<div style="background:#7c3aed;color:#fff;padding:16px 20px;font-size:18px;font-weight:700;">üìà An√°lise de Tend√™ncias e Padr√µes</div>';
            html += '<div style="padding:24px;">';

            // Se√ß√£o de An√°lise Textual
            html += '<div style="background:linear-gradient(135deg,#ede7f6,#e8eaf6);border-radius:12px;padding:20px;margin-bottom:20px;">';
            html += '<h3 style="color:#4527a0;margin:0 0 16px 0;font-size:18px;">üìä Vis√£o Geral do Per√≠odo</h3>';

            var totalFornecedores = result.data.resumo.totalFornecedores || 0;
            var totalEscolas = result.data.resumo.totalEscolas || 0;
            var valorTotal = result.data.resumo.valorTotalNFs || 0;

            html += '<p style="color:#333;font-size:15px;line-height:1.8;margin:0 0 12px 0;">';
            html += 'No per√≠odo analisado, o sistema registrou movimenta√ß√µes de <strong style="color:#7c3aed;">' + totalFornecedores + ' fornecedores</strong> ';
            html += 'atendendo <strong style="color:#2e7d32;">' + totalEscolas + ' unidades escolares</strong>. ';
            html += 'O valor total em notas fiscais processadas foi de <strong style="color:#1565c0;">R$ ' + valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) + '</strong>.';
            html += '</p>';

            // An√°lise de concentra√ß√£o
            if (result.data.tendencias.fornecedores && result.data.tendencias.fornecedores.length > 0) {
              var topFornecedor = result.data.tendencias.fornecedores[0];
              var percentTop = ((topFornecedor.total / valorTotal) * 100).toFixed(1);

              html += '<p style="color:#333;font-size:15px;line-height:1.8;margin:0;">';
              html += 'O principal fornecedor √© <strong style="color:#e65100;">' + topFornecedor.fornecedor + '</strong>, ';
              html += 'respons√°vel por <strong>' + percentTop + '%</strong> do valor total movimentado ';
              html += '(R$ ' + topFornecedor.total.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) + ' em ' + topFornecedor.qtd + ' NF' + (topFornecedor.qtd > 1 ? 's' : '') + ').';
              html += '</p>';
            }
            html += '</div>';

            // Insights sobre Fornecedores
            if (result.data.tendencias.fornecedores && result.data.tendencias.fornecedores.length > 0) {
              html += '<div style="background:#fff;border:1px solid #ddd;border-radius:12px;padding:20px;margin-bottom:20px;">';
              html += '<h3 style="color:#1565c0;margin:0 0 16px 0;font-size:16px;">üè¢ An√°lise de Fornecedores</h3>';

              html += '<div style="color:#333;font-size:14px;line-height:1.8;">';
              html += '<p style="margin:0 0 12px 0;"><strong>Distribui√ß√£o de valores:</strong></p>';
              html += '<ul style="margin:0;padding-left:20px;">';

              result.data.tendencias.fornecedores.slice(0, 5).forEach(function (f, idx) {
                var percent = ((f.total / valorTotal) * 100).toFixed(1);
                var emoji = idx === 0 ? 'ü•á' : (idx === 1 ? 'ü•à' : (idx === 2 ? 'ü•â' : '‚Ä¢'));
                html += '<li style="margin-bottom:8px;">' + emoji + ' <strong>' + f.fornecedor + '</strong>: R$ ' + f.total.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) + ' (' + percent + '% do total, ' + f.qtd + ' NF' + (f.qtd > 1 ? 's' : '') + ')</li>';
              });

              html += '</ul>';

              // Insight adicional
              if (result.data.tendencias.fornecedores.length > 3) {
                var top3Total = result.data.tendencias.fornecedores.slice(0, 3).reduce(function (sum, f) { return sum + f.total; }, 0);
                var top3Percent = ((top3Total / valorTotal) * 100).toFixed(1);
                html += '<p style="margin:16px 0 0 0;padding:12px;background:#e3f2fd;border-radius:6px;"><span style="color:#1565c0;">üí°</span> <strong>Insight:</strong> Os 3 maiores fornecedores concentram <strong>' + top3Percent + '%</strong> do valor total movimentado.</p>';
              }

              html += '</div></div>';
            }

            // Insights sobre Escolas
            if (result.data.tendencias.escolas && result.data.tendencias.escolas.length > 0) {
              html += '<div style="background:#fff;border:1px solid #ddd;border-radius:12px;padding:20px;">';
              html += '<h3 style="color:#2e7d32;margin:0 0 16px 0;font-size:16px;">üè´ An√°lise de Escolas</h3>';

              html += '<div style="color:#333;font-size:14px;line-height:1.8;">';
              html += '<p style="margin:0 0 12px 0;"><strong>Escolas com maior volume de recebimentos:</strong></p>';

              result.data.tendencias.escolas.slice(0, 5).forEach(function (e, idx) {
                var emoji = idx === 0 ? 'üèÜ' : (idx === 1 ? 'ü•à' : (idx === 2 ? 'ü•â' : 'üìç'));
                html += '<div style="padding:10px;background:' + (idx % 2 === 0 ? '#f5f5f5' : '#fff') + ';border-radius:6px;margin-bottom:6px;">';
                html += emoji + ' <strong>' + e.escola + '</strong><br>';
                html += '<span style="color:#666;font-size:13px;">‚Üí ' + e.recebimentos + ' recebimento' + (e.recebimentos > 1 ? 's' : '') + ' | ' + e.qtdTotal.toLocaleString('pt-BR') + ' unidades | Taxa de recusa: ' + e.taxaRecusa + '</span>';
                html += '</div>';
              });

              // Alerta de recusas
              var escolasComRecusa = result.data.tendencias.escolas.filter(function (e) { return e.taxaRecusa !== '0%' && e.taxaRecusa !== '0.0%'; });
              if (escolasComRecusa.length > 0) {
                html += '<p style="margin:16px 0 0 0;padding:12px;background:#fff3e0;border-radius:6px;"><span style="color:#e65100;">‚ö†Ô∏è</span> <strong>Aten√ß√£o:</strong> ' + escolasComRecusa.length + ' escola' + (escolasComRecusa.length > 1 ? 's apresentam' : ' apresenta') + ' taxa de recusa diferente de zero. Recomenda-se an√°lise detalhada.</p>';
              }

              html += '</div></div>';
            }

            html += '</div></div>';

          } else {
            html = '<div style="background:#fff;border:2px solid #666;border-radius:12px;padding:20px;"><pre style="color:#333;font-size:13px;overflow-x:auto;">' + JSON.stringify(result.data, null, 2) + '</pre></div>';
          }

          container.innerHTML = html;
        } else {
          container.innerHTML = '<div style="background:#fff3e0;border:2px solid #e65100;border-radius:8px;padding:20px;text-align:center;"><span style="font-size:24px;">‚ö†Ô∏è</span><br><strong style="color:#bf360c;">Nenhum resultado encontrado</strong></div>';
        }
      };

      const failureHandler = function (e) {
        container.innerHTML = '<div style="background:#ffebee;border:2px solid #c62828;border-radius:8px;padding:20px;text-align:center;"><span style="font-size:24px;">‚ùå</span><br><strong style="color:#b71c1c;">Erro: ' + (e.message || e) + '</strong></div>';
      };

      // Chamar a fun√ß√£o correta baseada no tipo
      if (type === 'irregularidades') {
        google.script.run
          .withSuccessHandler(successHandler)
          .withFailureHandler(failureHandler)
          .runVerificacoesServer({});
      } else if (type === 'tendencias') {
        google.script.run
          .withSuccessHandler(successHandler)
          .withFailureHandler(failureHandler)
          .runTrendsServer({});
      } else if (type === 'alunos-especiais') {
        google.script.run
          .withSuccessHandler(function(r) { console.log('alunos-especiais result:', r); renderAnaliseAlunosEspeciais(r); })
          .withFailureHandler(failureHandler)
          .runAnaliseAlunosEspeciaisServer();
      } else if (type === 'laudos') {
        google.script.run
          .withSuccessHandler(function(r) { console.log('laudos result:', r); renderAnaliseLaudos(r); })
          .withFailureHandler(failureHandler)
          .runAnaliseLaudosServer();
      } else if (type === 'cardapios') {
        google.script.run
          .withSuccessHandler(function(r) { console.log('cardapios result:', r); renderAnaliseCardapios(r); })
          .withFailureHandler(failureHandler)
          .runAnaliseCardapiosServer();
      } else if (type === 'nutricional') {
        google.script.run
          .withSuccessHandler(function(r) { console.log('nutricional result:', r); renderAnaliseNutricional(r); })
          .withFailureHandler(failureHandler)
          .runAnaliseNutricionalServer();
      } else if (type === 'ia-geral') {
        google.script.run
          .withSuccessHandler(function(r) { console.log('ia-geral result:', r); renderAnaliseIA(r); })
          .withFailureHandler(failureHandler)
          .runAnaliseIAGeralServer();
      } else if (type === 'ia-nutricao') {
        google.script.run
          .withSuccessHandler(function(r) { console.log('ia-nutricao result:', r); renderAnaliseIA(r); })
          .withFailureHandler(failureHandler)
          .runAnaliseIANutricaoServer();
      } else if (type === 'ia-previsao') {
        google.script.run
          .withSuccessHandler(function(r) { console.log('ia-previsao result:', r); renderAnaliseIA(r); })
          .withFailureHandler(failureHandler)
          .runAnaliseIAPrevisaoServer();
      } else if (type === 'ia-alertas') {
        google.script.run
          .withSuccessHandler(function(r) { console.log('ia-alertas result:', r); renderAnaliseAlertas(r); })
          .withFailureHandler(failureHandler)
          .runAnaliseIAAlertasServer();
      } else {
        google.script.run
          .withSuccessHandler(successHandler)
          .withFailureHandler(failureHandler)
          .runTrendsServer({});
      }
    }

    // ============================================
    // RENDERIZADORES DE AN√ÅLISES
    // ============================================
    
    function renderAnaliseAlunosEspeciais(result) {
      const container = document.getElementById('analysisResults');
      console.log('renderAnaliseAlunosEspeciais recebeu:', result);
      if (!result) {
        container.innerHTML = '<div style="background:#ffebee;border:2px solid #c62828;border-radius:8px;padding:20px;text-align:center;"><span style="font-size:24px;">‚ùå</span><br><strong style="color:#b71c1c;">Erro: Resposta vazia do servidor</strong></div>';
        return;
      }
      if (!result.success) {
        container.innerHTML = '<div style="background:#ffebee;border:2px solid #c62828;border-radius:8px;padding:20px;text-align:center;"><span style="font-size:24px;">‚ùå</span><br><strong style="color:#b71c1c;">Erro: ' + (result.error || 'Falha desconhecida') + '</strong></div>';
        return;
      }
      
      const data = result.data;
      let html = '<div style="background:#fff;border:2px solid #7c3aed;border-radius:12px;overflow:hidden;">';
      html += '<div style="background:#7c3aed;color:#fff;padding:16px 20px;font-size:18px;font-weight:700;">üë§ Alunos com Necessidades Especiais</div>';
      html += '<div style="padding:20px;">';
      
      // Resumo
      html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">';
      html += '<div style="background:#ede7f6;padding:16px;border-radius:8px;text-align:center;"><div style="font-size:28px;font-weight:700;color:#7c3aed;">' + data.resumo.total + '</div><div style="font-size:12px;color:#666;">Total</div></div>';
      html += '<div style="background:#e8f5e9;padding:16px;border-radius:8px;text-align:center;"><div style="font-size:28px;font-weight:700;color:#2e7d32;">' + data.resumo.ativos + '</div><div style="font-size:12px;color:#666;">Ativos</div></div>';
      html += '<div style="background:#e3f2fd;padding:16px;border-radius:8px;text-align:center;"><div style="font-size:28px;font-weight:700;color:#1565c0;">' + Object.keys(data.resumo.porPatologia).length + '</div><div style="font-size:12px;color:#666;">Patologias</div></div>';
      html += '</div>';
      
      // Por patologia
      if (Object.keys(data.resumo.porPatologia).length > 0) {
        html += '<h3 style="margin:0 0 12px 0;font-size:14px;color:#666;">Distribui√ß√£o por Patologia:</h3>';
        html += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px;">';
        for (const [pat, qtd] of Object.entries(data.resumo.porPatologia)) {
          html += '<span style="background:#f3e5f5;color:#7b1fa2;padding:6px 12px;border-radius:16px;font-size:13px;">' + pat + ': ' + qtd + '</span>';
        }
        html += '</div>';
      }
      
      html += '</div></div>';
      container.innerHTML = html;
    }
    
    function renderAnaliseLaudos(result) {
      const container = document.getElementById('analysisResults');
      if (!result || !result.success) {
        container.innerHTML = '<div style="background:#ffebee;border:2px solid #c62828;border-radius:8px;padding:20px;text-align:center;"><span style="font-size:24px;">‚ùå</span><br><strong style="color:#b71c1c;">Erro: ' + (result && result.error ? result.error : 'Falha ao carregar dados') + '</strong></div>';
        return;
      }
      
      const data = result.data;
      let html = '<div style="background:#fff;border:2px solid #e65100;border-radius:12px;overflow:hidden;">';
      html += '<div style="background:#e65100;color:#fff;padding:16px 20px;font-size:18px;font-weight:700;">üìã An√°lise de Laudos M√©dicos</div>';
      html += '<div style="padding:20px;">';
      
      // Resumo
      html += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;">';
      html += '<div style="background:#e3f2fd;padding:16px;border-radius:8px;text-align:center;"><div style="font-size:24px;font-weight:700;color:#1565c0;">' + data.resumo.total + '</div><div style="font-size:11px;color:#666;">Total</div></div>';
      html += '<div style="background:#e8f5e9;padding:16px;border-radius:8px;text-align:center;"><div style="font-size:24px;font-weight:700;color:#2e7d32;">' + data.resumo.validos + '</div><div style="font-size:11px;color:#666;">V√°lidos</div></div>';
      html += '<div style="background:#fff3e0;padding:16px;border-radius:8px;text-align:center;"><div style="font-size:24px;font-weight:700;color:#e65100;">' + data.resumo.vencendo30dias + '</div><div style="font-size:11px;color:#666;">Vencendo</div></div>';
      html += '<div style="background:#ffebee;padding:16px;border-radius:8px;text-align:center;"><div style="font-size:24px;font-weight:700;color:#c62828;">' + data.resumo.vencidos + '</div><div style="font-size:11px;color:#666;">Vencidos</div></div>';
      html += '</div>';
      
      // Laudos vencendo
      if (data.laudosVencendo && data.laudosVencendo.length > 0) {
        html += '<h3 style="margin:0 0 12px 0;font-size:14px;color:#e65100;">‚ö†Ô∏è Laudos Vencendo (pr√≥ximos 30 dias):</h3>';
        html += '<div style="max-height:200px;overflow-y:auto;margin-bottom:16px;">';
        data.laudosVencendo.forEach(function(l) {
          html += '<div style="background:#fff3e0;padding:10px;margin-bottom:6px;border-radius:6px;border-left:3px solid #e65100;">';
          html += '<strong>' + l.nome + '</strong> - ' + l.escola + '<br>';
          html += '<small style="color:#666;">' + l.patologia + ' | Vence em: ' + l.validadeLaudo + ' (' + l.diasRestantes + ' dias)</small>';
          html += '</div>';
        });
        html += '</div>';
      }
      
      // Laudos vencidos
      if (data.laudosVencidos && data.laudosVencidos.length > 0) {
        html += '<h3 style="margin:0 0 12px 0;font-size:14px;color:#c62828;">üö® Laudos Vencidos:</h3>';
        html += '<div style="max-height:200px;overflow-y:auto;">';
        data.laudosVencidos.forEach(function(l) {
          html += '<div style="background:#ffebee;padding:10px;margin-bottom:6px;border-radius:6px;border-left:3px solid #c62828;">';
          html += '<strong>' + l.nome + '</strong> - ' + l.escola + '<br>';
          html += '<small style="color:#666;">' + l.patologia + ' | Venceu em: ' + l.validadeLaudo + '</small>';
          html += '</div>';
        });
        html += '</div>';
      }
      
      html += '</div></div>';
      container.innerHTML = html;
    }
    
    function renderAnaliseCardapios(result) {
      const container = document.getElementById('analysisResults');
      if (!result || !result.success) {
        container.innerHTML = '<div style="background:#ffebee;border:2px solid #c62828;border-radius:8px;padding:20px;text-align:center;"><span style="font-size:24px;">‚ùå</span><br><strong style="color:#b71c1c;">Erro: ' + (result && result.error ? result.error : 'Falha ao carregar dados') + '</strong></div>';
        return;
      }
      
      const data = result.data;
      let html = '<div style="background:#fff;border:2px solid #2e7d32;border-radius:12px;overflow:hidden;">';
      html += '<div style="background:#2e7d32;color:#fff;padding:16px 20px;font-size:18px;font-weight:700;">üçΩÔ∏è Card√°pios Especiais</div>';
      html += '<div style="padding:20px;">';
      
      html += '<div style="background:#e8f5e9;padding:20px;border-radius:8px;text-align:center;margin-bottom:20px;">';
      html += '<div style="font-size:36px;font-weight:700;color:#2e7d32;">' + data.resumo.total + '</div>';
      html += '<div style="font-size:14px;color:#666;">Card√°pios Cadastrados</div>';
      html += '</div>';
      
      if (Object.keys(data.resumo.porTipo).length > 0) {
        html += '<h3 style="margin:0 0 12px 0;font-size:14px;color:#666;">Por Tipo de Dieta:</h3>';
        html += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
        for (const [tipo, qtd] of Object.entries(data.resumo.porTipo)) {
          html += '<span style="background:#c8e6c9;color:#1b5e20;padding:6px 12px;border-radius:16px;font-size:13px;">' + tipo + ': ' + qtd + '</span>';
        }
        html += '</div>';
      }
      
      html += '</div></div>';
      container.innerHTML = html;
    }
    
    function renderAnaliseNutricional(result) {
      const container = document.getElementById('analysisResults');
      if (!result || !result.success) {
        container.innerHTML = '<div style="background:#ffebee;border:2px solid #c62828;border-radius:8px;padding:20px;text-align:center;"><span style="font-size:24px;">‚ùå</span><br><strong style="color:#b71c1c;">Erro: ' + (result && result.error ? result.error : 'Falha ao carregar dados') + '</strong></div>';
        return;
      }
      
      const data = result.data;
      let html = '<div style="background:#fff;border:2px solid #1565c0;border-radius:12px;overflow:hidden;">';
      html += '<div style="background:#1565c0;color:#fff;padding:16px 20px;font-size:18px;font-weight:700;">ü•¶ An√°lise Nutricional</div>';
      html += '<div style="padding:20px;">';
      
      html += '<div style="background:#e3f2fd;padding:20px;border-radius:8px;text-align:center;margin-bottom:20px;">';
      html += '<div style="font-size:36px;font-weight:700;color:#1565c0;">' + data.resumo.totalItens + '</div>';
      html += '<div style="font-size:14px;color:#666;">Itens Alimentares Cadastrados</div>';
      html += '</div>';
      
      if (Object.keys(data.resumo.gruposAlimentares).length > 0) {
        html += '<h3 style="margin:0 0 12px 0;font-size:14px;color:#666;">Grupos Alimentares:</h3>';
        html += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
        for (const [grupo, qtd] of Object.entries(data.resumo.gruposAlimentares)) {
          html += '<span style="background:#bbdefb;color:#0d47a1;padding:6px 12px;border-radius:16px;font-size:13px;">' + grupo + ': ' + qtd + '</span>';
        }
        html += '</div>';
      }
      
      html += '</div></div>';
      container.innerHTML = html;
    }
    
    function renderAnaliseIA(result) {
      const container = document.getElementById('analysisResults');
      if (!result || !result.success) {
        container.innerHTML = '<div style="background:#ffebee;border:2px solid #c62828;border-radius:8px;padding:20px;text-align:center;"><span style="font-size:24px;">‚ùå</span><br><strong style="color:#b71c1c;">Erro: ' + (result ? result.error : 'Desconhecido') + '</strong></div>';
        return;
      }
      
      const data = result.data;
      let html = '<div style="background:#fff;border:2px solid #7c3aed;border-radius:12px;overflow:hidden;">';
      html += '<div style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:16px 20px;font-size:18px;font-weight:700;">ü§ñ An√°lise com Intelig√™ncia Artificial</div>';
      html += '<div style="padding:20px;">';
      
      // Resumo se existir
      if (data.resumo) {
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:20px;">';
        for (const [key, value] of Object.entries(data.resumo)) {
          html += '<div style="background:#ede7f6;padding:12px;border-radius:8px;text-align:center;">';
          html += '<div style="font-size:20px;font-weight:700;color:#7c3aed;">' + value + '</div>';
          html += '<div style="font-size:11px;color:#666;">' + key.replace(/([A-Z])/g, ' $1').trim() + '</div>';
          html += '</div>';
        }
        html += '</div>';
      }
      
      // An√°lise IA
      const analise = data.analiseIA || data.previsao || data.recomendacaoIA || 'An√°lise n√£o dispon√≠vel';
      html += '<div style="background:#f5f5f5;padding:16px;border-radius:8px;border-left:4px solid #7c3aed;">';
      html += '<h4 style="margin:0 0 12px 0;color:#7c3aed;">üí° Insights da IA:</h4>';
      html += '<p style="margin:0;color:#333;line-height:1.6;white-space:pre-wrap;">' + analise + '</p>';
      html += '</div>';
      
      html += '<div style="margin-top:12px;font-size:11px;color:#999;text-align:right;">Gerado em: ' + (data.timestamp || new Date().toISOString()) + '</div>';
      html += '</div></div>';
      container.innerHTML = html;
    }
    
    function renderAnaliseAlertas(result) {
      const container = document.getElementById('analysisResults');
      if (!result || !result.success) {
        container.innerHTML = '<div style="background:#ffebee;border:2px solid #c62828;border-radius:8px;padding:20px;text-align:center;"><span style="font-size:24px;">‚ùå</span><br><strong style="color:#b71c1c;">Erro ao carregar alertas</strong></div>';
        return;
      }
      
      const data = result.data;
      let html = '<div style="background:#fff;border:2px solid #f57c00;border-radius:12px;overflow:hidden;">';
      html += '<div style="background:linear-gradient(135deg,#fa709a,#fee140);color:#fff;padding:16px 20px;font-size:18px;font-weight:700;">‚ö° Alertas Inteligentes</div>';
      html += '<div style="padding:20px;">';
      
      if (data.alertas && data.alertas.length > 0) {
        html += '<div style="margin-bottom:16px;font-size:14px;color:#666;">Total de alertas: <strong>' + data.totalAlertas + '</strong></div>';
        
        data.alertas.forEach(function(alerta) {
          const bgColor = alerta.severidade === 'CRITICA' ? '#ffebee' : (alerta.severidade === 'ALTA' ? '#fff3e0' : '#e3f2fd');
          const borderColor = alerta.severidade === 'CRITICA' ? '#c62828' : (alerta.severidade === 'ALTA' ? '#e65100' : '#1565c0');
          
          html += '<div style="background:' + bgColor + ';border-left:4px solid ' + borderColor + ';padding:12px;margin-bottom:10px;border-radius:6px;">';
          html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">';
          html += '<strong style="color:#333;">' + alerta.tipo.replace(/_/g, ' ') + '</strong>';
          html += '<span style="background:' + borderColor + ';color:#fff;padding:2px 8px;border-radius:10px;font-size:10px;">' + alerta.severidade + '</span>';
          html += '</div>';
          html += '<p style="margin:0 0 6px 0;color:#555;">' + alerta.mensagem + '</p>';
          html += '<p style="margin:0;font-size:12px;color:#666;">üí° ' + alerta.acao + '</p>';
          html += '</div>';
        });
      } else {
        html += '<div style="text-align:center;padding:30px;color:#2e7d32;background:#e8f5e9;border-radius:8px;">';
        html += '<span style="font-size:32px;">‚úÖ</span><br><strong>Nenhum alerta no momento!</strong>';
        html += '</div>';
      }
      
      if (data.recomendacaoIA) {
        html += '<div style="background:#f5f5f5;padding:16px;border-radius:8px;margin-top:16px;">';
        html += '<h4 style="margin:0 0 8px 0;color:#7c3aed;">ü§ñ Recomenda√ß√£o da IA:</h4>';
        html += '<p style="margin:0;color:#333;">' + data.recomendacaoIA + '</p>';
        html += '</div>';
      }
      
      html += '</div></div>';
      container.innerHTML = html;
    }

    function generateReport(type) {
      const container = document.getElementById('analysisResults');

      if (type === 'fornecedor') {
        // Mostrar modal de sele√ß√£o de fornecedor
        showFornecedorSelector();
        return;
      }

      if (type === 'mensal') {
        container.innerHTML = '<div style="text-align:center;padding:40px;"><div class="spinner"></div><p style="margin-top:16px;color:#333;">Gerando relat√≥rio mensal...</p></div>';

        google.script.run
          .withSuccessHandler(function (result) {
            if (result && result.success && result.data) {
              renderRelatorioMensal(result.data);
            } else {
              container.innerHTML = '<div style="background:#fff3e0;border:2px solid #e65100;border-radius:8px;padding:20px;text-align:center;"><span style="font-size:24px;">‚ö†Ô∏è</span><br><strong style="color:#bf360c;">Nenhum dado encontrado para o per√≠odo</strong></div>';
            }
          })
          .withFailureHandler(function (e) {
            container.innerHTML = '<div style="background:#ffebee;border:2px solid #c62828;border-radius:8px;padding:20px;text-align:center;"><span style="font-size:24px;">‚ùå</span><br><strong style="color:#b71c1c;">Erro: ' + (e.message || e) + '</strong></div>';
          })
          .runTrendsServer({});
      }
    }

    // Seletor de Fornecedor com dropdown din√¢mico
    function showFornecedorSelector() {
      const container = document.getElementById('analysisResults');
      container.innerHTML = '<div style="text-align:center;padding:40px;"><div class="spinner"></div><p style="margin-top:16px;color:#333;">Carregando fornecedores...</p></div>';

      google.script.run
        .withSuccessHandler(function (result) {
          if (result && result.success && result.data && result.data.length > 0) {
            let html = '<div style="background:#fff;border:2px solid #1565c0;border-radius:12px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.15);">';
            html += '<div style="background:#1565c0;color:#fff;padding:16px 20px;font-size:18px;font-weight:700;">üè¢ Relat√≥rio por Fornecedor</div>';
            html += '<div style="padding:24px;">';
            html += '<p style="color:#555;margin-bottom:16px;">Selecione um fornecedor para visualizar o relat√≥rio detalhado:</p>';
            html += '<select id="selectFornecedor" class="form-input" style="width:100%;padding:12px;font-size:15px;margin-bottom:16px;">';
            html += '<option value="">-- Selecione um fornecedor --</option>';

            result.data.forEach(function (f) {
              const nome = f.nome || f.Nome || f.Razao_Social || f.razao_social || 'Sem nome';
              const cnpj = f.cnpj || f.CNPJ || '';
              const id = f.id || f.ID || cnpj || nome;
              html += '<option value="' + id + '" data-nome="' + nome + '" data-cnpj="' + cnpj + '">' + nome + (cnpj ? ' (' + cnpj + ')' : '') + '</option>';
            });

            html += '</select>';
            html += '<button class="btn btn-primary" onclick="gerarRelatorioFornecedor()" style="width:100%;padding:12px;font-size:15px;">';
            html += '<span class="material-symbols-outlined" style="vertical-align:middle;margin-right:8px;">analytics</span>Gerar Relat√≥rio</button>';
            html += '</div></div>';

            container.innerHTML = html;
          } else {
            container.innerHTML = '<div style="background:#fff3e0;border:2px solid #e65100;border-radius:8px;padding:20px;text-align:center;"><span style="font-size:24px;">‚ö†Ô∏è</span><br><strong style="color:#bf360c;">Nenhum fornecedor cadastrado</strong></div>';
          }
        })
        .withFailureHandler(function (e) {
          container.innerHTML = '<div style="background:#ffebee;border:2px solid #c62828;border-radius:8px;padding:20px;text-align:center;"><span style="font-size:24px;">‚ùå</span><br><strong style="color:#b71c1c;">Erro ao carregar fornecedores: ' + (e.message || e) + '</strong></div>';
        })
        .listarFornecedoresAtivos();
    }

    function gerarRelatorioFornecedor() {
      const select = document.getElementById('selectFornecedor');
      if (!select || !select.value) {
        toast('Selecione um fornecedor', 'warning');
        return;
      }

      const selectedOption = select.options[select.selectedIndex];
      const fornecedorNome = selectedOption.getAttribute('data-nome');
      const fornecedorCnpj = selectedOption.getAttribute('data-cnpj');

      const container = document.getElementById('analysisResults');
      container.innerHTML = '<div style="text-align:center;padding:40px;"><div class="spinner"></div><p style="margin-top:16px;color:#333;">Gerando relat√≥rio de ' + fornecedorNome + '...</p></div>';

      google.script.run
        .withSuccessHandler(function (result) {
          if (result && result.success && result.data) {
            renderRelatorioFornecedor(result.data, fornecedorNome);
          } else {
            container.innerHTML = '<div style="background:#fff3e0;border:2px solid #e65100;border-radius:8px;padding:20px;text-align:center;"><span style="font-size:24px;">‚ö†Ô∏è</span><br><strong style="color:#bf360c;">Nenhum dado encontrado para este fornecedor</strong></div>';
          }
        })
        .withFailureHandler(function (e) {
          container.innerHTML = '<div style="background:#ffebee;border:2px solid #c62828;border-radius:8px;padding:20px;text-align:center;"><span style="font-size:24px;">‚ùå</span><br><strong style="color:#b71c1c;">Erro: ' + (e.message || e) + '</strong></div>';
        })
        .runTrendsServer({ fornecedor: fornecedorNome });
    }

    // Renderiza Relat√≥rio Mensal (formato tabular/estruturado)
    function renderRelatorioMensal(data) {
      const container = document.getElementById('analysisResults');
      const resumo = data.resumo || {};
      const tendencias = data.tendencias || {};

      let html = '<div style="background:#fff;border:2px solid #2e7d32;border-radius:12px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.15);">';
      html += '<div style="background:#2e7d32;color:#fff;padding:16px 20px;font-size:18px;font-weight:700;">üìä Relat√≥rio Mensal Consolidado</div>';
      html += '<div style="padding:20px;">';

      // Tabela de Resumo Geral
      html += '<h3 style="color:#1b5e20;margin:0 0 12px 0;font-size:16px;">üìã Resumo Geral</h3>';
      html += '<table style="width:100%;border-collapse:collapse;margin-bottom:24px;background:#f5f5f5;border-radius:8px;overflow:hidden;">';
      html += '<thead><tr style="background:#2e7d32;color:#fff;"><th style="padding:12px;text-align:left;">Indicador</th><th style="padding:12px;text-align:right;">Valor</th></tr></thead>';
      html += '<tbody>';
      html += '<tr style="border-bottom:1px solid #ddd;"><td style="padding:10px;">Total de Fornecedores Ativos</td><td style="padding:10px;text-align:right;font-weight:700;">' + (resumo.totalFornecedores || 0) + '</td></tr>';
      html += '<tr style="border-bottom:1px solid #ddd;"><td style="padding:10px;">Escolas Atendidas</td><td style="padding:10px;text-align:right;font-weight:700;">' + (resumo.totalEscolas || 0) + '</td></tr>';
      html += '<tr style="border-bottom:1px solid #ddd;"><td style="padding:10px;">Valor Total em NFs</td><td style="padding:10px;text-align:right;font-weight:700;color:#2e7d32;">R$ ' + (resumo.valorTotalNFs || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) + '</td></tr>';
      html += '</tbody></table>';

      // Tabela de Fornecedores
      if (tendencias.fornecedores && tendencias.fornecedores.length > 0) {
        html += '<h3 style="color:#1565c0;margin:0 0 12px 0;font-size:16px;">üè¢ Ranking de Fornecedores</h3>';
        html += '<table style="width:100%;border-collapse:collapse;margin-bottom:24px;background:#fff;border:1px solid #ddd;border-radius:8px;overflow:hidden;">';
        html += '<thead><tr style="background:#1565c0;color:#fff;"><th style="padding:10px;text-align:center;">#</th><th style="padding:10px;text-align:left;">Fornecedor</th><th style="padding:10px;text-align:center;">NFs</th><th style="padding:10px;text-align:right;">Valor Total</th></tr></thead>';
        html += '<tbody>';

        tendencias.fornecedores.forEach(function (f, idx) {
          const bgColor = idx % 2 === 0 ? '#fff' : '#f9f9f9';
          html += '<tr style="background:' + bgColor + ';border-bottom:1px solid #eee;">';
          html += '<td style="padding:10px;text-align:center;font-weight:700;color:#1565c0;">' + (idx + 1) + '</td>';
          html += '<td style="padding:10px;">' + f.fornecedor + '</td>';
          html += '<td style="padding:10px;text-align:center;">' + f.qtd + '</td>';
          html += '<td style="padding:10px;text-align:right;font-weight:600;">R$ ' + f.total.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) + '</td>';
          html += '</tr>';
        });

        html += '</tbody></table>';
      }

      // Tabela de Escolas
      if (tendencias.escolas && tendencias.escolas.length > 0) {
        html += '<h3 style="color:#7c3aed;margin:0 0 12px 0;font-size:16px;">üè´ Escolas por Volume de Recebimento</h3>';
        html += '<table style="width:100%;border-collapse:collapse;background:#fff;border:1px solid #ddd;border-radius:8px;overflow:hidden;">';
        html += '<thead><tr style="background:#7c3aed;color:#fff;"><th style="padding:10px;text-align:center;">#</th><th style="padding:10px;text-align:left;">Escola</th><th style="padding:10px;text-align:center;">Recebimentos</th><th style="padding:10px;text-align:center;">Qtd Total</th><th style="padding:10px;text-align:center;">Taxa Recusa</th></tr></thead>';
        html += '<tbody>';

        tendencias.escolas.forEach(function (e, idx) {
          const bgColor = idx % 2 === 0 ? '#fff' : '#f9f9f9';
          html += '<tr style="background:' + bgColor + ';border-bottom:1px solid #eee;">';
          html += '<td style="padding:10px;text-align:center;font-weight:700;color:#7c3aed;">' + (idx + 1) + '</td>';
          html += '<td style="padding:10px;">' + e.escola + '</td>';
          html += '<td style="padding:10px;text-align:center;">' + e.recebimentos + '</td>';
          html += '<td style="padding:10px;text-align:center;">' + e.qtdTotal.toLocaleString('pt-BR') + '</td>';
          html += '<td style="padding:10px;text-align:center;">' + e.taxaRecusa + '</td>';
          html += '</tr>';
        });

        html += '</tbody></table>';
      }

      html += '</div></div>';
      container.innerHTML = html;
    }

    // Renderiza Relat√≥rio por Fornecedor (detalhado)
    function renderRelatorioFornecedor(data, fornecedorNome) {
      const container = document.getElementById('analysisResults');
      const resumo = data.resumo || {};
      const tendencias = data.tendencias || {};

      // Encontrar dados do fornecedor espec√≠fico
      const fornecedorData = tendencias.fornecedores ? tendencias.fornecedores.find(f => f.fornecedor === fornecedorNome) : null;

      let html = '<div style="background:#fff;border:2px solid #e65100;border-radius:12px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.15);">';
      html += '<div style="background:#e65100;color:#fff;padding:16px 20px;font-size:18px;font-weight:700;">üè¢ Relat√≥rio: ' + fornecedorNome + '</div>';
      html += '<div style="padding:20px;">';

      if (fornecedorData) {
        // Cards de m√©tricas
        html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px;">';
        html += '<div style="background:#fff3e0;border-left:4px solid #e65100;padding:16px;border-radius:6px;text-align:center;"><div style="font-size:11px;color:#e65100;font-weight:600;text-transform:uppercase;">Notas Fiscais</div><div style="font-size:32px;font-weight:700;color:#bf360c;">' + fornecedorData.qtd + '</div></div>';
        html += '<div style="background:#e8f5e9;border-left:4px solid #2e7d32;padding:16px;border-radius:6px;text-align:center;"><div style="font-size:11px;color:#2e7d32;font-weight:600;text-transform:uppercase;">Valor Total</div><div style="font-size:24px;font-weight:700;color:#1b5e20;">R$ ' + fornecedorData.total.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) + '</div></div>';
        html += '<div style="background:#e3f2fd;border-left:4px solid #1565c0;padding:16px;border-radius:6px;text-align:center;"><div style="font-size:11px;color:#1565c0;font-weight:600;text-transform:uppercase;">Ticket M√©dio</div><div style="font-size:24px;font-weight:700;color:#0d47a1;">R$ ' + (fornecedorData.total / fornecedorData.qtd).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) + '</div></div>';
        html += '</div>';

        // Posi√ß√£o no ranking
        const posicao = tendencias.fornecedores.findIndex(f => f.fornecedor === fornecedorNome) + 1;
        const totalFornecedores = tendencias.fornecedores.length;
        html += '<div style="background:#f5f5f5;border-radius:8px;padding:16px;margin-bottom:16px;">';
        html += '<div style="font-weight:700;color:#333;margin-bottom:8px;">üìä Posi√ß√£o no Ranking</div>';
        html += '<div style="display:flex;align-items:center;gap:12px;">';
        html += '<div style="width:48px;height:48px;background:linear-gradient(135deg,#e65100,#ff9800);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;">' + posicao + '¬∫</div>';
        html += '<div><div style="font-size:14px;color:#333;">de ' + totalFornecedores + ' fornecedores ativos</div>';
        html += '<div style="font-size:12px;color:#666;">Representa ' + ((fornecedorData.total / resumo.valorTotalNFs) * 100).toFixed(1) + '% do valor total</div></div>';
        html += '</div></div>';
      } else {
        html += '<div style="background:#fff3e0;border-radius:8px;padding:20px;text-align:center;"><span style="font-size:24px;">üì≠</span><br><strong style="color:#bf360c;">Nenhuma movimenta√ß√£o encontrada para este fornecedor no per√≠odo</strong></div>';
      }

      // Bot√£o para voltar
      html += '<button class="btn btn-secondary" onclick="showFornecedorSelector()" style="margin-top:16px;"><span class="material-symbols-outlined" style="vertical-align:middle;margin-right:8px;">arrow_back</span>Selecionar outro fornecedor</button>';

      html += '</div></div>';
      container.innerHTML = html;
    }

    // ============================================
    // UTILIT√ÅRIOS
    // ============================================
    function formatNumber(num) {
      return Number(num || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      try {
        const d = new Date(dateStr);
        return d.toLocaleDateString('pt-BR');
      } catch (e) {
        return dateStr;
      }
    }

    function today() {
      return new Date().toISOString().split('T')[0];
    }

    function getStatusClass(status) {
      if (!status) return 'badge-neutral';
      const s = status.toLowerCase().replace(/_/g, '');
      // Status de sucesso
      if (s.includes('atestada') || s.includes('entregue') || s.includes('completo') || s.includes('ok') ||
        s.includes('aprovado') || s.includes('aprovadototal') || s.includes('validado') || s.includes('emitido')) {
        return 'badge-success';
      }
      // Status de erro/problema
      if (s.includes('glosada') || s.includes('glosado') || s.includes('recusada') || s.includes('recusado') ||
        s.includes('problema') || s.includes('erro') || s.includes('rejeitado') || s.includes('cancelado')) {
        return 'badge-error';
      }
      // Status de alerta/pendente
      if (s.includes('pendente') || s.includes('parcial') || s.includes('aguardando') ||
        s.includes('emrecebimento') || s.includes('emanalise') || s.includes('revisao')) {
        return 'badge-warning';
      }
      // Status informativo
      if (s.includes('enviada') || s.includes('enviado') || s.includes('recebida') || s.includes('conferida')) {
        return 'badge-info';
      }
      return 'badge-neutral';
    }

    function filterTable(type) {
      // Implementar filtro de tabela
    }

    function openQuickAction() {
      openModal('nova-nf');
    }

    function gerarDadosTeste() {
      if (!confirm('Isso ir√° gerar dados de teste para demonstrar o workflow de NFs.\n\nOs dados incluem 5 cen√°rios:\n‚Ä¢ ARROZ - Aprova√ß√£o Total (100%)\n‚Ä¢ LEITE - Glosa Parcial (90%)\n‚Ä¢ FRANGO - Rejei√ß√£o Total (0%)\n‚Ä¢ FEIJ√ÉO - Em Recebimento (67%)\n‚Ä¢ BANANA - Enviada (aguardando)\n\nDeseja continuar?')) {
        return;
      }

      showLoading('Gerando dados de teste...');

      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          if (result && result.success) {
            toast('Dados de teste gerados com sucesso!', 'success');

            // Mostrar resumo
            var msg = 'Foram criados:\n\n';
            msg += '‚Ä¢ ' + result.data.notasFiscais + ' Notas Fiscais\n';
            msg += '‚Ä¢ ' + result.data.recebimentos + ' Recebimentos\n';
            msg += '‚Ä¢ ' + result.data.analises + ' An√°lises\n\n';
            msg += 'Cen√°rios dispon√≠veis:\n';
            result.cenarios.forEach(function (c) {
              msg += '‚Ä¢ ' + c.nome + ' - ' + c.descricao + '\n';
            });

            alert(msg);

            // Recarregar dados
            loadPageData(state.currentPage);
          } else {
            toast('Erro: ' + (result ? result.error : 'Erro desconhecido'), 'error');
          }
        })
        .withFailureHandler(function (e) {
          hideLoading();
          toast('Erro: ' + e.message, 'error');
        })
        .api_gerarDadosTeste();
    }

    function mostrarCenariosTeste() {
      google.script.run
        .withSuccessHandler(function (result) {
          if (result && result.success) {
            var html = '<div style="max-height:60vh;overflow-y:auto;">';
            html += '<h3 style="margin:0 0 16px 0;">üìä Cen√°rios de Teste do Workflow</h3>';
            html += '<p style="margin-bottom:16px;color:var(--text-secondary);font-size:14px;">Estes cen√°rios demonstram o fluxo completo: NF ‚Üí Distribui√ß√£o ‚Üí Recebimentos ‚Üí An√°lise</p>';

            result.data.forEach(function (c) {
              var statusColor = c.status === 'APROVADO' ? 'var(--success)' :
                c.status === 'GLOSADO' ? 'var(--warning)' :
                  c.status === 'REJEITADO' ? 'var(--error)' : 'var(--info)';

              html += '<div style="border:1px solid var(--border);border-radius:var(--radius-md);padding:12px;margin-bottom:12px;border-left:4px solid ' + statusColor + ';">';
              html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">';
              html += '<strong>' + c.produto + '</strong>';
              html += '<span class="badge" style="background:' + statusColor + ';color:white;">' + c.status + '</span>';
              html += '</div>';
              html += '<div style="font-size:13px;color:var(--text-secondary);">';
              html += '<div>Fornecedor: ' + c.fornecedor + '</div>';
              html += '<div>Quantidade: ' + c.quantidade + ' | Valor: R$ ' + formatNumber(c.valorTotal) + '</div>';
              html += '<div>Escolas: ' + c.escolas + ' | Recebimentos: ' + c.recebimentos + '</div>';
              html += '<div style="margin-top:4px;font-weight:500;">Resultado: ' + c.resultado.replace(/_/g, ' ') + '</div>';
              html += '</div></div>';
            });

            html += '</div>';

            document.getElementById('modalTitle').textContent = 'Cen√°rios de Teste';
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('modal').classList.add('active');
            document.getElementById('modalOverlay').classList.add('active');
          }
        })
        .withFailureHandler(function (e) {
          toast('Erro: ' + e.message, 'error');
        })
        .api_getCenariosTeste();
    }

    // ============================================
    // TOAST E LOADING
    // ============================================
    function toast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.innerHTML = `
        <span class="material-symbols-outlined" style="font-size:20px;">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info'}</span>
        <span>${message}</span>
      `;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'toastIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    function showLoading(text = 'Carregando...') {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }

    function handleError(error) {
      console.error(error);
      toast('Erro: ' + (error.message || 'Erro desconhecido'), 'error');
    }
  </script>
  <?!= include('Mobile_S20_Logic'); ?>
</body>

</html>