<link rel="stylesheet" href="design-system.css">
<script>
// Estado da aplicação
var appState = {
  currentUser: null,
  notes: [],
  categories: [],
  tags: [],
  currentView: 'login'
};

// Inicializar aplicação
window.onload = function() {
  checkSession();
  render();
};

function checkSession() {
  var user = localStorage.getItem('currentUser');
  if (user) {
    appState.currentUser = JSON.parse(user);
    appState.currentView = 'notes';
    loadUserData();
  }
}

function loadUserData() {
  if (!appState.currentUser) return;

  google.script.run
    .withSuccessHandler(function(notes) {
      appState.notes = notes;
      render();
    })
    .callBackend('getUserNotes', { userId: appState.currentUser.ID });

  google.script.run
    .withSuccessHandler(function(categories) {
      appState.categories = categories;
      render();
    })
    .callBackend('getUserCategories', { userId: appState.currentUser.ID });
}

function render() {
  var app = document.getElementById('app');

  switch(appState.currentView) {
    case 'login':
      app.innerHTML = renderLogin();
      break;
    case 'register':
      app.innerHTML = renderRegister();
      break;
    case 'notes':
      app.innerHTML = renderNotes();
      break;
    case 'newNote':
      app.innerHTML = renderNewNote();
      break;
  }
}

function renderLogin() {
  return `
    <div class="container auth-container">
      <h1>Login</h1>
      <div id="message"></div>
      <form onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Email</label>
          <input type="email" name="email" required>
        </div>
        <div class="form-group">
          <label>Senha</label>
          <input type="password" name="password" required>
        </div>
        <button type="submit">Entrar</button>
        <button type="button" class="btn-secondary" onclick="showRegister()">Criar Conta</button>
      </form>
    </div>
  `;
}

function renderRegister() {
  return `
    <div class="container auth-container">
      <h1>Criar Conta</h1>
      <div id="message"></div>
      <form onsubmit="handleRegister(event)">
        <div class="form-group">
          <label>Nome de Usuário</label>
          <input type="text" name="username" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" name="email" required>
        </div>
        <div class="form-group">
          <label>Senha</label>
          <input type="password" name="password" required>
        </div>
        <button type="submit">Criar Conta</button>
        <button type="button" class="btn-secondary" onclick="showLogin()">Já tenho conta</button>
      </form>
    </div>
  `;
}

function renderNotes() {
  var notesHtml = appState.notes.length > 0
    ? appState.notes.map(function(note) {
        return `
          <div class="note-card">
            <div class="note-title">${note.Title}</div>
            <div class="note-content">${note.Content.substring(0, 100)}...</div>
            <div class="note-meta">
              <span>${new Date(note.CreatedAt).toLocaleDateString()}</span>
              <div class="note-actions">
                <button class="btn-small" onclick="editNote('${note.ID}')">Editar</button>
                <button class="btn-small" onclick="deleteNote('${note.ID}')">Excluir</button>
              </div>
            </div>
          </div>
        `;
      }).join('')
    : '<p>Nenhuma nota encontrada. Crie sua primeira nota!</p>';

  return `
    <div class="container">
      <div class="header">
        <h1>Minhas Notas</h1>
        <div>
          <button class="btn-small" onclick="showNewNote()">Nova Nota</button>
          <button class="btn-small" onclick="logout()">Sair</button>
        </div>
      </div>
      <div class="notes-grid">
        ${notesHtml}
      </div>
    </div>
  `;
}

function renderNewNote() {
  return `
    <div class="container">
      <h2>Nova Nota</h2>
      <form onsubmit="handleCreateNote(event)">
        <div class="form-group">
          <label>Título</label>
          <input type="text" name="title" required>
        </div>
        <div class="form-group">
          <label>Conteúdo</label>
          <textarea name="content" required></textarea>
        </div>
        <button type="submit">Salvar Nota</button>
        <button type="button" class="btn-secondary" onclick="showNotes()">Cancelar</button>
      </form>
    </div>
  `;
}

function handleLogin(event) {
  event.preventDefault();
  var form = event.target;

  google.script.run
    .withSuccessHandler(function(user) {
      appState.currentUser = user;
      localStorage.setItem('currentUser', JSON.stringify(user));
      appState.currentView = 'notes';
      loadUserData();
    })
    .withFailureHandler(function(error) {
      showMessage('error', error.message);
    })
    .callBackend('login', {
      email: form.email.value,
      password: form.password.value
    });
}

function handleRegister(event) {
  event.preventDefault();
  var form = event.target;

  google.script.run
    .withSuccessHandler(function(user) {
      showMessage('success', 'Conta criada com sucesso!');
      setTimeout(showLogin, 2000);
    })
    .withFailureHandler(function(error) {
      showMessage('error', error.message);
    })
    .callBackend('register', {
      username: form.username.value,
      email: form.email.value,
      password: form.password.value
    });
}

function handleCreateNote(event) {
  event.preventDefault();
  var form = event.target;

  google.script.run
    .withSuccessHandler(function(note) {
      appState.notes.unshift(note);
      showNotes();
    })
    .withFailureHandler(function(error) {
      alert('Erro ao criar nota: ' + error.message);
    })
    .callBackend('createNote', {
      userId: appState.currentUser.ID,
      title: form.title.value,
      content: form.content.value,
      categoryId: '',
      tags: []
    });
}

function deleteNote(noteId) {
  if (!confirm('Deseja realmente excluir esta nota?')) return;

  google.script.run
    .withSuccessHandler(function() {
      appState.notes = appState.notes.filter(function(n) { return n.ID !== noteId; });
      render();
    })
    .withFailureHandler(function(error) {
      alert('Erro ao excluir nota: ' + error.message);
    })
    .callBackend('deleteNote', {
      noteId: noteId,
      userId: appState.currentUser.ID
    });
}

function showLogin() {
  appState.currentView = 'login';
  render();
}

function showRegister() {
  appState.currentView = 'register';
  render();
}

function showNotes() {
  appState.currentView = 'notes';
  render();
}

function showNewNote() {
  appState.currentView = 'newNote';
  render();
}

function logout() {
  localStorage.removeItem('currentUser');
  appState.currentUser = null;
  appState.notes = [];
  showLogin();
}

function showMessage(type, message) {
  var messageDiv = document.getElementById('message');
  messageDiv.className = type;
  messageDiv.textContent = message;
}
</script>
