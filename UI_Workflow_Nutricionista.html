<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#059669">
  <title>Nutricionista - UNIAE</title>
  <style>
    :root {
      --primary: #059669;
      --primary-dark: #047857;
      --primary-light: #d1fae5;
      --success: #0d652d;
      --success-light: #e6f4ea;
      --error: #c5221f;
      --error-light: #fce8e6;
      --warning: #e37400;
      --warning-light: #fef7e0;
      --info: #1a73e8;
      --info-light: #e8f0fe;
      --text: #202124;
      --text-secondary: #5f6368;
      --bg: #f8f9fa;
      --surface: #fff;
      --border: #dadce0;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: calc(80px + var(--safe-bottom));
    }
  </style>
</head>

<body>
  <header class="header">
    <h1>ü•ó Nutricionista</h1>
    <div class="header-sub">Gest√£o Nutricional - UNIAE</div>
  </header>

  <main class="container">
    <div id="alertBox" class="alert hidden"></div>

    <!-- Tabs de Navega√ß√£o -->
    <div class="tabs">
      <button class="tab active" onclick="trocarTab('cardapios')">üçΩÔ∏è Card√°pios</button>
      <button class="tab" onclick="trocarTab('substituicoes')">üîÑ Substitui√ß√µes</button>
      <button class="tab" onclick="trocarTab('pareceres')">üìù Pareceres</button>
      <button class="tab" onclick="trocarTab('descartes')">üóëÔ∏è Descartes</button>
    </div>

    <!-- Tab: Card√°pios Especiais -->
    <div id="tabCardapios" class="tab-content">
      <div class="card">
        <div class="card-title">üìã Card√°pios Especiais Pendentes</div>
        <div id="listaCardapios">
          <p class="empty-state">Carregando...</p>
        </div>
      </div>
    </div>

    <!-- Tab: Substitui√ß√µes -->
    <div id="tabSubstituicoes" class="tab-content hidden">
      <div class="card">
        <div class="card-title">üîÑ Substitui√ß√µes Pendentes</div>
        <div id="listaSubstituicoes">
          <p class="empty-state">Carregando...</p>
        </div>
      </div>
    </div>

    <!-- Tab: Pareceres -->
    <div id="tabPareceres" class="tab-content hidden">
      <div class="card">
        <div class="card-title">üìù Emitir Parecer T√©cnico</div>
        <div class="form-group">
          <label>Tipo de Parecer</label>
          <select id="tipoParecer">
            <option value="">Selecione...</option>
            <option value="PRODUTO">Avalia√ß√£o de Produto</option>
            <option value="FORNECEDOR">Avalia√ß√£o de Fornecedor</option>
            <option value="CARDAPIO">Parecer sobre Card√°pio</option>
            <option value="SUBSTITUICAO">Parecer sobre Substitui√ß√£o</option>
            <option value="OUTRO">Outro</option>
          </select>
        </div>
        <div class="form-group">
          <label>Assunto *</label>
          <input type="text" id="assuntoParecer" placeholder="Assunto do parecer">
        </div>
        <div class="form-group">
          <label>Refer√™ncia</label>
          <input type="text" id="referenciaParecer" placeholder="NF, Produto, Fornecedor...">
        </div>
        <div class="form-group">
          <label>Parecer T√©cnico *</label>
          <textarea id="textoParecer" rows="4" placeholder="Descreva o parecer t√©cnico..."></textarea>
        </div>
        <div class="form-group">
          <label>Conclus√£o</label>
          <select id="conclusaoParecer">
            <option value="FAVORAVEL">Favor√°vel</option>
            <option value="FAVORAVEL_COM_RESSALVAS">Favor√°vel com Ressalvas</option>
            <option value="DESFAVORAVEL">Desfavor√°vel</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="emitirParecer()">üìù Emitir Parecer</button>
      </div>

      <div class="card">
        <div class="card-title">üìã Pareceres Recentes</div>
        <div id="listaPareceres">
          <p class="empty-state">Carregando...</p>
        </div>
      </div>
    </div>

    <!-- Tab: Descartes -->
    <div id="tabDescartes" class="tab-content hidden">
      <div class="card">
        <div class="card-title">üóëÔ∏è Ocorr√™ncias de Descarte Pendentes</div>
        <div id="listaDescartes">
          <p class="empty-state">Carregando...</p>
        </div>
      </div>
    </div>

    <!-- Modal de Valida√ß√£o de Descarte -->
    <div class="modal-overlay hidden" id="modalDescarte">
      <div class="modal">
        <div class="modal-header">
          <h3>üóëÔ∏è Validar Descarte</h3>
          <button class="close-btn" onclick="fecharModal('modalDescarte')">√ó</button>
        </div>
        <div class="modal-body">
          <div id="infoDescarte" class="info-box"></div>

          <div class="form-group">
            <label>Parecer Nutricional *</label>
            <textarea id="parecerDescarte" rows="3" placeholder="Avalie a necessidade do descarte..."></textarea>
          </div>

          <div class="form-group">
            <label>A√ß√£o Corretiva</label>
            <textarea id="acaoCorretiva" rows="2" placeholder="Recomenda√ß√µes para evitar recorr√™ncia..."></textarea>
          </div>

          <div class="decisao-grid">
            <button class="decisao-btn" onclick="selecionarDecisaoDescarte('VALIDADO', this)">
              <span class="icon">‚úÖ</span>
              <span class="label">Validar</span>
            </button>
            <button class="decisao-btn" onclick="selecionarDecisaoDescarte('REJEITADO', this)">
              <span class="icon">‚ùå</span>
              <span class="label">Rejeitar</span>
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="fecharModal('modalDescarte')">Cancelar</button>
          <button class="btn btn-primary" onclick="salvarValidacaoDescarte()">Salvar</button>
        </div>
      </div>
    </div>

    <!-- Modal de Avalia√ß√£o de Card√°pio -->
    <div class="modal-overlay hidden" id="modalCardapio">
      <div class="modal">
        <div class="modal-header">
          <h3>üçΩÔ∏è Avaliar Card√°pio Especial</h3>
          <button class="close-btn" onclick="fecharModal('modalCardapio')">√ó</button>
        </div>
        <div class="modal-body">
          <div id="infoCardapio" class="info-box"></div>

          <div class="form-group">
            <label>Parecer T√©cnico *</label>
            <textarea id="parecerCardapio" rows="3" placeholder="Descreva seu parecer..."></textarea>
          </div>

          <div class="form-group">
            <label>Recomenda√ß√µes</label>
            <textarea id="recomendacoesCardapio" rows="2" placeholder="Recomenda√ß√µes nutricionais..."></textarea>
          </div>

          <div class="decisao-grid">
            <button class="decisao-btn" onclick="selecionarDecisaoCardapio('APROVADO', this)">
              <span class="icon">‚úÖ</span>
              <span class="label">Aprovar</span>
            </button>
            <button class="decisao-btn" onclick="selecionarDecisaoCardapio('REVISAO', this)">
              <span class="icon">üîÑ</span>
              <span class="label">Solicitar Revis√£o</span>
            </button>
            <button class="decisao-btn" onclick="selecionarDecisaoCardapio('REPROVADO', this)">
              <span class="icon">‚ùå</span>
              <span class="label">Reprovar</span>
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="fecharModal('modalCardapio')">Cancelar</button>
          <button class="btn btn-primary" onclick="salvarAvaliacaoCardapio()">Salvar Avalia√ß√£o</button>
        </div>
      </div>
    </div>

    <!-- Modal de Avalia√ß√£o de Substitui√ß√£o -->
    <div class="modal-overlay hidden" id="modalSubstituicao">
      <div class="modal">
        <div class="modal-header">
          <h3>üîÑ Avaliar Substitui√ß√£o</h3>
          <button class="close-btn" onclick="fecharModal('modalSubstituicao')">√ó</button>
        </div>
        <div class="modal-body">
          <div id="infoSubstituicao" class="info-box"></div>

          <div class="form-group">
            <label>Parecer Nutricional</label>
            <textarea id="parecerSubstituicao" rows="3" placeholder="Avalie a equival√™ncia nutricional..."></textarea>
          </div>

          <div class="decisao-grid">
            <button class="decisao-btn" onclick="selecionarDecisaoSub('APROVADO', this)">
              <span class="icon">‚úÖ</span>
              <span class="label">Aprovar</span>
            </button>
            <button class="decisao-btn" onclick="selecionarDecisaoSub('REJEITADO', this)">
              <span class="icon">‚ùå</span>
              <span class="label">Rejeitar</span>
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="fecharModal('modalSubstituicao')">Cancelar</button>
          <button class="btn btn-primary" onclick="salvarAvaliacaoSubstituicao()">Salvar</button>
        </div>
      </div>
    </div>
  </main>

  <style>
    .header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: calc(16px + var(--safe-top)) 16px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 600;
    }

    .header-sub {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 4px;
    }

    .container {
      padding: 16px;
      max-width: 500px;
      margin: 0 auto;
    }

    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      background: var(--surface);
      border-radius: 12px;
      padding: 4px;
    }

    .tab {
      flex: 1;
      padding: 10px 8px;
      border: none;
      background: transparent;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .tab.active {
      background: var(--primary);
      color: white;
    }

    .tab-content.hidden {
      display: none;
    }

    .card {
      background: var(--surface);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 14px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 14px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 14px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 5px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    .alert {
      padding: 12px 14px;
      border-radius: 10px;
      margin-bottom: 14px;
      font-size: 13px;
    }

    .alert-error {
      background: var(--error-light);
      color: var(--error);
    }

    .alert-success {
      background: var(--success-light);
      color: var(--success);
    }

    .hidden {
      display: none !important;
    }

    .empty-state {
      text-align: center;
      padding: 30px;
      color: var(--text-secondary);
    }

    .item-card {
      background: var(--bg);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
      border: 2px solid var(--border);
      cursor: pointer;
    }

    .item-card:active {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .item-title {
      font-weight: 700;
      font-size: 14px;
    }

    .item-info {
      font-size: 12px;
      color: var(--text-secondary);
      margin: 4px 0;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-pendente {
      background: var(--warning-light);
      color: var(--warning);
    }

    .badge-aprovado {
      background: var(--success-light);
      color: var(--success);
    }

    .badge-diabetes {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-celiaca {
      background: #fce7f3;
      color: #9d174d;
    }

    .badge-lactose {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge-alergia {
      background: var(--error-light);
      color: var(--error);
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-secondary {
      background: var(--bg);
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .decisao-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin: 16px 0;
    }

    .decisao-btn {
      padding: 12px 8px;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: var(--surface);
      cursor: pointer;
      text-align: center;
    }

    .decisao-btn:active,
    .decisao-btn.selected {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .decisao-btn .icon {
      font-size: 24px;
      display: block;
      margin-bottom: 4px;
    }

    .decisao-btn .label {
      font-size: 11px;
      font-weight: 600;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal {
      background: var(--surface);
      border-radius: 16px;
      max-width: 400px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 16px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .modal-body {
      padding: 16px;
    }

    .modal-footer {
      padding: 16px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }

    .modal-footer .btn {
      flex: 1;
    }

    .info-box {
      background: var(--bg);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 16px;
    }

    .info-box p {
      margin: 4px 0;
      font-size: 13px;
    }

    .info-box strong {
      color: var(--primary);
    }

    .parecer-item {
      background: var(--bg);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .parecer-item .tipo {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .parecer-item .assunto {
      font-weight: 600;
      font-size: 14px;
      margin: 4px 0;
    }

    .parecer-item .data {
      font-size: 11px;
      color: var(--text-secondary);
    }
  </style>

  <script>
    var cardapioSelecionado = null;
    var substituicaoSelecionada = null;
    var descarteSelecionado = null;
    var decisaoCardapio = null;
    var decisaoSubstituicao = null;
    var decisaoDescarte = null;
    var nutricionista = { nome: '', crn: '' };

    document.addEventListener('DOMContentLoaded', function () {
      carregarDadosNutricionista();
      carregarCardapios();
      carregarSubstituicoes();
      carregarPareceres();
    });

    function carregarDadosNutricionista() {
      google.script.run
        .withSuccessHandler(function (sessao) {
          if (sessao && sessao.usuario) {
            nutricionista.nome = sessao.usuario.nome || sessao.usuario.email;
            nutricionista.crn = sessao.usuario.crn || '';
          }
        })
        .withFailureHandler(function () { })
        .obterSessaoAtual();
    }

    function trocarTab(tab) {
      document.querySelectorAll('.tab').forEach(function (t) { t.classList.remove('active'); });
      document.querySelectorAll('.tab-content').forEach(function (c) { c.classList.add('hidden'); });

      event.target.classList.add('active');
      document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');

      if (tab === 'cardapios') carregarCardapios();
      else if (tab === 'substituicoes') carregarSubstituicoes();
      else if (tab === 'pareceres') carregarPareceres();
      else if (tab === 'descartes') carregarDescartes();
    }

    function carregarCardapios() {
      document.getElementById('listaCardapios').innerHTML = '<p class="empty-state">Carregando...</p>';
      google.script.run
        .withSuccessHandler(renderizarCardapios)
        .withFailureHandler(function () { renderizarCardapios([]); })
        .listarCardapiosEspeciaisPendentes();
    }

    function renderizarCardapios(cardapios) {
      if (!cardapios || cardapios.length === 0) {
        document.getElementById('listaCardapios').innerHTML =
          '<p class="empty-state">‚úÖ Nenhum card√°pio pendente</p>';
        return;
      }

      var html = '';
      cardapios.forEach(function (c) {
        var badgeClass = getBadgeClass(c.tipoRestricao);
        html += '<div class="item-card" onclick="abrirAvaliacaoCardapio(\'' + c.id + '\')">';
        html += '<div class="item-header">';
        html += '<span class="item-title">' + c.nomeAluno + '</span>';
        html += '<span class="badge ' + badgeClass + '">' + formatarRestricao(c.tipoRestricao) + '</span>';
        html += '</div>';
        html += '<div class="item-info">üè´ ' + c.escola + '</div>';
        html += '<div class="item-info">üìã CID: ' + (c.cid || 'N√£o informado') + '</div>';
        html += '<div class="item-info">' + (c.laudoMedico ? '‚úÖ Laudo anexado' : '‚ö†Ô∏è Sem laudo') + '</div>';
        html += '</div>';
      });
      document.getElementById('listaCardapios').innerHTML = html;
    }

    function getBadgeClass(tipo) {
      if (tipo && tipo.includes('DIABETES')) return 'badge-diabetes';
      if (tipo && tipo.includes('CELIACA')) return 'badge-celiaca';
      if (tipo && tipo.includes('LACTOSE')) return 'badge-lactose';
      if (tipo && tipo.includes('ALERGIA')) return 'badge-alergia';
      return 'badge-pendente';
    }

    function formatarRestricao(tipo) {
      var map = {
        'DIABETES': 'Diabetes', 'DOENCA_CELIACA': 'Cel√≠aca',
        'INTOLERANCIA_LACTOSE': 'Lactose', 'APLV': 'APLV',
        'ALERGIA_AMENDOIM': 'Alergia Amendoim', 'VEGANO': 'Vegano',
        'VEGETARIANO': 'Vegetariano'
      };
      return map[tipo] || tipo || 'Outro';
    }

    function abrirAvaliacaoCardapio(id) {
      google.script.run
        .withSuccessHandler(function (cardapios) {
          cardapioSelecionado = cardapios.find(function (c) { return c.id === id; });
          if (cardapioSelecionado) {
            document.getElementById('infoCardapio').innerHTML =
              '<p><strong>Aluno:</strong> ' + cardapioSelecionado.nomeAluno + '</p>' +
              '<p><strong>Escola:</strong> ' + cardapioSelecionado.escola + '</p>' +
              '<p><strong>Restri√ß√£o:</strong> ' + formatarRestricao(cardapioSelecionado.tipoRestricao) + '</p>' +
              '<p><strong>CID:</strong> ' + (cardapioSelecionado.cid || 'N√£o informado') + '</p>' +
              '<p><strong>Laudo:</strong> ' + (cardapioSelecionado.laudoMedico ? '‚úÖ Anexado' : '‚ö†Ô∏è Pendente') + '</p>' +
              (cardapioSelecionado.observacoes ? '<p><strong>Obs:</strong> ' + cardapioSelecionado.observacoes + '</p>' : '');
            document.getElementById('modalCardapio').classList.remove('hidden');
          }
        })
        .listarCardapiosEspeciaisPendentes();
    }

    function selecionarDecisaoCardapio(decisao, el) {
      decisaoCardapio = decisao;
      document.querySelectorAll('#modalCardapio .decisao-btn').forEach(function (b) { b.classList.remove('selected'); });
      el.classList.add('selected');
    }

    function salvarAvaliacaoCardapio() {
      if (!cardapioSelecionado) { mostrarAlerta('Selecione um card√°pio', 'error'); return; }
      if (!decisaoCardapio) { mostrarAlerta('Selecione uma decis√£o', 'error'); return; }
      if (!document.getElementById('parecerCardapio').value.trim()) {
        mostrarAlerta('Parecer √© obrigat√≥rio', 'error'); return;
      }

      var dados = {
        cardapioId: cardapioSelecionado.id,
        nomeAluno: cardapioSelecionado.nomeAluno,
        escola: cardapioSelecionado.escola,
        tipoRestricao: cardapioSelecionado.tipoRestricao,
        nutricionista: nutricionista.nome || 'Nutricionista',
        crn: nutricionista.crn || '',
        parecer: document.getElementById('parecerCardapio').value.trim(),
        recomendacoes: document.getElementById('recomendacoesCardapio').value.trim().split('\n').filter(Boolean),
        decisao: decisaoCardapio
      };

      google.script.run
        .withSuccessHandler(function (res) {
          if (res.success) {
            mostrarAlerta('Avalia√ß√£o registrada com sucesso!', 'success');
            fecharModal('modalCardapio');
            carregarCardapios();
            limparFormCardapio();
          } else {
            mostrarAlerta(res.error || 'Erro ao salvar', 'error');
          }
        })
        .withFailureHandler(function (e) { mostrarAlerta('Erro: ' + e.message, 'error'); })
        .registrarAvaliacaoNutricional(dados);
    }

    function limparFormCardapio() {
      cardapioSelecionado = null;
      decisaoCardapio = null;
      document.getElementById('parecerCardapio').value = '';
      document.getElementById('recomendacoesCardapio').value = '';
      document.querySelectorAll('#modalCardapio .decisao-btn').forEach(function (b) { b.classList.remove('selected'); });
    }

    // === SUBSTITUI√á√ïES ===
    function carregarSubstituicoes() {
      document.getElementById('listaSubstituicoes').innerHTML = '<p class="empty-state">Carregando...</p>';
      google.script.run
        .withSuccessHandler(renderizarSubstituicoes)
        .withFailureHandler(function () { renderizarSubstituicoes([]); })
        .listarSubstituicoesPendentes();
    }

    function renderizarSubstituicoes(subs) {
      if (!subs || subs.length === 0) {
        document.getElementById('listaSubstituicoes').innerHTML =
          '<p class="empty-state">‚úÖ Nenhuma substitui√ß√£o pendente</p>';
        return;
      }

      var html = '';
      subs.forEach(function (s) {
        html += '<div class="item-card" onclick="abrirAvaliacaoSubstituicao(\'' + s.id + '\')">';
        html += '<div class="item-header">';
        html += '<span class="item-title">üîÑ Substitui√ß√£o</span>';
        html += '<span class="badge badge-pendente">Pendente</span>';
        html += '</div>';
        html += '<div class="item-info">üè´ ' + s.escola + '</div>';
        html += '<div class="item-info"><strong>De:</strong> ' + s.produtoOriginal + '</div>';
        html += '<div class="item-info"><strong>Para:</strong> ' + s.produtoSubstituto + '</div>';
        html += '<div class="item-info">üìù ' + (s.motivo || 'Sem motivo informado') + '</div>';
        html += '</div>';
      });
      document.getElementById('listaSubstituicoes').innerHTML = html;
    }

    function abrirAvaliacaoSubstituicao(id) {
      google.script.run
        .withSuccessHandler(function (subs) {
          substituicaoSelecionada = subs.find(function (s) { return s.id === id; });
          if (substituicaoSelecionada) {
            document.getElementById('infoSubstituicao').innerHTML =
              '<p><strong>Escola:</strong> ' + substituicaoSelecionada.escola + '</p>' +
              '<p><strong>Produto Original:</strong> ' + substituicaoSelecionada.produtoOriginal + '</p>' +
              '<p><strong>Substituto Proposto:</strong> ' + substituicaoSelecionada.produtoSubstituto + '</p>' +
              '<p><strong>Motivo:</strong> ' + (substituicaoSelecionada.motivo || 'N√£o informado') + '</p>' +
              '<p><strong>Solicitante:</strong> ' + (substituicaoSelecionada.solicitante || 'N√£o informado') + '</p>';
            document.getElementById('modalSubstituicao').classList.remove('hidden');
          }
        })
        .listarSubstituicoesPendentes();
    }

    function selecionarDecisaoSub(decisao, el) {
      decisaoSubstituicao = decisao;
      document.querySelectorAll('#modalSubstituicao .decisao-btn').forEach(function (b) { b.classList.remove('selected'); });
      el.classList.add('selected');
    }

    function salvarAvaliacaoSubstituicao() {
      if (!substituicaoSelecionada) { mostrarAlerta('Selecione uma substitui√ß√£o', 'error'); return; }
      if (!decisaoSubstituicao) { mostrarAlerta('Selecione uma decis√£o', 'error'); return; }

      var dados = {
        substituicaoId: substituicaoSelecionada.id,
        nutricionista: nutricionista.nome || 'Nutricionista',
        parecer: document.getElementById('parecerSubstituicao').value.trim(),
        decisao: decisaoSubstituicao
      };

      google.script.run
        .withSuccessHandler(function (res) {
          if (res.success) {
            mostrarAlerta(res.mensagem || 'Avalia√ß√£o salva!', 'success');
            fecharModal('modalSubstituicao');
            carregarSubstituicoes();
            substituicaoSelecionada = null;
            decisaoSubstituicao = null;
          } else {
            mostrarAlerta(res.error || 'Erro ao salvar', 'error');
          }
        })
        .withFailureHandler(function (e) { mostrarAlerta('Erro: ' + e.message, 'error'); })
        .avaliarSubstituicao(dados);
    }

    // === PARECERES ===
    function carregarPareceres() {
      document.getElementById('listaPareceres').innerHTML = '<p class="empty-state">Carregando...</p>';
      google.script.run
        .withSuccessHandler(renderizarPareceres)
        .withFailureHandler(function () { renderizarPareceres([]); })
        .listarPareceresTecnicos(10);
    }

    function renderizarPareceres(pareceres) {
      if (!pareceres || pareceres.length === 0) {
        document.getElementById('listaPareceres').innerHTML =
          '<p class="empty-state">Nenhum parecer emitido</p>';
        return;
      }

      var html = '';
      pareceres.forEach(function (p) {
        var data = p.dataEmissao ? new Date(p.dataEmissao).toLocaleDateString('pt-BR') : '';
        html += '<div class="parecer-item">';
        html += '<div class="tipo">' + (p.tipo || 'GERAL') + '</div>';
        html += '<div class="assunto">' + p.assunto + '</div>';
        html += '<div class="data">üìÖ ' + data + ' | üë§ ' + (p.nutricionista || '') + '</div>';
        html += '</div>';
      });
      document.getElementById('listaPareceres').innerHTML = html;
    }

    function emitirParecer() {
      var tipo = document.getElementById('tipoParecer').value;
      var assunto = document.getElementById('assuntoParecer').value.trim();
      var parecer = document.getElementById('textoParecer').value.trim();

      if (!tipo) { mostrarAlerta('Selecione o tipo de parecer', 'error'); return; }
      if (!assunto) { mostrarAlerta('Informe o assunto', 'error'); return; }
      if (!parecer) { mostrarAlerta('Escreva o parecer', 'error'); return; }

      var dados = {
        tipo: tipo,
        assunto: assunto,
        referencia: document.getElementById('referenciaParecer').value.trim(),
        parecer: parecer,
        conclusao: document.getElementById('conclusaoParecer').value,
        nutricionista: nutricionista.nome || 'Nutricionista',
        crn: nutricionista.crn || ''
      };

      google.script.run
        .withSuccessHandler(function (res) {
          if (res.success) {
            mostrarAlerta('Parecer emitido com sucesso! ID: ' + res.id, 'success');
            limparFormParecer();
            carregarPareceres();
          } else {
            mostrarAlerta(res.error || 'Erro ao emitir parecer', 'error');
          }
        })
        .withFailureHandler(function (e) { mostrarAlerta('Erro: ' + e.message, 'error'); })
        .emitirParecerTecnico(dados);
    }

    function limparFormParecer() {
      document.getElementById('tipoParecer').value = '';
      document.getElementById('assuntoParecer').value = '';
      document.getElementById('referenciaParecer').value = '';
      document.getElementById('textoParecer').value = '';
      document.getElementById('conclusaoParecer').value = 'FAVORAVEL';
    }

    // === DESCARTES ===
    function carregarDescartes() {
      document.getElementById('listaDescartes').innerHTML = '<p class="empty-state">Carregando...</p>';
      google.script.run
        .withSuccessHandler(renderizarDescartes)
        .withFailureHandler(function () { renderizarDescartes([]); })
        .listarOcorrenciasDescartePendentes();
    }

    function renderizarDescartes(descartes) {
      if (!descartes || descartes.length === 0) {
        document.getElementById('listaDescartes').innerHTML =
          '<p class="empty-state">‚úÖ Nenhum descarte pendente de valida√ß√£o</p>';
        return;
      }

      var html = '';
      descartes.forEach(function (d) {
        var data = d.dataOcorrencia ? new Date(d.dataOcorrencia).toLocaleDateString('pt-BR') : '';
        html += '<div class="item-card" onclick="abrirValidacaoDescarte(\'' + d.id + '\')">';
        html += '<div class="item-header">';
        html += '<span class="item-title">üóëÔ∏è ' + d.produto + '</span>';
        html += '<span class="badge badge-pendente">' + formatarMotivo(d.motivoDescarte) + '</span>';
        html += '</div>';
        html += '<div class="item-info">üè´ ' + d.escola + '</div>';
        html += '<div class="item-info">üì¶ ' + d.quantidade + ' ' + (d.unidade || 'UN') + '</div>';
        html += '<div class="item-info">üìÖ ' + data + '</div>';
        if (d.lote) html += '<div class="item-info">üè∑Ô∏è Lote: ' + d.lote + '</div>';
        html += '</div>';
      });
      document.getElementById('listaDescartes').innerHTML = html;
    }

    function formatarMotivo(motivo) {
      var map = {
        'VALIDADE_VENCIDA': 'Vencido',
        'CARACTERISTICAS_ALTERADAS': 'Alterado',
        'EMBALAGEM_VIOLADA': 'Embalagem',
        'TEMPERATURA_INADEQUADA': 'Temperatura',
        'CONTAMINACAO': 'Contamina√ß√£o',
        'OUTROS': 'Outros'
      };
      return map[motivo] || motivo || 'Outro';
    }

    function abrirValidacaoDescarte(id) {
      google.script.run
        .withSuccessHandler(function (descartes) {
          descarteSelecionado = descartes.find(function (d) { return d.id === id; });
          if (descarteSelecionado) {
            var data = descarteSelecionado.dataOcorrencia ? new Date(descarteSelecionado.dataOcorrencia).toLocaleDateString('pt-BR') : '';
            var validade = descarteSelecionado.validade ? new Date(descarteSelecionado.validade).toLocaleDateString('pt-BR') : 'N/A';
            document.getElementById('infoDescarte').innerHTML =
              '<p><strong>Produto:</strong> ' + descarteSelecionado.produto + '</p>' +
              '<p><strong>Quantidade:</strong> ' + descarteSelecionado.quantidade + ' ' + (descarteSelecionado.unidade || 'UN') + '</p>' +
              '<p><strong>Escola:</strong> ' + descarteSelecionado.escola + '</p>' +
              '<p><strong>Motivo:</strong> ' + formatarMotivo(descarteSelecionado.motivoDescarte) + '</p>' +
              '<p><strong>Data:</strong> ' + data + '</p>' +
              (descarteSelecionado.lote ? '<p><strong>Lote:</strong> ' + descarteSelecionado.lote + '</p>' : '') +
              '<p><strong>Validade:</strong> ' + validade + '</p>' +
              (descarteSelecionado.fornecedor ? '<p><strong>Fornecedor:</strong> ' + descarteSelecionado.fornecedor + '</p>' : '') +
              (descarteSelecionado.observacoes ? '<p><strong>Obs:</strong> ' + descarteSelecionado.observacoes + '</p>' : '');
            document.getElementById('modalDescarte').classList.remove('hidden');
          }
        })
        .listarOcorrenciasDescartePendentes();
    }

    function selecionarDecisaoDescarte(decisao, el) {
      decisaoDescarte = decisao;
      document.querySelectorAll('#modalDescarte .decisao-btn').forEach(function (b) { b.classList.remove('selected'); });
      el.classList.add('selected');
    }

    function salvarValidacaoDescarte() {
      if (!descarteSelecionado) { mostrarAlerta('Selecione uma ocorr√™ncia', 'error'); return; }
      if (!decisaoDescarte) { mostrarAlerta('Selecione uma decis√£o', 'error'); return; }
      if (!document.getElementById('parecerDescarte').value.trim()) {
        mostrarAlerta('Parecer √© obrigat√≥rio', 'error'); return;
      }

      var dados = {
        ocorrenciaId: descarteSelecionado.id,
        nutricionista: nutricionista.nome || 'Nutricionista',
        parecer: document.getElementById('parecerDescarte').value.trim(),
        acaoCorretiva: document.getElementById('acaoCorretiva').value.trim(),
        decisao: decisaoDescarte
      };

      google.script.run
        .withSuccessHandler(function (res) {
          if (res.success) {
            mostrarAlerta(res.mensagem || 'Valida√ß√£o salva!', 'success');
            fecharModal('modalDescarte');
            carregarDescartes();
            limparFormDescarte();
          } else {
            mostrarAlerta(res.error || 'Erro ao salvar', 'error');
          }
        })
        .withFailureHandler(function (e) { mostrarAlerta('Erro: ' + e.message, 'error'); })
        .validarOcorrenciaDescarte(dados);
    }

    function limparFormDescarte() {
      descarteSelecionado = null;
      decisaoDescarte = null;
      document.getElementById('parecerDescarte').value = '';
      document.getElementById('acaoCorretiva').value = '';
      document.querySelectorAll('#modalDescarte .decisao-btn').forEach(function (b) { b.classList.remove('selected'); });
    }

    // === UTILIT√ÅRIOS ===
    function fecharModal(id) {
      document.getElementById(id).classList.add('hidden');
    }

    function mostrarAlerta(msg, tipo) {
      var box = document.getElementById('alertBox');
      box.className = 'alert alert-' + tipo;
      box.textContent = msg;
      box.classList.remove('hidden');
      setTimeout(function () { box.classList.add('hidden'); }, 4000);
    }
  </script>
</body>

</html>