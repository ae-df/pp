<!--
  ========================================
  DATA TABLE COMPONENT - ALIMENTAÇÃO ESCOLAR
  Tabela responsiva que se transforma em cards em mobile
  ========================================
  
  Uso: <?!= include('UI_DataTable'); ?>
-->

<style>
/* ========================================
   DATA TABLE - DESIGN SYSTEM
   ======================================== */
.ae-datatable-container {
  background: var(--ae-bg-card, #FFFFFF);
  border-radius: var(--ae-radius-lg, 12px);
  box-shadow: var(--ae-shadow-sm, 0 1px 3px rgba(0,0,0,0.1));
  overflow: hidden;
}

/* Toolbar */
.ae-datatable-toolbar {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 12px;
  padding: 16px;
  border-bottom: 1px solid var(--ae-gray-200, #EEEEEE);
}

.ae-datatable-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--ae-text-primary, #263238);
  flex: 1;
}

.ae-datatable-search {
  position: relative;
  min-width: 200px;
}

.ae-datatable-search input {
  width: 100%;
  padding: 10px 12px 10px 40px;
  border: 1px solid var(--ae-gray-300, #E0E0E0);
  border-radius: 8px;
  font-size: 0.875rem;
  font-family: inherit;
  transition: all 0.2s;
}

.ae-datatable-search input:focus {
  outline: none;
  border-color: var(--ae-primary, #2E7D32);
  box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
}

.ae-datatable-search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--ae-text-hint, #78909C);
  font-size: 20px;
}

.ae-datatable-actions {
  display: flex;
  gap: 8px;
}

.ae-datatable-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 10px 16px;
  background: var(--ae-bg-main, #F1F8E9);
  border: none;
  border-radius: 8px;
  font-size: 0.8rem;
  font-weight: 500;
  color: var(--ae-text-primary, #263238);
  cursor: pointer;
  transition: all 0.2s;
}

.ae-datatable-btn:hover {
  background: var(--ae-gray-200, #EEEEEE);
}

.ae-datatable-btn-primary {
  background: var(--ae-primary, #2E7D32);
  color: white;
}

.ae-datatable-btn-primary:hover {
  background: var(--ae-primary-700, #388E3C);
}

/* Filtros */
.ae-datatable-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 12px 16px;
  background: var(--ae-gray-50, #FAFAFA);
  border-bottom: 1px solid var(--ae-gray-200, #EEEEEE);
}

.ae-filter-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: white;
  border: 1px solid var(--ae-gray-300, #E0E0E0);
  border-radius: 20px;
  font-size: 0.75rem;
  cursor: pointer;
  transition: all 0.2s;
}

.ae-filter-chip:hover {
  border-color: var(--ae-primary, #2E7D32);
}

.ae-filter-chip.active {
  background: var(--ae-primary, #2E7D32);
  color: white;
  border-color: var(--ae-primary, #2E7D32);
}

.ae-filter-chip .ae-chip-remove {
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.1);
  border-radius: 50%;
  font-size: 12px;
}

/* ========================================
   TABELA DESKTOP
   ======================================== */
.ae-datatable-wrapper {
  overflow-x: auto;
}

.ae-datatable {
  width: 100%;
  border-collapse: collapse;
}

.ae-datatable th,
.ae-datatable td {
  padding: 14px 16px;
  text-align: left;
  border-bottom: 1px solid var(--ae-gray-200, #EEEEEE);
}

.ae-datatable th {
  background: var(--ae-gray-50, #FAFAFA);
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--ae-text-secondary, #546E7A);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
  position: sticky;
  top: 0;
  z-index: 10;
}

.ae-datatable th.sortable {
  cursor: pointer;
  user-select: none;
}

.ae-datatable th.sortable:hover {
  background: var(--ae-gray-100, #F5F5F5);
}

.ae-datatable th .ae-sort-icon {
  margin-left: 4px;
  opacity: 0.3;
  font-size: 16px;
  vertical-align: middle;
}

.ae-datatable th.sorted-asc .ae-sort-icon,
.ae-datatable th.sorted-desc .ae-sort-icon {
  opacity: 1;
  color: var(--ae-primary, #2E7D32);
}

.ae-datatable td {
  font-size: 0.875rem;
  color: var(--ae-text-primary, #263238);
  vertical-align: middle;
}

.ae-datatable tbody tr {
  transition: background 0.15s;
}

.ae-datatable tbody tr:hover {
  background: var(--ae-primary-50, #E8F5E9);
}

.ae-datatable tbody tr.selected {
  background: var(--ae-primary-100, #C8E6C9);
}

/* Checkbox de seleção */
.ae-datatable-checkbox {
  width: 18px;
  height: 18px;
  accent-color: var(--ae-primary, #2E7D32);
  cursor: pointer;
}

/* Célula com ações */
.ae-datatable-cell-actions {
  display: flex;
  gap: 4px;
}

.ae-datatable-action-btn {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  border: none;
  border-radius: 6px;
  color: var(--ae-text-secondary, #546E7A);
  cursor: pointer;
  transition: all 0.2s;
}

.ae-datatable-action-btn:hover {
  background: var(--ae-gray-100, #F5F5F5);
  color: var(--ae-primary, #2E7D32);
}

.ae-datatable-action-btn.danger:hover {
  background: var(--ae-error-light, #FFEBEE);
  color: var(--ae-accent, #C62828);
}

/* Status badges */
.ae-status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.7rem;
  font-weight: 500;
}

.ae-status-badge::before {
  content: '';
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: currentColor;
}

.ae-status-success { background: #E8F5E9; color: #2E7D32; }
.ae-status-warning { background: #FFF8E1; color: #F9A825; }
.ae-status-error { background: #FFEBEE; color: #C62828; }
.ae-status-info { background: #E3F2FD; color: #1565C0; }
.ae-status-neutral { background: #F5F5F5; color: #757575; }

/* ========================================
   CARDS MOBILE (< 768px)
   ======================================== */
.ae-datatable-cards {
  display: none;
  padding: 12px;
  gap: 12px;
}

.ae-datatable-card {
  background: white;
  border: 1px solid var(--ae-gray-200, #EEEEEE);
  border-radius: 12px;
  padding: 16px;
  transition: all 0.2s;
}

.ae-datatable-card:hover {
  border-color: var(--ae-primary-light, #4CAF50);
  box-shadow: var(--ae-shadow-sm, 0 1px 3px rgba(0,0,0,0.1));
}

.ae-datatable-card.selected {
  border-color: var(--ae-primary, #2E7D32);
  background: var(--ae-primary-50, #E8F5E9);
}

.ae-datatable-card-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 12px;
}

.ae-datatable-card-title {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--ae-text-primary, #263238);
}

.ae-datatable-card-subtitle {
  font-size: 0.75rem;
  color: var(--ae-text-secondary, #546E7A);
  margin-top: 2px;
}

.ae-datatable-card-body {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

.ae-datatable-card-field {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.ae-datatable-card-field.full-width {
  grid-column: span 2;
}

.ae-datatable-card-label {
  font-size: 0.65rem;
  font-weight: 500;
  color: var(--ae-text-hint, #78909C);
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.ae-datatable-card-value {
  font-size: 0.85rem;
  color: var(--ae-text-primary, #263238);
}

.ae-datatable-card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 14px;
  padding-top: 12px;
  border-top: 1px solid var(--ae-gray-200, #EEEEEE);
}

.ae-datatable-card-actions {
  display: flex;
  gap: 8px;
}

.ae-card-action-btn {
  padding: 8px 14px;
  background: var(--ae-bg-main, #F1F8E9);
  border: none;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--ae-text-primary, #263238);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  transition: all 0.2s;
}

.ae-card-action-btn:hover {
  background: var(--ae-gray-200, #EEEEEE);
}

.ae-card-action-btn.primary {
  background: var(--ae-primary, #2E7D32);
  color: white;
}

/* Responsividade: Mostrar cards em mobile */
@media (max-width: 767px) {
  .ae-datatable-wrapper {
    display: none;
  }
  
  .ae-datatable-cards {
    display: flex;
    flex-direction: column;
  }
  
  .ae-datatable-toolbar {
    flex-direction: column;
    align-items: stretch;
  }
  
  .ae-datatable-search {
    width: 100%;
  }
  
  .ae-datatable-actions {
    justify-content: flex-end;
  }
}

/* ========================================
   PAGINAÇÃO
   ======================================== */
.ae-datatable-footer {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  padding: 14px 16px;
  border-top: 1px solid var(--ae-gray-200, #EEEEEE);
  background: var(--ae-gray-50, #FAFAFA);
}

.ae-datatable-info {
  font-size: 0.8rem;
  color: var(--ae-text-secondary, #546E7A);
}

.ae-datatable-pagination {
  display: flex;
  align-items: center;
  gap: 4px;
}

.ae-pagination-btn {
  min-width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: white;
  border: 1px solid var(--ae-gray-300, #E0E0E0);
  border-radius: 8px;
  font-size: 0.85rem;
  color: var(--ae-text-primary, #263238);
  cursor: pointer;
  transition: all 0.2s;
}

.ae-pagination-btn:hover:not(:disabled) {
  background: var(--ae-gray-100, #F5F5F5);
  border-color: var(--ae-primary, #2E7D32);
}

.ae-pagination-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.ae-pagination-btn.active {
  background: var(--ae-primary, #2E7D32);
  border-color: var(--ae-primary, #2E7D32);
  color: white;
}

.ae-pagination-ellipsis {
  padding: 0 8px;
  color: var(--ae-text-hint, #78909C);
}

.ae-page-size-select {
  padding: 8px 12px;
  border: 1px solid var(--ae-gray-300, #E0E0E0);
  border-radius: 8px;
  font-size: 0.8rem;
  font-family: inherit;
  background: white;
  cursor: pointer;
}

/* ========================================
   ESTADOS VAZIOS E LOADING
   ======================================== */
.ae-datatable-empty {
  padding: 60px 20px;
  text-align: center;
}

.ae-datatable-empty-icon {
  font-size: 64px;
  color: var(--ae-gray-300, #E0E0E0);
  margin-bottom: 16px;
}

.ae-datatable-empty-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--ae-text-primary, #263238);
  margin-bottom: 8px;
}

.ae-datatable-empty-desc {
  font-size: 0.875rem;
  color: var(--ae-text-secondary, #546E7A);
  max-width: 300px;
  margin: 0 auto;
}

.ae-datatable-loading {
  padding: 40px;
  text-align: center;
}

.ae-datatable-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--ae-gray-200, #EEEEEE);
  border-top-color: var(--ae-primary, #2E7D32);
  border-radius: 50%;
  animation: ae-spin 0.8s linear infinite;
  margin: 0 auto 16px;
}

@keyframes ae-spin {
  to { transform: rotate(360deg); }
}

/* Skeleton loading */
.ae-skeleton {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: ae-skeleton-loading 1.5s infinite;
  border-radius: 4px;
}

@keyframes ae-skeleton-loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.ae-skeleton-row {
  display: flex;
  gap: 16px;
  padding: 14px 16px;
  border-bottom: 1px solid var(--ae-gray-200, #EEEEEE);
}

.ae-skeleton-cell {
  height: 20px;
  flex: 1;
}

.ae-skeleton-cell.small { max-width: 80px; }
.ae-skeleton-cell.medium { max-width: 150px; }
</style>

<!-- Exemplo de estrutura HTML -->
<template id="dataTableTemplate">
  <div class="ae-datatable-container">
    <!-- Toolbar -->
    <div class="ae-datatable-toolbar">
      <h3 class="ae-datatable-title">Título da Tabela</h3>
      <div class="ae-datatable-search">
        <span class="material-symbols-outlined ae-datatable-search-icon">search</span>
        <input type="text" placeholder="Buscar..." data-search>
      </div>
      <div class="ae-datatable-actions">
        <button class="ae-datatable-btn" data-action="filter">
          <span class="material-symbols-outlined">filter_list</span>
          Filtros
        </button>
        <button class="ae-datatable-btn" data-action="export">
          <span class="material-symbols-outlined">download</span>
          Exportar
        </button>
        <button class="ae-datatable-btn ae-datatable-btn-primary" data-action="add">
          <span class="material-symbols-outlined">add</span>
          Novo
        </button>
      </div>
    </div>
    
    <!-- Filtros ativos -->
    <div class="ae-datatable-filters" data-filters style="display:none;">
      <!-- Chips de filtro dinâmicos -->
    </div>
    
    <!-- Tabela Desktop -->
    <div class="ae-datatable-wrapper">
      <table class="ae-datatable">
        <thead>
          <tr data-header></tr>
        </thead>
        <tbody data-body></tbody>
      </table>
    </div>
    
    <!-- Cards Mobile -->
    <div class="ae-datatable-cards" data-cards></div>
    
    <!-- Footer com paginação -->
    <div class="ae-datatable-footer">
      <div class="ae-datatable-info" data-info>
        Mostrando 1-10 de 100 registros
      </div>
      <div class="ae-datatable-pagination" data-pagination></div>
    </div>
  </div>
</template>

<script>
/**
 * ========================================
 * AE DATA TABLE COMPONENT
 * Tabela responsiva com ordenação, filtros e paginação
 * ========================================
 */
class AEDataTable {
  constructor(container, options = {}) {
    this.container = typeof container === 'string' 
      ? document.querySelector(container) 
      : container;
    
    this.options = {
      columns: [],
      data: [],
      pageSize: 10,
      pageSizes: [10, 25, 50, 100],
      searchable: true,
      sortable: true,
      selectable: false,
      actions: [],
      emptyMessage: 'Nenhum registro encontrado',
      cardTitleField: null,
      cardSubtitleField: null,
      onRowClick: null,
      onSelectionChange: null,
      ...options
    };
    
    this.state = {
      filteredData: [],
      currentPage: 1,
      sortColumn: null,
      sortDirection: 'asc',
      searchTerm: '',
      selectedRows: new Set(),
      filters: {}
    };
    
    this.init();
  }
  
  init() {
    this.render();
    this.bindEvents();
    this.setData(this.options.data);
  }
  
  render() {
    this.container.innerHTML = `
      <div class="ae-datatable-container">
        <div class="ae-datatable-toolbar">
          <h3 class="ae-datatable-title">${this.options.title || ''}</h3>
          ${this.options.searchable ? `
            <div class="ae-datatable-search">
              <span class="material-symbols-outlined ae-datatable-search-icon">search</span>
              <input type="text" placeholder="Buscar..." data-search>
            </div>
          ` : ''}
          <div class="ae-datatable-actions">
            ${this.options.actions.map(a => `
              <button class="ae-datatable-btn ${a.primary ? 'ae-datatable-btn-primary' : ''}" data-action="${a.id}">
                <span class="material-symbols-outlined">${a.icon}</span>
                ${a.label}
              </button>
            `).join('')}
          </div>
        </div>
        <div class="ae-datatable-filters" data-filters style="display:none;"></div>
        <div class="ae-datatable-wrapper">
          <table class="ae-datatable">
            <thead><tr data-header></tr></thead>
            <tbody data-body></tbody>
          </table>
        </div>
        <div class="ae-datatable-cards" data-cards></div>
        <div class="ae-datatable-footer">
          <div class="ae-datatable-info" data-info></div>
          <div class="ae-datatable-pagination" data-pagination></div>
        </div>
      </div>
    `;
    
    this.elements = {
      search: this.container.querySelector('[data-search]'),
      header: this.container.querySelector('[data-header]'),
      body: this.container.querySelector('[data-body]'),
      cards: this.container.querySelector('[data-cards]'),
      info: this.container.querySelector('[data-info]'),
      pagination: this.container.querySelector('[data-pagination]'),
      filters: this.container.querySelector('[data-filters]')
    };
    
    this.renderHeader();
  }

  renderHeader() {
    const { columns, selectable, sortable } = this.options;
    
    let html = '';
    if (selectable) {
      html += `<th style="width:40px"><input type="checkbox" class="ae-datatable-checkbox" data-select-all></th>`;
    }
    
    columns.forEach(col => {
      const sortClass = sortable && col.sortable !== false ? 'sortable' : '';
      const sortedClass = this.state.sortColumn === col.field 
        ? `sorted-${this.state.sortDirection}` 
        : '';
      
      html += `
        <th class="${sortClass} ${sortedClass}" data-field="${col.field}" style="${col.width ? `width:${col.width}` : ''}">
          ${col.label}
          ${sortable && col.sortable !== false ? `
            <span class="material-symbols-outlined ae-sort-icon">
              ${this.state.sortColumn === col.field 
                ? (this.state.sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward')
                : 'unfold_more'}
            </span>
          ` : ''}
        </th>
      `;
    });
    
    if (this.options.rowActions) {
      html += `<th style="width:100px">Ações</th>`;
    }
    
    this.elements.header.innerHTML = html;
  }
  
  renderBody() {
    const { columns, selectable, rowActions } = this.options;
    const { filteredData, currentPage } = this.state;
    const pageSize = this.options.pageSize;
    
    const start = (currentPage - 1) * pageSize;
    const pageData = filteredData.slice(start, start + pageSize);
    
    if (pageData.length === 0) {
      this.elements.body.innerHTML = `
        <tr>
          <td colspan="${columns.length + (selectable ? 1 : 0) + (rowActions ? 1 : 0)}">
            <div class="ae-datatable-empty">
              <div class="ae-datatable-empty-icon">
                <span class="material-symbols-outlined" style="font-size:inherit">search_off</span>
              </div>
              <div class="ae-datatable-empty-title">${this.options.emptyMessage}</div>
              <div class="ae-datatable-empty-desc">Tente ajustar os filtros ou realizar uma nova busca</div>
            </div>
          </td>
        </tr>
      `;
      this.elements.cards.innerHTML = '';
      return;
    }
    
    // Render table rows
    this.elements.body.innerHTML = pageData.map((row, idx) => {
      const rowId = row.id || start + idx;
      const isSelected = this.state.selectedRows.has(rowId);
      
      let html = `<tr data-row-id="${rowId}" class="${isSelected ? 'selected' : ''}">`;
      
      if (selectable) {
        html += `<td><input type="checkbox" class="ae-datatable-checkbox" data-select-row="${rowId}" ${isSelected ? 'checked' : ''}></td>`;
      }
      
      columns.forEach(col => {
        const value = this.getNestedValue(row, col.field);
        const rendered = col.render ? col.render(value, row) : this.escapeHtml(value);
        html += `<td>${rendered}</td>`;
      });
      
      if (rowActions) {
        html += `<td><div class="ae-datatable-cell-actions">`;
        rowActions.forEach(action => {
          html += `
            <button class="ae-datatable-action-btn ${action.danger ? 'danger' : ''}" 
                    data-row-action="${action.id}" data-row-id="${rowId}" title="${action.label}">
              <span class="material-symbols-outlined">${action.icon}</span>
            </button>
          `;
        });
        html += `</div></td>`;
      }
      
      html += '</tr>';
      return html;
    }).join('');
    
    // Render cards for mobile
    this.renderCards(pageData, start);
  }
  
  renderCards(pageData, startIndex) {
    const { columns, cardTitleField, cardSubtitleField, rowActions } = this.options;
    
    this.elements.cards.innerHTML = pageData.map((row, idx) => {
      const rowId = row.id || startIndex + idx;
      const isSelected = this.state.selectedRows.has(rowId);
      
      const titleField = cardTitleField || columns[0]?.field;
      const subtitleField = cardSubtitleField || columns[1]?.field;
      
      return `
        <div class="ae-datatable-card ${isSelected ? 'selected' : ''}" data-row-id="${rowId}">
          <div class="ae-datatable-card-header">
            <div>
              <div class="ae-datatable-card-title">${this.escapeHtml(this.getNestedValue(row, titleField))}</div>
              ${subtitleField ? `<div class="ae-datatable-card-subtitle">${this.escapeHtml(this.getNestedValue(row, subtitleField))}</div>` : ''}
            </div>
            ${columns.find(c => c.field === 'status') ? 
              columns.find(c => c.field === 'status').render(row.status, row) : ''}
          </div>
          <div class="ae-datatable-card-body">
            ${columns.slice(2).map(col => `
              <div class="ae-datatable-card-field ${col.fullWidth ? 'full-width' : ''}">
                <span class="ae-datatable-card-label">${col.label}</span>
                <span class="ae-datatable-card-value">${col.render ? col.render(this.getNestedValue(row, col.field), row) : this.escapeHtml(this.getNestedValue(row, col.field))}</span>
              </div>
            `).join('')}
          </div>
          ${rowActions ? `
            <div class="ae-datatable-card-footer">
              <div></div>
              <div class="ae-datatable-card-actions">
                ${rowActions.map(action => `
                  <button class="ae-card-action-btn ${action.primary ? 'primary' : ''}" 
                          data-row-action="${action.id}" data-row-id="${rowId}">
                    <span class="material-symbols-outlined" style="font-size:16px">${action.icon}</span>
                    ${action.label}
                  </button>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  renderPagination() {
    const { filteredData, currentPage } = this.state;
    const pageSize = this.options.pageSize;
    const totalPages = Math.ceil(filteredData.length / pageSize);
    const start = (currentPage - 1) * pageSize + 1;
    const end = Math.min(currentPage * pageSize, filteredData.length);
    
    this.elements.info.textContent = filteredData.length > 0
      ? `Mostrando ${start}-${end} de ${filteredData.length} registros`
      : 'Nenhum registro';
    
    if (totalPages <= 1) {
      this.elements.pagination.innerHTML = '';
      return;
    }
    
    let html = `
      <button class="ae-pagination-btn" data-page="prev" ${currentPage === 1 ? 'disabled' : ''}>
        <span class="material-symbols-outlined">chevron_left</span>
      </button>
    `;
    
    const pages = this.getPageNumbers(currentPage, totalPages);
    pages.forEach(page => {
      if (page === '...') {
        html += `<span class="ae-pagination-ellipsis">...</span>`;
      } else {
        html += `
          <button class="ae-pagination-btn ${page === currentPage ? 'active' : ''}" data-page="${page}">
            ${page}
          </button>
        `;
      }
    });
    
    html += `
      <button class="ae-pagination-btn" data-page="next" ${currentPage === totalPages ? 'disabled' : ''}>
        <span class="material-symbols-outlined">chevron_right</span>
      </button>
    `;
    
    this.elements.pagination.innerHTML = html;
  }
  
  getPageNumbers(current, total) {
    if (total <= 7) return Array.from({ length: total }, (_, i) => i + 1);
    
    if (current <= 3) return [1, 2, 3, 4, '...', total];
    if (current >= total - 2) return [1, '...', total - 3, total - 2, total - 1, total];
    
    return [1, '...', current - 1, current, current + 1, '...', total];
  }
  
  bindEvents() {
    // Search
    this.elements.search?.addEventListener('input', (e) => {
      this.state.searchTerm = e.target.value.toLowerCase();
      this.state.currentPage = 1;
      this.applyFilters();
    });
    
    // Sort
    this.elements.header.addEventListener('click', (e) => {
      const th = e.target.closest('th.sortable');
      if (!th) return;
      
      const field = th.dataset.field;
      if (this.state.sortColumn === field) {
        this.state.sortDirection = this.state.sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        this.state.sortColumn = field;
        this.state.sortDirection = 'asc';
      }
      
      this.renderHeader();
      this.applyFilters();
    });
    
    // Pagination
    this.elements.pagination.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-page]');
      if (!btn || btn.disabled) return;
      
      const page = btn.dataset.page;
      const totalPages = Math.ceil(this.state.filteredData.length / this.options.pageSize);
      
      if (page === 'prev') this.state.currentPage--;
      else if (page === 'next') this.state.currentPage++;
      else this.state.currentPage = parseInt(page);
      
      this.state.currentPage = Math.max(1, Math.min(this.state.currentPage, totalPages));
      this.renderBody();
      this.renderPagination();
    });
    
    // Row selection
    this.container.addEventListener('change', (e) => {
      if (e.target.matches('[data-select-all]')) {
        this.toggleSelectAll(e.target.checked);
      } else if (e.target.matches('[data-select-row]')) {
        this.toggleSelectRow(e.target.dataset.selectRow, e.target.checked);
      }
    });
    
    // Row actions
    this.container.addEventListener('click', (e) => {
      const actionBtn = e.target.closest('[data-row-action]');
      if (actionBtn) {
        const action = actionBtn.dataset.rowAction;
        const rowId = actionBtn.dataset.rowId;
        const row = this.options.data.find(r => String(r.id) === rowId);
        this.emit('rowAction', { action, row, rowId });
      }
      
      // Row click
      const tr = e.target.closest('tr[data-row-id], .ae-datatable-card[data-row-id]');
      if (tr && !e.target.closest('button, input')) {
        const rowId = tr.dataset.rowId;
        const row = this.options.data.find(r => String(r.id) === rowId);
        if (this.options.onRowClick) this.options.onRowClick(row);
        this.emit('rowClick', { row, rowId });
      }
    });
    
    // Toolbar actions
    this.container.addEventListener('click', (e) => {
      const actionBtn = e.target.closest('[data-action]');
      if (actionBtn) {
        this.emit('action', { action: actionBtn.dataset.action });
      }
    });
  }
  
  // Data methods
  setData(data) {
    this.options.data = data || [];
    this.state.selectedRows.clear();
    this.applyFilters();
  }
  
  applyFilters() {
    let data = [...this.options.data];
    
    // Search
    if (this.state.searchTerm) {
      const term = this.state.searchTerm;
      data = data.filter(row => 
        this.options.columns.some(col => {
          const value = String(this.getNestedValue(row, col.field) || '').toLowerCase();
          return value.includes(term);
        })
      );
    }
    
    // Sort
    if (this.state.sortColumn) {
      const col = this.options.columns.find(c => c.field === this.state.sortColumn);
      data.sort((a, b) => {
        let aVal = this.getNestedValue(a, this.state.sortColumn);
        let bVal = this.getNestedValue(b, this.state.sortColumn);
        
        if (col?.sortType === 'number') {
          aVal = parseFloat(aVal) || 0;
          bVal = parseFloat(bVal) || 0;
        } else if (col?.sortType === 'date') {
          aVal = new Date(aVal);
          bVal = new Date(bVal);
        } else {
          aVal = String(aVal || '').toLowerCase();
          bVal = String(bVal || '').toLowerCase();
        }
        
        if (aVal < bVal) return this.state.sortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return this.state.sortDirection === 'asc' ? 1 : -1;
        return 0;
      });
    }
    
    this.state.filteredData = data;
    this.renderBody();
    this.renderPagination();
  }
  
  // Selection methods
  toggleSelectAll(checked) {
    const pageData = this.getCurrentPageData();
    pageData.forEach(row => {
      const id = row.id;
      if (checked) this.state.selectedRows.add(id);
      else this.state.selectedRows.delete(id);
    });
    this.renderBody();
    this.emitSelectionChange();
  }
  
  toggleSelectRow(rowId, checked) {
    if (checked) this.state.selectedRows.add(rowId);
    else this.state.selectedRows.delete(rowId);
    this.renderBody();
    this.emitSelectionChange();
  }
  
  getSelectedRows() {
    return this.options.data.filter(row => this.state.selectedRows.has(String(row.id)));
  }
  
  getCurrentPageData() {
    const start = (this.state.currentPage - 1) * this.options.pageSize;
    return this.state.filteredData.slice(start, start + this.options.pageSize);
  }
  
  // Utility methods
  getNestedValue(obj, path) {
    return path.split('.').reduce((o, k) => o?.[k], obj);
  }
  
  escapeHtml(str) {
    if (str == null) return '';
    return String(str).replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
  }
  
  // Event system
  listeners = {};
  on(event, callback) { (this.listeners[event] = this.listeners[event] || []).push(callback); }
  emit(event, data) { (this.listeners[event] || []).forEach(cb => cb(data)); }
  emitSelectionChange() { this.emit('selectionChange', { selected: this.getSelectedRows() }); }
  
  // Loading state
  showLoading() {
    this.elements.body.innerHTML = Array(5).fill(`
      <tr class="ae-skeleton-row">
        ${this.options.columns.map(() => '<td><div class="ae-skeleton ae-skeleton-cell"></div></td>').join('')}
      </tr>
    `).join('');
  }
  
  refresh() { this.applyFilters(); }
}

// Expor globalmente
window.AEDataTable = AEDataTable;
</script>
